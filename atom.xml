<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Beta</title>
  
  <subtitle>It’s a beautiful thing when free data meets free algorithm.</subtitle>
  <link href="http://bjt.name/atom.xml" rel="self"/>
  
  <link href="http://bjt.name/"/>
  <updated>2025-05-04T09:24:44.160Z</updated>
  <id>http://bjt.name/</id>
  
  <author>
    <name>刘思喆</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AB 实验之方差缩减技术</title>
    <link href="http://bjt.name/2025/05/02/variance-reduction.html"/>
    <id>http://bjt.name/2025/05/02/variance-reduction.html</id>
    <published>2025-05-01T16:00:00.000Z</published>
    <updated>2025-05-04T09:24:44.160Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前序知识">1. 前序知识</h1><p>话说实施 AB实验有一个非常关键的点就是可靠的统计分析，当然这个分析会涉及非常多的统计学知识，比如：</p><ol type="1"><li><p>统计结果的理解是否正确：置信度、区间估计、显著性、Power值、MDE、样本量……</p></li><li><p>实验分析的过程是否正确：AA实验、反转实验、DID、幸存者偏差、辛普森悖论、CUPED、局部到全局……</p></li></ol><p>这些概念构成了 AB实验分析的基础框架，比如置信度和显著性帮助我们判断实验结果的可信度，而Power 值和样本量则确保实验有足够的灵敏度检测到真实的效应。</p><p>有一个名词估计大家有点眼生，那就是 CUPED，这个方法的全称是Controlled-experiment Using Pre-ExperimentData，中文翻译为：使用预实验数据进行控制的实验。CUPED 的核心目标是提升AB实验的统计显著性。其关键在于利用预实验数据调整指标，通过缩减方差来增强检测效果。</p><span id="more"></span><h1 id="基本原理">2. 基本原理</h1><p>为了验证 AB 实验是否显著，我们经常使用 t 检验，t检验的基本思想是：</p><ol type="1"><li>计算实验中两个组的均值差异；</li><li>计算均值差异的标准误差；</li><li>计算 t值；如果大于临界值，则拒绝原假设，认为实验结果显著；否则，不拒绝原假设，认为实验结果不显著。</li></ol><p>t 值的构建公式如下（以总体方差相等情况为例）：</p><p><span class="math display">\[\begin{equation}t=\frac{\bar{X}_1-\bar{X}_2}{\sqrt{s_c^2\left(\frac{1}{n_1}+\frac{1}{n_2}\right)}}\end{equation}\]</span></p><p>其中，<span class="math inline">\(\bar{X}_1\)</span> 和 <spanclass="math inline">\(\bar{X}_2\)</span> 分别为两组的样本均值，<spanclass="math inline">\(s_c^2\)</span> 是合并方差（pooledvariance），<span class="math inline">\(n_1\)</span> 和 <spanclass="math inline">\(n_2\)</span> 为样本量。</p><p>从 t 值的公式我们可以观察到，要想实验结果有显著性，有三个思路：</p><ol type="1"><li>指标的变动较大（<spanclass="math inline">\(\bar{X}_1-\bar{X}_2\)</span>），策略非常有效，然而多数情况下这种情况可遇而不可求；</li><li>增加实验的样本量（<spanclass="math inline">\(n\)</span>），可通过提高实验流量配比或者让实验持续更长时间来实现；</li><li>缩减指标的方差（<spanclass="math inline">\(s_c^2\)</span>），指标的方差越小，t 值越大；</li></ol><p>在 1、2两种方式基本不太现实的情况下，方差缩减一种技术上很值得尝试的技术策略。它的基本思想是通过某种方法，将实验中的多个样本组合成一个样本，从而减少实验结果的方差。</p><p>在一个在线广告点击率的研究为例，<spanclass="math inline">\(y\)</span>可能是用户在实验期间对新广告设计的点击行为，而 <spanclass="math inline">\(x\)</span>则可能是用户在过去一个月内的平均点击次数或者购买次数。</p><p><span class="math display">\[\hat{Y}=Y-\theta(X-E[X])\]</span></p><p>这里</p><ol type="1"><li><span class="math inline">\(Y\)</span>是原始的目标变量（实验结果）。</li><li><span class="math inline">\(X\)</span> 预实验协变量（pre-experimentdata），实验前就存在的数据。</li><li><span class="math inline">\(𝐸[𝑋]\)</span> 是协变量 <spanclass="math inline">\(X\)</span> 的期望值或均值。</li><li><span class="math inline">\(\theta\)</span>：待估计参数，表示 <spanclass="math inline">\(X\)</span> 对 <spanclass="math inline">\(Y\)</span> 的影响程度</li></ol><h1 id="推导过程">3. 推导过程</h1><p>推导过程并不复杂，有基本的概率论和高等数学知识即可完成。</p><p>我们可以找到一个协变量 <spanclass="math inline">\(X\)</span>，对于每个数对 <spanclass="math inline">\((y_i, x_i)\)</span> 都有 <spanclass="math inline">\(\hat{y_i}=y_i - \theta x_i + \thetaE(x)\)</span>，其中 <span class="math inline">\(\theta\)</span>是一个未知参数。很容易确定 <spanclass="math inline">\(\hat{y_i}\)</span> 是 <spanclass="math inline">\(y_i\)</span> 的无偏估计量，因为：</p><p><span class="math display">\[\begin{aligned}E(\hat{Y_i}) &amp;= E(Y_i - \theta X_i + \theta E(X)) \\             &amp;= E(Y_i) - \theta E(X_i) + \theta E(X) \\             &amp;= E(Y_i) - \theta (E(X_i) - E(X)) \\             &amp;= E(Y_i)\end{aligned}\]</span></p><p>计算 <span class="math inline">\(\hat{Y}_i\)</span> 的方差：</p><p><span class="math display">\[\begin{aligned}\text{Var}(\hat{Y}_i) &amp;= \text{Var}(Y_i - \theta(X_i - E[X])) \\&amp;= \text{Var}(Y_i - \theta X_i + \theta E[X]) \\&amp;= \text{Var}(Y_i - \theta X_i) \quad \text{(因为 } \theta E[X]\text{ 是常数)} \\&amp;= \text{Var}(Y_i) - 2\theta \cdot \text{Cov}(Y_i, X_i) + \theta^2\cdot \text{Var}(X_i)\end{aligned}\]</span></p><p>我们希望找到一个 <span class="math inline">\(\theta\)</span>，使得<span class="math inline">\(\text{Var}(\hat{Y}_i)\)</span>最小。对上述表达式关于 <span class="math inline">\(\theta\)</span>求导，并令导数为0，可找到最优的 <spanclass="math inline">\(\theta^*\)</span> 值：</p><p><span class="math display">\[\frac{d}{d\theta} \text{Var}(\hat{Y}_i) = -2 \cdot \text{Cov}(Y_i, X_i)+ 2\theta \cdot \text{Var}(X_i) = 0\]</span></p><p>解得：</p><p><span class="math display">\[\theta^* = \frac{\text{Cov}(Y_i, X_i)}{\text{Var}(X_i)}= \beta_{OLS}\]</span></p><p>这就是最优的 <span class="math inline">\(\theta\)</span> 值 ——<strong>最小二乘回归系数</strong>。</p><p>将 <span class="math inline">\(\theta^* =\frac{\text{Cov}(Y,X)}{\text{Var}(X)}\)</span> 代入原方差公式：</p><p><span class="math display">\[\begin{aligned}\text{Var}(\hat{Y})&amp;= \text{Var}(Y) - 2\theta \text{Cov}(Y,X) + \theta^2 \text{Var}(X)\\&amp;= \text{Var}(Y) - 2 \cdot \frac{\text{Cov}(Y,X)}{\text{Var}(X)}\cdot \text{Cov}(Y,X) + \left( \frac{\text{Cov}(Y,X)}{\text{Var}(X)}\right)^2 \cdot \text{Var}(X) \\&amp;= \text{Var}(Y) - \frac{\text{Cov}^2(Y,X)}{\text{Var}(X)}\end{aligned}\]</span></p><p>因此：</p><p><span class="math display">\[\text{Var}(\hat{Y}) = \text{Var}(Y)(1 - \rho^2) \le \text{Var}(Y)\]</span></p><p>其中 <span class="math inline">\(\rho = \text{Corr}(Y,X)\)</span>，是 <span class="math inline">\(Y\)</span> 和 <spanclass="math inline">\(X\)</span> 的相关系数。所以只要 <spanclass="math inline">\(X\)</span> 和 <spanclass="math inline">\(Y\)</span>存在非零相关性，调整后的方差就会小于原始方差。因此这个方法可以提升实验的统计功效。</p><p>注：<span class="math inline">\(X\)</span> 不能受到 treatment的影响。</p><h1 id="模拟">4. 模拟</h1><p>模拟一些数据来看下结果是否如我们所想。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置随机种子</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">N <span class="operator">&lt;-</span> 10000 <span class="comment"># 样本大小</span></span><br><span class="line">tau <span class="operator">&lt;-</span> 0.2 <span class="comment"># 真实的 treatment 影响</span></span><br><span class="line">theta_true <span class="operator">&lt;-</span> 0.6 <span class="comment"># x 和 y 之间的相关系数</span></span><br><span class="line">treatment <span class="operator">&lt;-</span> rbinom<span class="punctuation">(</span>N<span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">0.5</span><span class="punctuation">)</span> <span class="comment"># treatment</span></span><br><span class="line">x <span class="operator">&lt;-</span> rnorm<span class="punctuation">(</span>N<span class="punctuation">)</span> <span class="comment"># 实验前变量</span></span><br><span class="line">y <span class="operator">&lt;-</span> theta_true <span class="operator">*</span> x <span class="operator">+</span> treatment <span class="operator">*</span> tau <span class="operator">+</span> rnorm<span class="punctuation">(</span>N<span class="punctuation">)</span> <span class="comment"># 响应变量</span></span><br><span class="line">df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>y <span class="operator">=</span> y<span class="punctuation">,</span> t <span class="operator">=</span> treatment<span class="punctuation">,</span> x <span class="operator">=</span> x<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 \theta 使用 OLS 回归</span></span><br><span class="line">model <span class="operator">&lt;-</span> lm<span class="punctuation">(</span>y <span class="operator">~</span> x<span class="punctuation">,</span> data <span class="operator">=</span> df<span class="punctuation">)</span></span><br><span class="line">theta_hat <span class="operator">&lt;-</span> coef<span class="punctuation">(</span>model<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="comment"># 获取 x 的回归系数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 CUPED 调整</span></span><br><span class="line">df <span class="operator">&lt;-</span> df <span class="operator">|&gt;</span></span><br><span class="line">  mutate<span class="punctuation">(</span>y_adj <span class="operator">=</span> y <span class="operator">-</span> theta_hat <span class="operator">*</span> <span class="punctuation">(</span>x <span class="operator">-</span> mean<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行后续分析，如评估 treatment 效应</span></span><br><span class="line">model_adjusted <span class="operator">&lt;-</span> lm<span class="punctuation">(</span>y_adj <span class="operator">~</span> t<span class="punctuation">,</span> data <span class="operator">=</span> df<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>model_adjusted<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 观察原始的参数估计得方差变化</span></span><br><span class="line">summary<span class="punctuation">(</span>lm<span class="punctuation">(</span>y <span class="operator">~</span> t<span class="punctuation">,</span> data <span class="operator">=</span> df<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>可以观察到对 treatment 的效应估计，t 值从 8.213 提高到了10.103；同时也可以看到方差变小的现象：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">data_long <span class="operator">&lt;-</span> df <span class="operator">%&gt;%</span></span><br><span class="line">  mutate<span class="punctuation">(</span>Group <span class="operator">=</span> ifelse<span class="punctuation">(</span>t <span class="operator">==</span> <span class="number">1</span><span class="punctuation">,</span> <span class="string">&quot;Treatment&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Control&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  select<span class="punctuation">(</span>Group<span class="punctuation">,</span> y<span class="punctuation">,</span> y_adj<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  tidyr<span class="operator">::</span>gather<span class="punctuation">(</span>key <span class="operator">=</span> <span class="string">&quot;Metric&quot;</span><span class="punctuation">,</span> value <span class="operator">=</span> <span class="string">&quot;Value&quot;</span><span class="punctuation">,</span> <span class="operator">-</span>Group<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>data_long<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Group<span class="punctuation">,</span> y <span class="operator">=</span> Value<span class="punctuation">,</span> fill <span class="operator">=</span> Metric<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_boxplot<span class="punctuation">(</span>alpha <span class="operator">=</span> <span class="number">0.7</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span></span><br><span class="line">    title <span class="operator">=</span> <span class="string">&quot;CUPED 调整前后的指标分布&quot;</span><span class="punctuation">,</span></span><br><span class="line">    subtitle <span class="operator">=</span> <span class="string">&quot;调整后（Y_adj）的方差更小，更容易检测效应&quot;</span><span class="punctuation">,</span></span><br><span class="line">    y <span class="operator">=</span> <span class="string">&quot;指标值&quot;</span><span class="punctuation">,</span></span><br><span class="line">    x <span class="operator">=</span> <span class="string">&quot;实验分组&quot;</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_minimal<span class="punctuation">(</span>base_family <span class="operator">=</span> <span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="/upload/pic/cuped.svg" /></p><p>如图所示，调整后的指标（y_adj）的箱体更紧凑，说明方差明显减小。这种分布变化使得实验组和对照组的差异更容易被检测到。</p><h1 id="经验谈">5. 经验谈</h1><p>根据微软 2013 年的实验研究，协变量的选择应遵循以下原则：</p><ol type="1"><li>选择实验运行之前的指标数据最好；</li><li>时间粒度较长的历史数据（如30天）比短期数据（如7天）更稳定。</li></ol><p>实验前数据并不是 <span class="math inline">\(X\)</span>的唯一选择，只要是不会被实验干预影响的变量，都可以选择。比如用户加入实验的日期。</p><h1 id="扩展机器学习">6. 扩展机器学习</h1><p>在 CUPAC（Controlled-experiment Using Predicted Pre-ExperimentData）框架中，我们并不直接估计一个单一的 <spanclass="math inline">\(\theta\)</span>值，而是通过训练机器学习模型来预测每个个体的潜在结果（即基线表现）。这种方法与传统的CUPED 有所不同，在 CUPED 中，<span class="math inline">\(\theta\)</span>是基于协变量和目标变量之间的线性关系计算出来的。而在 CUPAC中，我们使用机器学习模型来捕捉更复杂的模式，并利用这些预测值作为调整目标变量的基础。</p><p>在CUPAC中，关键步骤是训练一个机器学习模型来预测每个个体在没有实验干预情况下的潜在结果。以下是具体步骤：</p><ol type="1"><li>使用历史数据（预实验数据）作为训练集。这些数据应该包含所有相关的特征（如用户的浏览历史、购买记录等），以及目标变量的历史表现。</li><li>选择合适的机器学习模型进行训练。可以是线性回归、随机森林、梯度提升树（GBM）、神经网络等。选择哪种模型取决于数据的特性和复杂性。</li><li>使用历史数据训练模型，以预测每个个体在没有实验干预情况下的表现。假设我们的目标是预测点击率（CTR），则训练的目标是让模型能够根据历史行为预测未来的CTR。</li><li>使用训练好的模型对实验期间的数据进行预测，得到每个个体的基线表现<span class="math inline">\(\hat{Y}_{pre}\)</span>。</li><li>利用预测的基线表现 <spanclass="math inline">\(\hat{Y}_{pre}\)</span> 来调整实际观察到的目标变量<span class="math inline">\(Y\)</span>。调整后的目标变量 <spanclass="math inline">\(\hat{Y}\)</span> 可以表示为：</li></ol><p><span class="math display">\[\hat{Y} = Y - \hat{Y}_{pre}\]</span></p><p>相比于单一的 <span class="math inline">\(\theta\)</span>值，机器学习模型能够捕捉到更复杂的非线性关系和交互作用，提供更加个性化的预测。这意味着对于每个个体，我们可以更准确地估计其基线表现，从而更精确地调整目标变量<spanclass="math inline">\(Y\)</span>，显著提升实验设计的精度和可靠性。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前序知识&quot;&gt;1. 前序知识&lt;/h1&gt;
&lt;p&gt;话说实施 AB
实验有一个非常关键的点就是可靠的统计分析，当然这个分析会涉及非常多的统计学知识，比如：&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;p&gt;统计结果的理解是否正确：置信度、区间估计、显著性、Power
值、MDE、样本量……&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;实验分析的过程是否正确：AA
实验、反转实验、DID、幸存者偏差、辛普森悖论、CUPED、局部到全局……&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这些概念构成了 AB
实验分析的基础框架，比如置信度和显著性帮助我们判断实验结果的可信度，而
Power 值和样本量则确保实验有足够的灵敏度检测到真实的效应。&lt;/p&gt;
&lt;p&gt;有一个名词估计大家有点眼生，那就是 CUPED，这个方法的全称是
Controlled-experiment Using Pre-Experiment
Data，中文翻译为：使用预实验数据进行控制的实验。CUPED 的核心目标是提升
AB
实验的统计显著性。其关键在于利用预实验数据调整指标，通过缩减方差来增强检测效果。&lt;/p&gt;</summary>
    
    
    
    <category term="因果推断" scheme="http://bjt.name/categories/%E5%9B%A0%E6%9E%9C%E6%8E%A8%E6%96%AD/"/>
    
    
  </entry>
  
  <entry>
    <title>统计之魂，人生之师 —— 祝吴喜之老师八十寿辰快乐</title>
    <link href="http://bjt.name/2024/10/27/prof-wu.html"/>
    <id>http://bjt.name/2024/10/27/prof-wu.html</id>
    <published>2024-10-26T16:00:00.000Z</published>
    <updated>2024-10-27T12:45:46.354Z</updated>
    
    <content type="html"><![CDATA[<p><稿件载于中国人民大学统计学院系刊></p><p>与吴喜之老师的师生情缘始于 2003年的非典时期，那一年深深地烙印在每一位国人心中，同样也成为了我人生旅程中至关重要的一年。那一年，吴老师在中国人民大学统计学院开创性地开设《统计计算》课程，并史无前例地在国内高校将R语言确定为统计教学的核心工具，引领我们进入一个全新的知识殿堂。一学期的相处，使我这位小镇做题家得以窥见吴老师深厚的学术造诣与超凡的人生观，高山仰止，景行景止。</p><p>吴老师的课程对我们这些本科生来说充满了新鲜感：没有中文的教材，资料全是英文文档；统计结果需要用R 语言命令行来获得，没有任何可以点选操作的图形界面；作业和演示幻灯片使用<span class="math inline">\(\LaTeX\)</span>生成，黑压压的编译过程乌央乌央地冲击你的眼球，最终生成精美的 PDF文件。这一切让我对统计计算这门课产生了浓厚的兴趣。</p><span id="more"></span><p>记得第一堂课结束，我就兴冲冲的跑去找吴老师咨询哪里能够买到 R语言的课外辅导书籍，吴老师回答非常风趣：“国内没有卖中文教材的，你可以阅读它自带的manual 即可，很简单的。”吴老师的这句话让我一度怀疑自己的智商，以至于在假期给自己制定了一个计划：人工翻译R 自带的手册《An Introduction toR》，本科班还有两位同学李舰和张薇有了同样的想法，在后续的两年时间我们三人独立的完成了这项任务。其间，我们还因术语翻译争执不休，特别是“data frame” 这个词汇，我和张薇在宿舍里争论了许久。最初我们将其译作“数据帧”，但最终决定改为 “数据框”，因为我们认为 “框”更能体现数据的密度与信息量，而 “帧” 显得过于单薄，让人忍俊不禁。</p><p>这段学术经历给我很多启示：</p><ul><li>中文教材只是学习的基本途径，<strong>原来</strong>可以通过阅读原版教材和Google 来学习新知识；</li><li>专业课《回归分析》讲授的是如何在演算纸上推算 <spanclass="math inline">\(\beta\)</span>，或者 SPSS菜单操作，<strong>原来</strong>结果还可以用函数命令来完成；</li><li>手写作业太不优雅，<strong>原来</strong>还可以用精美的 <spanclass="math inline">\(\LaTeX\)</span> 来排班样式。</li></ul><p>回忆起来虽然收获满满，但经历过程用打游戏来类比的话，相当于跳过“容易”、“普通”、“困难”模式，直接跳到了地狱模式。这个训练对我后面职业生涯影响很大：面对看似不可完成的问题，我都能以很平和心态付出正确的努力，并最终解完美决掉它们。</p><p>吴老师不仅是学术上的领航者，更是 “终身学习”理念的践行者。吴老师在讲解数学与统计的关系时提到：统计学是为了解决问题而存在的，当你遇到问题再去补充数学知识也不迟，我自己很多统计知识都是自学而来，并没有人专门教授。吴老师在75 岁时，仅用了两周时间就掌握了 Python语言，并以此激励我们：“我都能学会，你们这么年轻有什么理由不学习呢？”</p><p>“不盲从权威”是吴老师赋予我们的另一宝贵人生哲学。在课堂上，吴老师反复强调：虽然自己是统计学家，但大家也不要迷信他，什么事情都要辩证地看，在具体的问题下他也不是权威。说实话，上学的时候并未感悟其中深意。走向工作岗位以后，“大胆假设，小心求证”已成为我行事的座右铭，辩证性和批判性思维成为我精神世界的重要组成部分。都说统计学是亚哲学，感激吴老师在启蒙我们统计学思维的时候，经意和不经意地传授了这么多财富！</p><p>R所承载的自由、分享和开源精神，在我离开学校后仍持续影响着我。我有幸在“统计之都 BBS” 担任 R语言版主，不断精进浩瀚且无比有趣的统计知识，撰写了《153 分钟学会R》，翻译了《R Reference Card》、《R in anutshell》等著作。在《程序员》杂志撰文《R youready?》，呼吁更多的开发者和研究人员加入到 R 社区中来，被视为国内 R语言的一声号角，激发了众多人的热情和兴趣。令我感到无比自豪的是，我的文章和工作帮助了很多对统计有兴趣的爱好者，甚至有人因此将统计作为自己的终身职业。吴老师所倡导的思想火种，在新一代学子中薪火相传。</p><p>我时常和孩子讲起和吴老师的故事，讲述吴老师对我人生的影响，期望孩子能够明白保持好奇心，不懈求学，勇于质疑权威，乐于贡献社会，这是一份无价的财富，值得我们统计学人代代相传。</p><p>在您八十寿辰之际，谨以此文表达我对您无尽的感激之情。</p><p><img src="/upload/pic/wu05.jpg" /></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;稿件载于中国人民大学统计学院系刊&gt;&lt;/p&gt;
&lt;p&gt;与吴喜之老师的师生情缘始于 2003
年的非典时期，那一年深深地烙印在每一位国人心中，同样也成为了我人生旅程中至关重要的一年。那一年，吴老师在中国人民大学统计学院开创性地开设《统计计算》课程，并史无前例地在国内高校将
R
语言确定为统计教学的核心工具，引领我们进入一个全新的知识殿堂。一学期的相处，使我这位小镇做题家得以窥见吴老师深厚的学术造诣与超凡的人生观，高山仰止，景行景止。&lt;/p&gt;
&lt;p&gt;吴老师的课程对我们这些本科生来说充满了新鲜感：没有中文的教材，资料全是英文文档；统计结果需要用
R 语言命令行来获得，没有任何可以点选操作的图形界面；作业和演示幻灯片使用
&lt;span class=&quot;math inline&quot;&gt;&#92;(&#92;LaTeX&#92;)&lt;/span&gt;
生成，黑压压的编译过程乌央乌央地冲击你的眼球，最终生成精美的 PDF
文件。这一切让我对统计计算这门课产生了浓厚的兴趣。&lt;/p&gt;</summary>
    
    
    
    <category term="亲历" scheme="http://bjt.name/categories/%E4%BA%B2%E5%8E%86/"/>
    
    
  </entry>
  
  <entry>
    <title>合成控制法的原理和扩展实现</title>
    <link href="http://bjt.name/2024/09/01/scm.html"/>
    <id>http://bjt.name/2024/09/01/scm.html</id>
    <published>2024-08-31T16:00:00.000Z</published>
    <updated>2025-05-04T09:15:57.010Z</updated>
    
    <content type="html"><![CDATA[<h1 id="案例场景">1. 案例场景</h1><p>假设你是肯德基的门店运营负责人，某天，你们决定在某家分店（称为 A店）推出买一送一的促销活动。你想评估这项促销活动的效果，看看它是否提高了这家分店的销售额。</p><p>这个评价问题在于，你只有一家分店进行了促销活动，其他的分店都没有进行相同的促销。你无法直接比较A店的销售额和没有进行促销的分店的销售额，因为这些分店可能本身就存在很多差异，比如地理位置、人流量等因素。</p><p>但通过使用其他分店（控制组）的数据来构建一个“虚拟”的对照组，这个虚拟的对照组在没有促销的情况下表现得和A 店相似。通过比较促销之后实际的 A店和这个虚拟对照组的业绩，就可以评估促销活动的效果。</p><ul><li>收集 A 店在促销活动前后的一段时间内的销售数据。</li><li>收集其他分店在同一时间段内的销售数据。</li><li>选择一些影响销售额的关键特征，比如每天的顾客数量、人均消费额等。</li></ul><p>通过对其他分店的特征进行加权平均，构建一个“合成”分店，使其在促销活动开始之前的特征与A 店尽可能相似。例如，假设你选择了三家分店 B、C 和D，它们在促销开始前的特征分别是：</p><ul><li>B 店：顾客数量 100 人，人均消费额 20 元；</li><li>C 店：顾客数量 150 人，人均消费额 25 元；</li><li>D 店：顾客数量 200 人，人均消费额 30 元。</li></ul><p>如果你发现 A 店在促销开始前的特征是顾客数量 150 人，人均消费额 25元，那么你可以给 B、C、D 店分配权重，使得加权平均后的特征与 A店相近。比如，权重可能是 B 店 20%，C 店 60%，D 店 20%。</p><p>实际和合成控制组有这样的比较效果：</p><ul><li>促销活动前 A店销售额序列和合成组（由其他分店加权平均得到）销售额序列基本一致。</li><li>活动后，比较 A 店的实际销售额与合成控制组的预测销售额。</li><li>如果 A店的实际销售额显著高于合成控制组的预测销售额，那么可以认为促销活动是有效的。</li></ul><p>以上是一个简单的原理说明，下面从详细的数学理论做完整推导和扩展。</p><span id="more"></span><h1 id="数学原理">2. 数学原理</h1><p>以上方法被称为合成控制法（Synthetic Control Method, 简称SCM），它是一种用于评估政策干预效果的统计方法，特别适用于只有一个或少数几个单位接受了干预的情况。这种方法通过构建一个“合成控制”组来模拟未接受干预的单位，从而估计干预的效果。</p><p>假设我们有 <span class="math inline">\(J+1\)</span> 个单元，其中第 1个单元是处理单元，其余 <span class="math inline">\(J\)</span>个单元是对照单元。我们观测到每个单元在 <spanclass="math inline">\(T\)</span> 个时间段内的结果变量 <spanclass="math inline">\(Y\)</span> 和协变量 <spanclass="math inline">\(X\)</span>。</p><p>对于协变量 <spanclass="math inline">\(X_i\)</span>，我们可以定义一个权重矩阵 <spanclass="math inline">\(V\)</span> 来反映不同协变量向量的重要性。假设<span class="math inline">\(X_i\)</span> 包含了 <spanclass="math inline">\(k\)</span> 个向量。<spanclass="math inline">\(i\)</span> 是列，<spanclass="math inline">\(k\)</span> 是行，则 <spanclass="math inline">\(V\)</span> 可以是一个 <spanclass="math inline">\(k \times k\)</span>的对角矩阵，其中对角线上的元素代表每个（行）向量的相对重要性。</p><p>定义：</p><ul><li><span class="math inline">\(Y_{it}\)</span>：单元 <spanclass="math inline">\(i\)</span> 在时间 <spanclass="math inline">\(t\)</span> 的结果变量。</li><li><span class="math inline">\(X_{i}\)</span>：单元 <spanclass="math inline">\(i\)</span> 的协变量。</li><li><span class="math inline">\(V_{k \times k}\)</span>：<spanclass="math inline">\(X_{i}\)</span> 中 <spanclass="math inline">\(k\)</span> 个向量的权重。</li></ul><p>换一个经典的美国加州控烟效果的数据集来说明，<spanclass="math inline">\(X_i\)</span> 的示例数据如下：</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">Tennessee</th><th style="text-align: right;">Georgia</th><th style="text-align: right;">Texas</th><th style="text-align: right;">Utah</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">lnincome</td><td style="text-align: right;">0.157</td><td style="text-align: right;">0.157</td><td style="text-align: right;">0.162</td><td style="text-align: right;">0.165</td></tr><tr class="even"><td style="text-align: left;">beer</td><td style="text-align: right;">0.126</td><td style="text-align: right;">0.123</td><td style="text-align: right;">0.167</td><td style="text-align: right;">0.138</td></tr><tr class="odd"><td style="text-align: left;">age15to24</td><td style="text-align: right;">0.161</td><td style="text-align: right;">0.152</td><td style="text-align: right;">0.165</td><td style="text-align: right;">0.150</td></tr><tr class="even"><td style="text-align: left;">retprice</td><td style="text-align: right;">0.166</td><td style="text-align: right;">0.167</td><td style="text-align: right;">0.149</td><td style="text-align: right;">0.191</td></tr><tr class="odd"><td style="text-align: left;">cigsale1975</td><td style="text-align: right;">0.126</td><td style="text-align: right;">0.130</td><td style="text-align: right;">0.148</td><td style="text-align: right;">0.125</td></tr><tr class="even"><td style="text-align: left;">cigsale1980</td><td style="text-align: right;">0.140</td><td style="text-align: right;">0.150</td><td style="text-align: right;">0.149</td><td style="text-align: right;">0.134</td></tr><tr class="odd"><td style="text-align: left;">cigsale1988</td><td style="text-align: right;">0.155</td><td style="text-align: right;">0.168</td><td style="text-align: right;">0.131</td><td style="text-align: right;">0.145</td></tr></tbody></table><p><span class="math inline">\(X_i\)</span>的列向量则是美国各个州的表现，行向量有 7 个，分别对应的是</p><ol type="1"><li>在 1970 年至 1988年之间的平均数：收入的对数（lnicome）、消费的啤酒量（beer）、15 至 24岁的人口比例、香烟售卖均价。</li><li>以及重点关注的 1975、1980、1988 年香烟售卖量。</li></ol><p>这里需要注意的一点是，由于研究目的或者数据记录缺失等问题，<spanclass="math inline">\(X_i\)</span> 很可能不是一个面板数据。</p><p><span class="math inline">\(Y_{jt}\)</span> 表示的是各个州在 1970 至2000 年之间的每年香烟消费量，这是我们最关注部分。示例数据如下：</p><table><thead><tr class="header"><th>year</th><th style="text-align: right;">Alabama</th><th style="text-align: right;">Arkansas</th><th style="text-align: right;">Colorado</th><th style="text-align: right;">Connecticut</th><th style="text-align: right;">Delaware</th></tr></thead><tbody><tr class="odd"><td>1970</td><td style="text-align: right;">89.8</td><td style="text-align: right;">100.3</td><td style="text-align: right;">124.8</td><td style="text-align: right;">120.0</td><td style="text-align: right;">155.0</td></tr><tr class="even"><td>1971</td><td style="text-align: right;">95.4</td><td style="text-align: right;">104.1</td><td style="text-align: right;">125.5</td><td style="text-align: right;">117.6</td><td style="text-align: right;">161.1</td></tr><tr class="odd"><td>1972</td><td style="text-align: right;">101.1</td><td style="text-align: right;">103.9</td><td style="text-align: right;">134.3</td><td style="text-align: right;">110.8</td><td style="text-align: right;">156.3</td></tr><tr class="even"><td>1973</td><td style="text-align: right;">102.9</td><td style="text-align: right;">108.0</td><td style="text-align: right;">137.9</td><td style="text-align: right;">109.3</td><td style="text-align: right;">154.7</td></tr><tr class="odd"><td>1974</td><td style="text-align: right;">108.2</td><td style="text-align: right;">109.7</td><td style="text-align: right;">132.8</td><td style="text-align: right;">112.4</td><td style="text-align: right;">151.3</td></tr><tr class="even"><td>1975</td><td style="text-align: right;">111.7</td><td style="text-align: right;">114.8</td><td style="text-align: right;">131.0</td><td style="text-align: right;">110.2</td><td style="text-align: right;">147.6</td></tr><tr class="odd"><td>1976</td><td style="text-align: right;">116.2</td><td style="text-align: right;">119.1</td><td style="text-align: right;">134.2</td><td style="text-align: right;">113.4</td><td style="text-align: right;">153.0</td></tr><tr class="even"><td>...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td></tr></tbody></table><p>合成控制组的构建：</p><ul><li><p>选择一组权重 <span class="math inline">\(\mathbf{w} = (w_2, w_3,\ldots, w_{J+1})\)</span>，使得 <spanclass="math inline">\(\sum_{j=2}^{J+1} w_j = 1\)</span> 且 <spanclass="math inline">\(w_j \geq 0\)</span>。</p></li><li><p>构建合成控制组的协变量向量 <spanclass="math inline">\(\hat{X}_1\)</span>：</p><p><span class="math display">\[   \hat{X}_1 = \sum_{j=2}^{J+1} w_j X_j   \]</span></p></li><li><p>构建合成控制组的结果变量 <spanclass="math inline">\(\hat{Y}_{1t}\)</span>：</p><p><span class="math display">\[   \hat{Y}_{1t} = \sum_{j=2}^{J+1} w_j Y_{jt}   \]</span></p></li></ul><p>这时候我们拥有两个损失（在处理前的时间段 <spanclass="math inline">\(T\)</span> 内）：</p><p><span class="math display">\[LOSS^Y = \sum_{t=1}^{T} \left( Y_{1t} -\sum_{j=2}^{J+1} w_j Y_{jt} \right)^2\]</span></p><p><span class="math display">\[LOSS^X = (X_1 - \sum_{j=2}^{J+1} w_jX_j)&#39; V (X_1 - \sum_{j=2}^{J+1} w_j X_j)\]</span></p><p>如果有一个 <span class="math inline">\(\mathbf{w}\)</span> 能够使得<span class="math inline">\(LOSS^Y, LOSS^X\)</span>都能够最小化。这样我们就找到了一个合成州，它的协变量、结果变量均和处理单元表现的非常接近。那么，单元在处理后的因果效应<span class="math inline">\(\tau_{1t}\)</span>定义为处理单元和合成控制组在处理后的结果变量之差：</p><p><span class="math display">\[\tau_{1t} = Y_{1t} - \hat{Y}_{1t}\]</span></p><p>注意，这里 <span class="math inline">\(Y_i\)</span>的行向量权重被认定为1，因为它们是同样属性的内容，都是香烟的年消费量，权重相等。但 <spanclass="math inline">\(X_i\)</span>的行向量属性不同，它们有些是处理前时间内的汇总数据，有些则是具体某年的<spanclass="math inline">\(Y_i\)</span>（业务表达为起始初始值相同）。这些因素对<span class="math inline">\(Y_i\)</span> 的解释性也不同，因此权重阵<span class="math inline">\(V\)</span>被考虑了。这也合成控制法的核心思想之一。</p><p>在实际应用中，协变量 <span class="math inline">\(X_i\)</span>通常包括一些在处理前已知的、与结果变量相关的特征。通过将这些协变量纳入合成控制组的构建过程中，可以提高合成控制组的合理程度，从而更准确地估计因果效应。</p><h1 id="嵌套最优化">3. 嵌套最优化</h1><p>前文描述是一个非常粗略的解释，合成控制法的的实际优化目标是：</p><p><span class="math display">\[\min_{V} \left(Z_1 - Z_0W^{(V)}\right)^{T} \left(Z_1 - Z_0 W^{(V)}\right)\]</span></p><ul><li><span class="math inline">\(V\)</span> 是 <spanclass="math inline">\(k\)</span> 个协变量向量的权重。</li><li><span class="math inline">\(W^{(V)}\)</span> 是合成控制组（<spanclass="math inline">\(J\)</span> 个对照单元）的权重向量，基于 <spanclass="math inline">\(X_1\)</span> 和 <spanclass="math inline">\(X_0\)</span> 求解。<spanclass="math inline">\(X_1\)</span> 和 <spanclass="math inline">\(X_0\)</span> 分别是，处理组协变量和 <spanclass="math inline">\(J\)</span> 个对照组协变量。</li><li><span class="math inline">\(Z_1\)</span> 和 <spanclass="math inline">\(Z_0\)</span> 分别是，在处理时间段 <spanclass="math inline">\(T\)</span> 内，处理组结果变量和 <spanclass="math inline">\(J\)</span> 个对照组结果变量。</li></ul><p><span class="math inline">\(V\)</span> 和 <spanclass="math inline">\(W\)</span> 是需要优化两个参数。</p><blockquote><p>请注意，合成控制法是本质是用 <span class="math inline">\(V\)</span>找合成结果变量，最小化 <spanclass="math inline">\(LOSS^{Y}\)</span>。<spanclass="math inline">\(W\)</span> 只是顺道求解出来的中间结果，<spanclass="math inline">\(W\)</span> 并不被直接求解。</p></blockquote><p>这问题的解法稍有一点绕，涉及到嵌套最优化：我们需要先优化一个目标函数，然后将优化结果用于另一个目标函数的优化。具体来说，可以分解为以下两个步骤：</p><ol type="1"><li>优化 <span class="math inline">\(W\)</span> 使得 <spanclass="math inline">\(\left|X_1 - X_0 W\right|_V\)</span> 最小化。</li><li>使用前一步得到的 <span class="math inline">\(W\)</span> 来优化 <spanclass="math inline">\(V\)</span> 使得 <spanclass="math inline">\(\left(Z_1 - Z_0 W^{(V)}\right)^{T} \left(Z_1 - Z_0W^{(V)}\right)\)</span> 最小化。</li></ol><h2 id="第一步优化-w">3.1. 第一步：优化 <spanclass="math inline">\(W\)</span></h2><p>首先，我们需要最小化 <span class="math inline">\(\left|X_1 - X_0W\right|_V\)</span>，即：</p><p><span class="math display">\[\left|X_1 - X_0 W\right|_V^2 = \left(X_1- X_0 W\right)^{T} V \left(X_1 - X_0 W\right)\]</span></p><p>可以通过求解以下方程来找到 <spanclass="math inline">\(W\)</span>：</p><p><span class="math display">\[\min_W \left(X_1 - X_0 W\right)^{T} V\left(X_1 - X_0 W\right) = \min_W (X_1^T V X_1 - 2 X_1^T V X_0 W + W^TX_0^T V X_0 W)\]</span></p><p>设 <span class="math inline">\(A = X_0^{T} V X_0\)</span> 和 <spanclass="math inline">\(B = X_0^{T} V X_1\)</span>，则问题变为：</p><p><span class="math display">\[\min_W (X_1^{T} V X_1 - 2 B^{T} W +W^{T} A W)\]</span></p><p>对 <span class="math inline">\(W\)</span> 求导并令其等于零。</p><p>由于 <span class="math inline">\(X_1^{T} V X_1\)</span> 不依赖于<span class="math inline">\(W\)</span>，因此求导过程等价于：</p><p><span class="math display">\[\frac{\partial}{\partial W} (-2 B^{T} W + W^{T} A W) = -2 B + 2 A W = 0\]</span></p><p>得到：</p><p><span class="math display">\[2 A W - 2 B = 0\]</span> <spanclass="math display">\[A W = B\]</span> <span class="math display">\[W =A^{-1} B\]</span></p><p>但这个方法有个弊端，一旦 <span class="math inline">\(A\)</span>是奇异矩阵（singular matrix），则 <spanclass="math inline">\(A^{-1}\)</span>无解。所以需要转化一下思路。同上文描述，由于<span class="math inline">\(X_1^T V X_1\)</span> 不依赖于 <spanclass="math inline">\(W\)</span>，因此</p><p><span class="math display">\[\min_W \left(X_1 - X_0 W\right)^{T} V\left(X_1 - X_0 W\right)\]</span></p><p>等价于</p><p><span class="math display">\[\min_W (W^T X_0^T V X_0 W - 2 X_1^T VX_0 W)\]</span></p><p>假如我们设:</p><ul><li><span class="math inline">\(H = X_0^T V X_0\)</span></li><li><span class="math inline">\(c = -2 X_1^T V X_0\)</span></li></ul><p>是一个二次规划问题:</p><p><span class="math display">\[w^T H w + c^T w\]</span></p><p>同时考虑到 <span class="math inline">\(w\)</span> 限制条件，即</p><p><span class="math display">\[\begin{align*}&amp; \text{minimize} &amp;&amp; \mathbf{w}^T H \mathbf{w} + c^T\mathbf{w} \\&amp; \text{subject to} &amp;&amp; \mathbf{w} \geq 0 \\&amp; &amp;&amp; \sum_{j=2}^{J+1} w_j = 1\end{align*}\]</span></p><p><span class="math inline">\(X_0\)</span> 和 <spanclass="math inline">\(X_1\)</span> 是常数阵，任意给定 <spanclass="math inline">\(V\)</span>，都可以求得符合条件的 <spanclass="math inline">\(W\)</span>，使得 <spanclass="math inline">\(\left|X_1 - X_0 W\right|_V^2\)</span> 最小。</p><h2 id="第二步优化-v">3.2. 第二步：优化 <spanclass="math inline">\(V\)</span></h2><p>使用第一步中优化得到的 <spanclass="math inline">\(W\)</span>，接着最小化：</p><p><span class="math display">\[\left(Z_1 - Z_0 W^{(V)}\right)^{T}\left(Z_1 - Z_0 W^{(V)}\right)\]</span></p><p>想象一下，<span class="math inline">\(W^{(V)}\)</span> 是 <spanclass="math inline">\(V\)</span> 的函数，任意个 <spanclass="math inline">\(V\)</span> 就可以得到 <spanclass="math inline">\(W\)</span>，并计算出上式的 loss，所以这是一个关于<span class="math inline">\(V\)</span> 的优化问题（嵌套了一层 <spanclass="math inline">\(W\)</span>）。我们需要找到 <spanclass="math inline">\(V\)</span> 使得上述表达式最小化。</p><p>到这一步就容易了，可以借助通用梯度下降法来求解。合成控制法的这两个步骤很巧妙，通过嵌套的方式同时保证了<span class="math inline">\(Loss^Y, Loss^X\)</span> 均为最小。</p><p>当然，将最优的 <span class="math inline">\(V\)</span>求解出来后，还需要重新执行一遍第一步，以获得最优 <spanclass="math inline">\(W\)</span>。</p><h2 id="系数和模型表现">3.3. 系数和模型表现</h2><p>使用前述方式计算各个参数，<span class="math inline">\(V\)</span>的结果为：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      v.names    v</span><br><span class="line"><span class="number">1</span>    lnincome <span class="number">0.15</span></span><br><span class="line"><span class="number">2</span>        beer <span class="number">0.17</span></span><br><span class="line"><span class="number">3</span>   age15to24 <span class="number">0.07</span></span><br><span class="line"><span class="number">4</span>    retprice <span class="number">0.01</span></span><br><span class="line"><span class="number">5</span> cigsale1975 <span class="number">0.39</span></span><br><span class="line"><span class="number">6</span> cigsale1980 <span class="number">0.14</span></span><br><span class="line"><span class="number">7</span> cigsale1988 <span class="number">0.08</span></span><br></pre></td></tr></table></figure><p><span class="math inline">\(W\)</span> 的结果为：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">      state_name    w</span><br><span class="line"><span class="number">1</span>       Colorado <span class="number">0.02</span></span><br><span class="line"><span class="number">2</span>    Connecticut <span class="number">0.01</span></span><br><span class="line"><span class="number">3</span>          Idaho <span class="number">0.07</span></span><br><span class="line"><span class="number">4</span>       Illinois <span class="number">0.01</span></span><br><span class="line"><span class="number">5</span>           Iowa <span class="number">0.01</span></span><br><span class="line"><span class="number">6</span>         Kansas <span class="number">0.01</span></span><br><span class="line"><span class="number">7</span>      Minnesota <span class="number">0.01</span></span><br><span class="line"><span class="number">8</span>        Montana <span class="number">0.29</span></span><br><span class="line"><span class="number">9</span>       Nebraska <span class="number">0.01</span></span><br><span class="line"><span class="number">10</span>        Nevada <span class="number">0.18</span></span><br><span class="line"><span class="number">11</span> New Hampshire <span class="number">0.01</span></span><br><span class="line"><span class="number">12</span>  North Dakota <span class="number">0.01</span></span><br><span class="line"><span class="number">13</span>  South Dakota <span class="number">0.01</span></span><br><span class="line"><span class="number">14</span>         Texas <span class="number">0.01</span></span><br><span class="line"><span class="number">15</span>          Utah <span class="number">0.29</span></span><br><span class="line"><span class="number">16</span>     Wisconsin <span class="number">0.01</span></span><br><span class="line"><span class="number">17</span>       Wyoming <span class="number">0.01</span></span><br></pre></td></tr></table></figure><p>合成的 <span class="math inline">\(\hat{Y}_{1t}\)</span> 同原始 <spanclass="math inline">\(Y_{1t}\)</span> 的对比曲线如下图所示：</p><p><img src="/upload/pic/scm1.png" /></p><h1 id="重定义损失函数">4. 重定义损失函数</h1><p>合成控制法通过嵌套最优化的方法，得到两个参数 <spanclass="math inline">\(W, V\)</span>的最优值。但实际上，大家仔细想想：难道我们不清楚协变量中各个向量的重要性吗？用模型算一个最优的<span class="math inline">\(V\)</span>你敢直接用吗？业务解释性如何？</p><p>我们可否用一个更加通用的损失函数，能够同时考虑结果变量和协变量？答案显然是可以的！一旦通过某种手段求解了<span class="math inline">\(V\)</span>，简单的将 <spanclass="math inline">\(LOSS^X\)</span> 和 <spanclass="math inline">\(LOSS^Y\)</span>加起来就是解法之一。下面我们看看这个方法的可行性和效果。</p><p>首先是协变量的权重 <span class="math inline">\(V\)</span>的求解，有几种思路可供参考：</p><ol type="1"><li>基于先验业务，为每个协变量赋予一个权重，比如 AHP 专家评分法。</li><li>如果 <span class="math inline">\(X_i\)</span> 同 <spanclass="math inline">\(Y_i\)</span>一样是面板数据，那么基于机器学习算法，估计 <spanclass="math inline">\(X_i\)</span> 各个向量的对 <spanclass="math inline">\(Y_i\)</span>的影响，影响权重即为协变量的重要性。</li></ol><h2 id="机器学习估计-v">4.1. 机器学习估计 <spanclass="math inline">\(V\)</span></h2><p>从数据出发，什么因素会影响到各州的香烟消费量？<spanclass="math inline">\(X_i\)</span> 中 4个要素：收入的对数（lnicome）、消费的啤酒量（beer）、15 至 24岁的人口比例（age15to24）、香烟售卖均价（retprice）。当然，各州的本身，它们也是影响香烟消费量的关键因素。</p><p>数据可以构建这样（各州本身被转换为了 0,1 特征）：</p><table><colgroup><col style="width: 4%" /><col style="width: 8%" /><col style="width: 10%" /><col style="width: 7%" /><col style="width: 11%" /><col style="width: 10%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 10%" /><col style="width: 12%" /><col style="width: 6%" /></colgroup><thead><tr class="header"><th style="text-align: center;">id</th><th style="text-align: center;">cigsale</th><th style="text-align: center;">lnincome</th><th style="text-align: center;">beer</th><th style="text-align: center;">age15to24</th><th style="text-align: center;">retprice</th><th style="text-align: center;">Alabama</th><th style="text-align: center;">Georgia</th><th style="text-align: center;">Kentucky</th><th style="text-align: center;">New Mexico</th><th style="text-align: center;">Texas</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">149</td><td style="text-align: center;">122.8</td><td style="text-align: center;">9.769</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.162</td><td style="text-align: center;">51.5</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr class="even"><td style="text-align: center;">756</td><td style="text-align: center;">107.0</td><td style="text-align: center;">9.894</td><td style="text-align: center;">32.100</td><td style="text-align: center;">0.169</td><td style="text-align: center;">106.8</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr class="odd"><td style="text-align: center;">684</td><td style="text-align: center;">146.8</td><td style="text-align: center;">9.699</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.185</td><td style="text-align: center;">39.8</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr><tr class="even"><td style="text-align: center;">3</td><td style="text-align: center;">101.1</td><td style="text-align: center;">9.498</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.181</td><td style="text-align: center;">42.3</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr class="odd"><td style="text-align: center;">134</td><td style="text-align: center;">128.6</td><td style="text-align: center;">9.756</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.181</td><td style="text-align: center;">78.9</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr class="even"><td style="text-align: center;">130</td><td style="text-align: center;">131.0</td><td style="text-align: center;">9.729</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.191</td><td style="text-align: center;">56.6</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr class="odd"><td style="text-align: center;">673</td><td style="text-align: center;">73.6</td><td style="text-align: center;">9.628</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.195</td><td style="text-align: center;">68.1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td></tr><tr class="even"><td style="text-align: center;">583</td><td style="text-align: center;">118.7</td><td style="text-align: center;">9.509</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.201</td><td style="text-align: center;">34.1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr class="odd"><td style="text-align: center;">246</td><td style="text-align: center;">223.0</td><td style="text-align: center;">9.579</td><td style="text-align: center;">23.629</td><td style="text-align: center;">0.186</td><td style="text-align: center;">33.3</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr></tbody></table><p>各位看官看到这里，应该有感觉了，有太多机器学习方法可以获得每个特征的重要性。比如通过随机森林找到各个特征的重要程度，去除州的影响之后，测算得到<span class="math inline">\(V\)</span> 为：</p><table><thead><tr class="header"><th style="text-align: center;">lnincome</th><th style="text-align: center;">beer</th><th style="text-align: center;">age15to24</th><th style="text-align: center;">retprice</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0.17</td><td style="text-align: center;">0.16</td><td style="text-align: center;">0.31</td><td style="text-align: center;">0.36</td></tr></tbody></table><p>这个权重同我们的常识相对一致：刨除州本身的影响后，最大影响因素依次是香烟价格、15-24岁人口、收入的对数、啤酒销量。需要注意的是，这种求解方法只适应于协变量<span class="math inline">\(X_i\)</span> 是面板数据，像原始论文那样，把1975、1980、1988 年的香烟销售量同样作为协变量，这个方法不适用。</p><h2 id="合并损失函数">4.2. 合并损失函数</h2><p>只要 <span class="math inline">\(V\)</span>就绪，就可以优化以下损失函数以求解 <spanclass="math inline">\(w\)</span>。这个损失函数由 <spanclass="math inline">\(LOSS^X\)</span> 和 <spanclass="math inline">\(LOSS^Y\)</span> 合并而得。</p><p><span class="math display">\[\min_{\mathbf{w}} \left( \lambda (Z_1 - Z_0 W)^{T}(Z_1 - Z_0 W) + (X_1 -X_0 W\right)^{T} V \left(X_1 - X_0 W) \right)\]</span></p><p>其中，<span class="math inline">\(\lambda\)</span>是一个权重，用于平衡结果变量和协变量的拟合程度。是更倾向于结果变量一致，还是协变量。</p><p>注意：为了保证 <span class="math inline">\(\lambda\)</span>权重有效，结果变量和协变量需要归一化，比如这里利用的是“单位向量归一化”方法：</p><p><span class="math display">\[\text{normalized}(x_i) = \frac{x_i}{\sqrt{\sum_{j=1}^{n} x_j^2}}\]</span></p><h2 id="系数和模型表现-1">4.3. 系数和模型表现</h2><p><span class="math inline">\(\lambda = 1\)</span>时，结果变量和协变量拟合程度的权重相等。</p><p>在 <span class="math inline">\(V\)</span>的权重控制下，后两项的相似程度更接近，对业务解释显然更加友好。</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">syth_data</th><th style="text-align: right;">X1_meta</th><th style="text-align: right;">diff(%)</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">lnincome</td><td style="text-align: right;">9.818</td><td style="text-align: right;">10.032</td><td style="text-align: right;">0.021</td></tr><tr class="even"><td style="text-align: left;">beer</td><td style="text-align: right;">23.735</td><td style="text-align: right;">24.280</td><td style="text-align: right;">0.022</td></tr><tr class="odd"><td style="text-align: left;">age15to24</td><td style="text-align: right;">0.180</td><td style="text-align: right;">0.179</td><td style="text-align: right;">0.010</td></tr><tr class="even"><td style="text-align: left;">retprice</td><td style="text-align: right;">65.889</td><td style="text-align: right;">66.637</td><td style="text-align: right;">0.011</td></tr></tbody></table><p>而且 <span class="math inline">\(W\)</span> 的不为 0的数量居然还更少（合成州数量少）！</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">           name    w</span><br><span class="line"><span class="number">1</span>      Colorado <span class="number">0.03</span></span><br><span class="line"><span class="number">2</span>   Connecticut <span class="number">0.10</span></span><br><span class="line"><span class="number">3</span>       Montana <span class="number">0.24</span></span><br><span class="line"><span class="number">4</span>        Nevada <span class="number">0.21</span></span><br><span class="line"><span class="number">5</span> New Hampshire <span class="number">0.04</span></span><br><span class="line"><span class="number">6</span>          Utah <span class="number">0.38</span></span><br></pre></td></tr></table></figure><p>合成的 <span class="math inline">\(\hat{Y}_{1t}\)</span> 同原始 <spanclass="math inline">\(Y_{1t}\)</span> 的对比曲线如下图所示：</p><p><img src="/upload/pic/scm2.png" /></p><p><span class="math inline">\(\lambda = 0.01\)</span>时，这个结果更倾向于协变量的拟合，可以看到：合成的协变量向量，除lnincome 外，几乎完全一致。</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">syth_data</th><th style="text-align: right;">X1_meta</th><th style="text-align: right;">diff(%)</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">lnincome</td><td style="text-align: right;">9.839</td><td style="text-align: right;">10.032</td><td style="text-align: right;">0.019</td></tr><tr class="even"><td style="text-align: left;">beer</td><td style="text-align: right;">24.312</td><td style="text-align: right;">24.280</td><td style="text-align: right;">0.001</td></tr><tr class="odd"><td style="text-align: left;">age15to24</td><td style="text-align: right;">0.179</td><td style="text-align: right;">0.179</td><td style="text-align: right;">0.002</td></tr><tr class="even"><td style="text-align: left;">retprice</td><td style="text-align: right;">66.634</td><td style="text-align: right;">66.637</td><td style="text-align: right;">0.000</td></tr></tbody></table><p>合成的 <span class="math inline">\(\hat{Y}_{1t}\)</span> 同原始 <spanclass="math inline">\(Y_{1t}\)</span> 的对比曲线如下图所示：</p><p><img src="/upload/pic/scm3.png" /></p><p>从结果变量的拟合结果上看，两者有细微的差别。因为权重低，整体表现要比<span class="math inline">\(\lambda=1\)</span> 时要差一些。</p><h1 id="同时做变量选择">5. 同时做变量选择</h1><p>设想以下需求场景：</p><ul><li>假如观测的段 <span class="math inline">\(T\)</span> 为20，但是对照单元 <span class="math inline">\(J\)</span> 为1000，那么合成控制组的构建会变得非常困难。在这种情况下，我们需要尽可能压缩权重向量<span class="math inline">\(w\)</span>，以简化合成控制组的构建。</li><li>前文提到的方法是最小化 <span class="math inline">\(Z_1 - Z_0W\)</span> 的平方误差，但如果模型过拟合怎么办？泛化能力过弱怎么办？</li></ul><p>当然，这个想法是有代价的，不可能既要又要还要。这时需要酌情放宽 <spanclass="math inline">\(w\)</span> 的限制条件，不再要求 <spanclass="math inline">\(\sum_{j=2}^{J+1} w_j = 1\)</span> 且 <spanclass="math inline">\(w_j \geq 0\)</span> 这两个条件。</p><h2 id="具体实现过程">5.1. 具体实现过程</h2><p>在合成控制法中，我们更关注的是结果变量 <spanclass="math inline">\(Y\)</span> 的拟合，而协变量 <spanclass="math inline">\(X\)</span> 主要用于辅助构建合成控制组。通过权重<span class="math inline">\(\lambda, V\)</span> 将 <spanclass="math inline">\(Y\)</span> 和 <spanclass="math inline">\(X\)</span>合并成为一个统一的响应变量，并使用权重向量 <spanclass="math inline">\(\mathbf{w}\)</span> 来构建合成控制组。</p><p>假设我们有 <span class="math inline">\(J+1\)</span> 个单元，其中第 1个单元是处理单元，其余 <span class="math inline">\(J\)</span>个单元是对照单元。我们观测到每个单元在 <spanclass="math inline">\(T\)</span> 个时间段内的结果变量 <spanclass="math inline">\(Y\)</span> 和协变量 <spanclass="math inline">\(X\)</span>。</p><p>定义：</p><ul><li><span class="math inline">\(Y_{it}\)</span>：单元 <spanclass="math inline">\(i\)</span> 在时间 <spanclass="math inline">\(t\)</span> 的结果变量。</li><li><span class="math inline">\(X_{i}\)</span>：单元 <spanclass="math inline">\(i\)</span> 的协变量向量。</li><li><span class="math inline">\(\lambda\)</span>正则化参数，用于平衡结果变量和协变量的拟合程度。</li><li><span class="math inline">\(V\)</span>协变量的权重矩阵，用于调整协变量的重要性。</li></ul><p>可以将 <span class="math inline">\(Y\)</span> 和 <spanclass="math inline">\(X\)</span> 视为一个扩展的响应变量向量 <spanclass="math inline">\(\mathbf{z}_{it}\)</span>，其中 <spanclass="math inline">\(\mathbf{z}_{it}\)</span> 包含 <spanclass="math inline">\(Y_{it}\)</span> 和 <spanclass="math inline">\(X_{i}\)</span>，表示为：</p><p><span class="math display">\[\mathbf{z}_{it} = \begin{bmatrix}Y_{it} \\\lambda X_{i} V\end{bmatrix}\]</span></p><p>然后，我们可以定义一个新的目标函数，将 <spanclass="math inline">\(Y\)</span> 和 <spanclass="math inline">\(X\)</span> 合并在一起：</p><p><span class="math display">\[\min_{\mathbf{w}} \left( \frac{1}{T} \sum_{t=1}^{T} \left(\mathbf{z}_{1t} - \sum_{j=2}^{J+1} w_j \mathbf{z}_{jt} \right)^2 +\alpha \sum_{j=2}^{J+1} |w_j| \right)\]</span></p><p>其中，<span class="math inline">\(\mathbf{z}_{1t}\)</span>是处理单元在时间 <span class="math inline">\(t\)</span>的扩展响应变量，<span class="math inline">\(\mathbf{z}_{jt}\)</span>是对照单元 <span class="math inline">\(j\)</span> 在时间 <spanclass="math inline">\(t\)</span> 的扩展响应变量。</p><p>这个目标函数包含两个部分：</p><ol type="1"><li>扩展响应变量的平方误差项。</li><li>L1 正则化项。</li></ol><p>这种方式将 <span class="math inline">\(Y\)</span> 和 <spanclass="math inline">\(X\)</span> 合并在一起，并使用类似 LASSO的方法来求解权重 <spanclass="math inline">\(\mathbf{w}\)</span>。在这个框架下，我们就可以采用交叉验证的方法来选择MSE效果最好的参数来构建模型，也可以更灵活地处理结果变量和协变量的关系，同时进行变量选择和系数收缩。</p><h2 id="转化为弹性网络问题">5.2. 转化为弹性网络问题</h2><p>也可以将它改写成 Elastic Net 模型形式：</p><p><span class="math display">\[\min_{\mathbf{w}} \left\{ \frac{1}{T} \sum_{t=1}^{T} \left(\mathbf{z}_{1t} - \sum_{j=2}^{J+1} w_j \mathbf{z}_{jt} \right)^2 +\lambda \left( (1-\alpha)\frac{1}{2}\sum_{j=2}^{J+1}w_j^2 + \alpha\sum_{j=2}^{J+1}|w_{j}| \right) \right\}\]</span></p><p>其中的超参数 <span class="math inline">\(\alpha\)</span> 和 <spanclass="math inline">\(\lambda\)</span>通过交叉验证的机器学习框架，求解泛化能力最好，且能让 loss 最小的 <spanclass="math inline">\(w\)</span>。</p><h2 id="系数和模型结果">5.3. 系数和模型结果</h2><p>需要注意的是，这种方法很灵活，不需要协变量为面板数据。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">            X_synth    X1</span><br><span class="line">lnincome      <span class="number">0.131</span> <span class="number">0.164</span></span><br><span class="line">beer          <span class="number">0.145</span> <span class="number">0.161</span></span><br><span class="line">age15to24     <span class="number">0.128</span> <span class="number">0.160</span></span><br><span class="line">retprice      <span class="number">0.130</span> <span class="number">0.165</span></span><br><span class="line">cigsale1975   <span class="number">0.141</span> <span class="number">0.144</span></span><br><span class="line">cigsale1980   <span class="number">0.135</span> <span class="number">0.137</span></span><br><span class="line">cigsale1988   <span class="number">0.127</span> <span class="number">0.125</span></span><br></pre></td></tr></table></figure><p>合成的 <span class="math inline">\(\hat{Y}_{1t}\)</span> 同原始 <spanclass="math inline">\(Y_{1t}\)</span> 的对比曲线如下图所示：</p><p><img src="/upload/pic/scm4.png" /></p><p>虽然从拟合曲线上比前面的两种方法表现都要差，但我个人还是更加认可这个方法，毕竟通过交叉验证的参数，泛化性更好，结果更加稳健。</p><p>当然如果你只关注结果变量 <span class="math inline">\(Y_i\)</span>的拟合程度，而不想考虑协变量 <span class="math inline">\(X_i\)</span>的影响。恭喜你，你发现了一种新的方法——<ahref="https://bjt.name/2023/05/20/synthetic-did.html">SDID</a>。</p><h1 id="总结">6. 总结</h1><p>本文注意力主要集中在如何更便捷的求解合成控制法中的参数，并没有更多的讨论安慰剂检验等其他细节。合成控制法是一个非常好的，用于估计政策或活动影响变化的框架。算法细节上使用嵌套优化的方法，非常优雅。但它也有一定局限性，有改进的可能：</p><ol type="1"><li>使用嵌套完全最优化的方法可能会出现过拟合的情况，模型存在稳定性问题，不利于估计因果效用。</li><li>合并损失的方式是可行方法之一，可以控制输出变量和协变量的权重。但需要留意，<spanclass="math inline">\(X\)</span> 和 <spanclass="math inline">\(Y\)</span> 都要做归一化处理。</li><li>引入全新的损失函数，增加正则项，借助通用机器学习框架，可以解决权重<span class="math inline">\(w\)</span>维度过高，以及提升模型的稳健性。</li></ol><p>注：三个方法实现的 R 代码 1000 多行，太长，先不贴到原文了。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;案例场景&quot;&gt;1. 案例场景&lt;/h1&gt;
&lt;p&gt;假设你是肯德基的门店运营负责人，某天，你们决定在某家分店（称为 A
店）推出买一送一的促销活动。你想评估这项促销活动的效果，看看它是否提高了这家分店的销售额。&lt;/p&gt;
&lt;p&gt;这个评价问题在于，你只有一家分店进行了促销活动，其他的分店都没有进行相同的促销。你无法直接比较
A
店的销售额和没有进行促销的分店的销售额，因为这些分店可能本身就存在很多差异，比如地理位置、人流量等因素。&lt;/p&gt;
&lt;p&gt;但通过使用其他分店（控制组）的数据来构建一个“虚拟”的对照组，这个虚拟的对照组在没有促销的情况下表现得和
A 店相似。通过比较促销之后实际的 A
店和这个虚拟对照组的业绩，就可以评估促销活动的效果。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;收集 A 店在促销活动前后的一段时间内的销售数据。&lt;/li&gt;
&lt;li&gt;收集其他分店在同一时间段内的销售数据。&lt;/li&gt;
&lt;li&gt;选择一些影响销售额的关键特征，比如每天的顾客数量、人均消费额等。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过对其他分店的特征进行加权平均，构建一个“合成”分店，使其在促销活动开始之前的特征与
A 店尽可能相似。例如，假设你选择了三家分店 B、C 和
D，它们在促销开始前的特征分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;B 店：顾客数量 100 人，人均消费额 20 元；&lt;/li&gt;
&lt;li&gt;C 店：顾客数量 150 人，人均消费额 25 元；&lt;/li&gt;
&lt;li&gt;D 店：顾客数量 200 人，人均消费额 30 元。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果你发现 A 店在促销开始前的特征是顾客数量 150 人，人均消费额 25
元，那么你可以给 B、C、D 店分配权重，使得加权平均后的特征与 A
店相近。比如，权重可能是 B 店 20%，C 店 60%，D 店 20%。&lt;/p&gt;
&lt;p&gt;实际和合成控制组有这样的比较效果：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;促销活动前 A
店销售额序列和合成组（由其他分店加权平均得到）销售额序列基本一致。&lt;/li&gt;
&lt;li&gt;活动后，比较 A 店的实际销售额与合成控制组的预测销售额。&lt;/li&gt;
&lt;li&gt;如果 A
店的实际销售额显著高于合成控制组的预测销售额，那么可以认为促销活动是有效的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上是一个简单的原理说明，下面从详细的数学理论做完整推导和扩展。&lt;/p&gt;</summary>
    
    
    
    <category term="因果推断" scheme="http://bjt.name/categories/%E5%9B%A0%E6%9E%9C%E6%8E%A8%E6%96%AD/"/>
    
    
  </entry>
  
  <entry>
    <title>90 行代码实现问答型商品推荐系统</title>
    <link href="http://bjt.name/2024/01/13/local-gpt.html"/>
    <id>http://bjt.name/2024/01/13/local-gpt.html</id>
    <published>2024-01-12T16:00:00.000Z</published>
    <updated>2024-01-14T11:15:00.175Z</updated>
    
    <content type="html"><![CDATA[<p>本文可以帮助大家理解 ChatGPT这类的大语言模型是如何在我们的日常生活中发挥作用。</p><h1 id="解决的是什么问题">1. 解决的是什么问题？</h1><p>假如你叫刘弱(强)西(东)，现在经营一家售卖食品的电商平台 Bmazon，拥有70000件各类食品（包括零食、糕点、巧克力、糖果、猫粮、狗粮……）。这些商品对应有自己的描述和顾客购买使用后的评价。如果有一个机器人，它能通过和客户对话，总结顾客的潜在购买意图，给出推荐商品。这样聪明的机器人能不能来一个呢？</p><p>先随便来一个用户购买咨询：</p><blockquote><p>有什么好吃的坚果推荐购买吗？</p></blockquote><p>先别看答案，闭上眼睛暂停十秒钟！如果你是客服导购，你会怎么回答？</p><p>....</p><p>这个机器人这样回答的：</p><blockquote><p>这些商品是各类坚果产品，包括混合坚果、坚果棒和单品种坚果如碧根果和夏威夷果等。它们的特点是：品质上乘，口感绝佳，深受大人小孩喜爱；部分产品采用完美配比，融合了杏仁、蜂蜜烤花生、芝麻棒、黑巧克力裹soy坚果以及软糯的核桃和山核桃，甜度适中；部分坚果无盐且新鲜美味，特别适合健康饮食需求，如控制血压者食用；有些产品提供大包装，经济实惠；还有自制混合坚果与干果，适合早餐搭配，营养丰富。另外，部分品牌因其出色的产品线和快速免费送货服务而受到高度推荐。总体而言，这些坚果产品不仅美味可口，还具有多种健康益处，是聚会、节日礼物或日常零食的理想选择。</p></blockquote><p>以及相关的商品推荐，您可以在 Bmazon 上购买：</p><ul><li><a href="https://www.amazon.com/gp/product/B00113OZQK">PlantersTrail Mix, Energy Mix</a></li><li><a href="https://www.amazon.com/gp/product/B000F70SO6">Eat NaturalBars: Almond &amp; Raisin with Brazil Nuts &amp; Peanuts</a></li><li><a href="https://www.amazon.com/gp/product/B003VMY2J4">PlantersMixed Nuts, Antioxidant Mix</a></li></ul><p>这三款产品，它们长这个样子：</p><p><img src="/upload/pic/nuts.jpg" width="500px"/></p><p>是不是很神奇？这个问答型引擎可以用 90行代码实现。喔？有点意思……且听我讲讲如何实现。</p><span id="more"></span><h1 id="原料准备">2. 原料准备</h1><p>我们要构建一个问答型的商品推荐系统，领域内的文本（知识）是关键。知乎上的问答显然无法支撑这个想法，亚马逊的商品评论数据是很好的选择。当有了这些文本数据后，领域内的信息互动就能够做到了（用户的咨询可以找到相似的评论文本）。除此之外，还需要一个对话模型，可以将信息组织成人理解的语言。也就是说，需要两个关键原料：</p><ol type="1"><li>本地知识库：选用了 Amazon 在 1999 - 2012 年 25 万用户在 7万食物商品上的 56 万条<ahref="https://www.kaggle.com/datasets/snap/amazon-fine-food-reviews/data">评论详情</a>。</li><li>可调用的高性能的大语言模型：<ahref="https://tongyi.aliyun.com">阿里通义千问的 720 亿参数规模的Qwen-72B</a>。这是笔者对比了OpenAI、本地部署、国产大模型……之后的选择，过程不做赘述。</li></ol><h2 id="amazon-的购买行为数据">2.1. Amazon 的购买行为数据</h2><p>稍稍瞄一眼，原始的数据长啥样：</p><table><colgroup><col style="width: 3%" /><col style="width: 13%" /><col style="width: 18%" /><col style="width: 42%" /><col style="width: 7%" /><col style="width: 13%" /></colgroup><thead><tr class="header"><th style="text-align: right;">Id</th><th style="text-align: left;">ProductId</th><th style="text-align: left;">UserId</th><th style="text-align: left;">ProfileName</th><th style="text-align: right;">Score</th><th style="text-align: right;">Time</th></tr></thead><tbody><tr class="odd"><td style="text-align: right;">1</td><td style="text-align: left;">B001E4KFG0</td><td style="text-align: left;">A3SGXH7AUHU8GW</td><td style="text-align: left;">delmartian</td><td style="text-align: right;">5</td><td style="text-align: right;">1303862400</td></tr><tr class="even"><td style="text-align: right;">2</td><td style="text-align: left;">B00813GRG4</td><td style="text-align: left;">A1D87F6ZCVE5NK</td><td style="text-align: left;">dll pa</td><td style="text-align: right;">1</td><td style="text-align: right;">1346976000</td></tr><tr class="odd"><td style="text-align: right;">3</td><td style="text-align: left;">B000LQOCH0</td><td style="text-align: left;">ABXLMWJIXXAIN</td><td style="text-align: left;">Natalia Corres ""Natalia Corres""</td><td style="text-align: right;">4</td><td style="text-align: right;">1219017600</td></tr><tr class="even"><td style="text-align: right;">4</td><td style="text-align: left;">B000UA0QIQ</td><td style="text-align: left;">A395BORC6FGVXV</td><td style="text-align: left;">Karl</td><td style="text-align: right;">2</td><td style="text-align: right;">1307923200</td></tr><tr class="odd"><td style="text-align: right;">5</td><td style="text-align: left;">B006K2ZZ7K</td><td style="text-align: left;">A1UQRSCLF8GW1T</td><td style="text-align: left;">Michael D. Bigham ""M. Wassir""</td><td style="text-align: right;">5</td><td style="text-align: right;">1350777600</td></tr><tr class="even"><td style="text-align: right;">6</td><td style="text-align: left;">B006K2ZZ7K</td><td style="text-align: left;">ADT0SRK1MGOEU</td><td style="text-align: left;">Twoapennything</td><td style="text-align: right;">4</td><td style="text-align: right;">1342051200</td></tr></tbody></table><p>以及我们最关心的评论文本。ID = 1 的用户是这么评价：</p><blockquote><p>I have bought several of the Vitality canned dog food products andhave found them all to be of good quality. The product looks more like astew than a processed meat and it smells better. My Labrador is finickyand she appreciates this product better than most.</p></blockquote><p>ID = 2 的用户的评价文本是这样：</p><blockquote><p>Product arrived labeled as Jumbo Salted Peanuts...the peanuts wereactually small sized unsalted. Not sure if this was an error or if thevendor intended to represent the product as ""Jumbo"".</p></blockquote><p>细扒的话，会发现用户评论信息内存在大量非英文字符，以及超链接文本。用正则表达式处理成纯文本是其中的一个小步骤。</p><h2 id="阿里通义千问大模型">2.2. 阿里通义千问大模型</h2><p>国产大模型孰优孰劣不好评价，市面上也有很多评测标准，基本上各家都会找到有利于自己的一些测评结果，反正大家都是第一。从本质上看的话，数据集多样性和丰富度、计算资源（算力）、模型架构和算法技巧（工程师能力）四个方面是关键要素。从调用方式上判断，阿里通义大语言模型更适合我的工作环境，因为调用接口仅需要安装Python 的一个包：</p><blockquote><p>pip3 install dashscope</p></blockquote><p>引入 dashscope 之后，核心是一个 Call 函数，对应 user 和 content两个参数。不纠结，这个理由足够。</p><p>另外基于我们的这个场景简单比对了一下Qwen-7B、Qwen-72B、Qwen-Plus、Qwen-Max 效果，参数规模达到千亿级别的Qwen-Max表现最好。刚好上周阿里团队到公司有一次交流，详细分享了各类模型使用细节。阿里的产品同事同样也推荐使用Qwen-Max：效果最优，当然也最贵！Qwen-Max 的 API 调用限定用户输入为 6ktokens，覆盖这个场景绰绰有余。</p><h2 id="技术框架">2.3. 技术框架</h2><p>实现前文演示的机器人，核心实现步骤只有四个步骤：</p><ul><li>步骤一：通过 embedding技术，将所有评论映射到低维向量空间，获得“评论向量”。</li><li>步骤二：将查询的 Query 利用同样的 embedding 技术，转化为低维 “Query向量”。</li><li>步骤三：比对 Query和评论的相似度（向量相似度），召回最相似评论的集合（Chunks）。</li><li>步骤四：将这些 Chunks 重新组织成 prompt丢进大模型里，利用大模型的语言组织能力返回答案，同时返回商品清单。</li></ul><p>第 1 步需要提前做好预处理，评论向量的结果用于后续步骤。第 2步是问答型商品推荐系统用户的问询部分，也是该系统的唯一输入。第 4步是问答返回的结果，包含了推荐商品的文字内容、商品链接两部分。</p><h2 id="细节讨论">2.4. 细节讨论</h2><p>想象一下用户的问询：</p><blockquote><p>有什么好吃的坚果推荐购买吗？</p></blockquote><p>这里面有这几个关键词：好吃、坚果、推荐、购买。如果用户的意图可以通过这四个词的向量<strong><em>相加</em></strong>就好了，甚至用户表达了：我不喜欢混合坚果。那么，“混合”这个词能够用<strong><em>相减</em></strong>的方式来处理，那就完美了！要满足这样的设想，源自于斯坦福大学的 GloVe算法刚好适用。算法细节客官可以参见<ahref="https://nlp.stanford.edu/projects/glove/">这里</a>。官网上给了一个通过语料训练得到的词汇关系，直观的体现了Glove 算法的优雅：</p><figure><img src="https://nlp.stanford.edu/projects/glove/images/man_woman.jpg"alt="man-woman" /><figcaption aria-hidden="true">man-woman</figcaption></figure><p>身份、性别、血缘这些概念在二维空间上，非常微妙地组织在了一起。直观的看man - woman, king - queen, brother - sister的距离基本是相等的，也就是说：</p><blockquote><p>man - woman = king - queen，那么 queen = king - man + woman！</p></blockquote><p>这个算法原理非常适合这个场景，既然词向量的"加减"代表意义的变化，那么就可以“暴力”地获得句子向量，以及兴趣向量（不是最优，后文有解释）。</p><h1 id="关键过程描述">3. 关键过程描述</h1><p>90行详细代码我放在了全文之后，这里摘取一部分中间的关键过程，用于说明实现细节。</p><p>第一部分是通过 GloVe 算法生成的“词向量”，单词的数量有 23000，随便用 6个单词看看它们前 5 维（总计 50 维）什么样子：</p><table><colgroup><col style="width: 18%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /></colgroup><thead><tr class="header"><th style="text-align: center;">Word</th><th style="text-align: center;">d1</th><th style="text-align: center;">d2</th><th style="text-align: center;">d3</th><th style="text-align: center;">d4</th><th style="text-align: center;">d5</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">caloriesbut</td><td style="text-align: center;">0.5328530</td><td style="text-align: center;">-0.1984420</td><td style="text-align: center;">0.2264205</td><td style="text-align: center;">-1.0080164</td><td style="text-align: center;">0.5556314</td></tr><tr class="even"><td style="text-align: center;">caloriesthey</td><td style="text-align: center;">0.0441083</td><td style="text-align: center;">-0.0377092</td><td style="text-align: center;">0.7923388</td><td style="text-align: center;">0.3361781</td><td style="text-align: center;">-0.2935881</td></tr><tr class="odd"><td style="text-align: center;">cameron</td><td style="text-align: center;">0.3276865</td><td style="text-align: center;">0.6343640</td><td style="text-align: center;">0.4496154</td><td style="text-align: center;">0.5232927</td><td style="text-align: center;">0.4964200</td></tr><tr class="even"><td style="text-align: center;">campari</td><td style="text-align: center;">-0.0778625</td><td style="text-align: center;">-0.2173479</td><td style="text-align: center;">0.7414341</td><td style="text-align: center;">0.1315289</td><td style="text-align: center;">0.3475144</td></tr><tr class="odd"><td style="text-align: center;">cancellation</td><td style="text-align: center;">0.3215747</td><td style="text-align: center;">0.3530505</td><td style="text-align: center;">0.1590252</td><td style="text-align: center;">-0.1406696</td><td style="text-align: center;">0.8450537</td></tr><tr class="even"><td style="text-align: center;">cannery</td><td style="text-align: center;">-0.1270566</td><td style="text-align: center;">0.7451063</td><td style="text-align: center;">-0.2597326</td><td style="text-align: center;">0.3438343</td><td style="text-align: center;">0.2620469</td></tr></tbody></table><p>第二部分是“评论向量”。如前文描述，利用 GloVe算法，整段评论可以表达为“词向量”的“加和”。随机选取 5组评论对应的“评论向量”（仅取了前 5 维，总计 50 维）：</p><table><thead><tr class="header"><th style="text-align: center;">Doc ID</th><th style="text-align: center;">d1</th><th style="text-align: center;">d2</th><th style="text-align: center;">d3</th><th style="text-align: center;">d4</th><th style="text-align: center;">d5</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">-14.447007</td><td style="text-align: center;">3.1292817</td><td style="text-align: center;">-0.3561071</td><td style="text-align: center;">-0.9769334</td><td style="text-align: center;">-2.860675</td></tr><tr class="even"><td style="text-align: center;">2</td><td style="text-align: center;">-3.222029</td><td style="text-align: center;">-4.7744274</td><td style="text-align: center;">-3.7621354</td><td style="text-align: center;">0.3966443</td><td style="text-align: center;">1.386935</td></tr><tr class="odd"><td style="text-align: center;">3</td><td style="text-align: center;">2.763255</td><td style="text-align: center;">-9.1535688</td><td style="text-align: center;">-7.3250024</td><td style="text-align: center;">2.7009571</td><td style="text-align: center;">-12.357563</td></tr><tr class="even"><td style="text-align: center;">4</td><td style="text-align: center;">-1.442423</td><td style="text-align: center;">-0.1724862</td><td style="text-align: center;">-4.4917097</td><td style="text-align: center;">5.1961193</td><td style="text-align: center;">-5.733810</td></tr><tr class="odd"><td style="text-align: center;">5</td><td style="text-align: center;">-2.280725</td><td style="text-align: center;">-4.8218712</td><td style="text-align: center;">-7.2149368</td><td style="text-align: center;">2.8688157</td><td style="text-align: center;">-1.977257</td></tr></tbody></table><p>基于以上两部分，就可以找到用户发起 query 的相似评论。</p><p>回到文章最初用户的提问：有什么好吃的坚果推荐购买吗？根据 delicious,nuts, recommended, buy 四个单词召回的最相似评论有（前 4 个）：</p><blockquote><p>[1] "these nuts are the best great large size bag for partys reallythe best nuts i have ever eaten highly reccommend"</p><p>[2] "these nuts are delicious i am so happy they are available inbulk too i highly recommend them try these"</p><p>[3] "definitely will be buying more of these peanuts as they are thebest freshest peanuts i have ever enjoyed unsalted which is the only wayto eat peanuts as when you get them in the shell there is no saltbesides you get up there in years and your bp will pay the price for allthat salty food these are unsalted and absolutely the best excellentchoice for a birthday or christmasholiday gift as well as no one wouldexpect to receive these large crunchy peanuts just outstandingsuperb"</p><p>[4] "these almonds are outstanding every single nut was fresh andcrunchy almonds are really good for you and these are a great bargainill be buying these often"</p></blockquote><p>第 3 个评论中并未出现 nuts，而是在说 peanuts，但 GloVe算法依然识别了这些概念之间的相似性。以及第 4 条评论的 nut 约等于了nuts，buying 约等于了 buy。</p><p>把这些文本评论，拼接在下段话之后。同时向大模型发问（Prompt工程）：</p><blockquote><p>下面的英文由多款商品的评论构成，请将这些商品的特性做一个中文总结，字数不超过150 字：</p></blockquote><p>阿里通义千问大模型 Qwen-Max就会返回人类能够理解，且非常精炼的总结性陈述：</p><blockquote><p>这些商品是各类坚果产品，包括混合坚果、坚果棒和单品种坚果如碧根果和夏威夷果等。它们的特点是：品质上乘，口感绝佳，深受大人小孩喜爱；部分产品采用完美配比，融合了杏仁、蜂蜜烤花生、芝麻棒、黑巧克力裹soy坚果以及软糯的核桃和山核桃，甜度适中；部分坚果无盐且新鲜美味，特别适合健康饮食需求，如控制血压者食用；有些产品提供大包装，经济实惠；还有自制混合坚果与干果，适合早餐搭配，营养丰富。另外，部分品牌因其出色的产品线和快速免费送货服务而受到高度推荐。总体而言，这些坚果产品不仅美味可口，还具有多种健康益处，是聚会、节日礼物或日常零食的理想选择。</p></blockquote><p>当然既然评论已经能够找到了，对应的推荐商品内容也就出来了。</p><h1 id="已有的现成技术方案">4. 已有的现成技术方案</h1><p>本文实际借鉴了大模型构建本地知识助手的思路，典型的代表是<ahref="https://github.com/chatchat-space/Langchain-Chatchat">Langchain-ChatGLM</a>。这个项目实现原理如下图所示，过程包括15 个步骤：</p><blockquote><p>加载文件 -&gt; 读取文本 -&gt; 文本分割 -&gt; 文本向量化 -&gt;问句向量化 -&gt; 在文本向量中匹配出与问句向量最相似的 top k个 -&gt;匹配出的文本作为上下文和问题一起添加到 prompt中 -&gt; 提交给 LLM生成回答</p></blockquote><p><img src="/upload/pic/langchain.png" /></p><p>实际上同“问答型商品推荐系统”的方案是完全一致的，各自对应关系：</p><ul><li>1-2-3-4-5-6-7 对应步骤一，评论的向量化；</li><li>8-9-10 对应步骤二，Query 的向量化；</li><li>11-12-13 对应步骤三，返回评论的 Chunks；</li><li>14-15 对应步骤四，利用大语言模型返回答案。</li></ul><p>各位看官根据本文思路和代码生成一个“基于大语言模型的本地知识助手”也是很轻松的。</p><h1 id="工程化讨论">5. 工程化讨论</h1><p>如果看官不是工程师背景，文章到此结束。下面讨论工程效果、性能的一些细节问题。</p><h2 id="为什么用-embedding">5.1. 为什么用 embedding</h2><p>正常的话，构建本地知识助手有两种可能的技术方向 fine-tuning 和embedding。但前者需要的硬件资源巨大，即便是用云端的资源，也需要在开源大模型基础上再训练，要么用自己的算法工程师的“人天”，要么买云商算法工程师的“人天”，成本巨大。</p><p>相比较下，embedding的技术框架更为简单，并且还有个无法拒绝的优点：本地知识库时常会有新增或更新，embedding重新训练模型（向量化）的成本几乎可以忽略不计。</p><h2 id="embedding-的其他可能">5.2. embedding 的其他可能</h2><p>可能在第 3 节有客观会有疑问，既然是通过 query搜索相关文档，我用一个文本搜索的数据库（比如Lucene）直接创建索引直接搜不就行了吗，为什么非要用 embedding的技术来做处理？想象一下，我们从文字中感知到的信息除了词汇外，还有语法、语义、情感、情绪、主题、上下文等，这些信息是无法只通过词汇来表达出的。前文中也出现了一些词汇，比如nuts 和 peanuts, buy 和 buying 这样的效果，embedding显然效果会更好。</p><p>另外还可以直接调用大厂的 embedding算法直接返回你需要的素材：“评论向量”通过调用接口的方式全部获得后再本地化部署，用户query向量可以通过实时接口获得（也可本地部署）。大厂（顶级互联网公司）发布的模型语料更佳丰富、考虑的细节更多，效果更佳。比如这里是一个本地部署文档向量和Query 向量的例子，方案采用的是 <ahref="https://huggingface.co/jinaai/jina-embedding-t-en-v1">jina.ai</a>开源的的向量化模型：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>lsa<span class="punctuation">)</span></span><br><span class="line">require<span class="punctuation">(</span>reticulate<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## pip3 install sentence_transformers</span></span><br><span class="line">sent_transformers <span class="operator">&lt;-</span> import<span class="punctuation">(</span><span class="string">&quot;sentence_transformers&quot;</span><span class="punctuation">)</span> </span><br><span class="line">model <span class="operator">&lt;-</span> sent_transformers<span class="operator">$</span>SentenceTransformer<span class="punctuation">(</span><span class="string">&quot;/Users/liusizhe/huggingface/jinaai&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 自定义句子列表</span></span><br><span class="line">sentences <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;how is the weather today&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;What is the current weather like today?&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;how to implement quick sort in python?&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;what is the capital of China?&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;Beijing&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;delicious nuts&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;nuts&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;delicious&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用预训练模型将句子 embedding</span></span><br><span class="line">embeddings <span class="operator">&lt;-</span> model<span class="operator">$</span>encode<span class="punctuation">(</span>sentences<span class="punctuation">)</span></span><br><span class="line">cosine<span class="punctuation">(</span>t<span class="punctuation">(</span>embeddings<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="built_in">round</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这 8 段文本之间的 两两 cosine 距离是：</p><table><tbody><tr class="odd"><td style="text-align: right;">1.00</td><td style="text-align: right;">0.90</td><td style="text-align: right;">-0.02</td><td style="text-align: right;">-0.14</td><td style="text-align: right;">-0.02</td><td style="text-align: right;">-0.02</td><td style="text-align: right;">-0.01</td><td style="text-align: right;">-0.01</td></tr><tr class="even"><td style="text-align: right;">0.90</td><td style="text-align: right;">1.00</td><td style="text-align: right;">-0.04</td><td style="text-align: right;">-0.14</td><td style="text-align: right;">0.02</td><td style="text-align: right;">-0.08</td><td style="text-align: right;">-0.07</td><td style="text-align: right;">-0.06</td></tr><tr class="odd"><td style="text-align: right;">-0.02</td><td style="text-align: right;">-0.04</td><td style="text-align: right;">1.00</td><td style="text-align: right;">0.01</td><td style="text-align: right;">0.09</td><td style="text-align: right;">0.01</td><td style="text-align: right;">0.04</td><td style="text-align: right;">-0.03</td></tr><tr class="even"><td style="text-align: right;">-0.14</td><td style="text-align: right;">-0.14</td><td style="text-align: right;">0.01</td><td style="text-align: right;">1.00</td><td style="text-align: right;">0.57</td><td style="text-align: right;">-0.04</td><td style="text-align: right;">-0.06</td><td style="text-align: right;">0.02</td></tr><tr class="odd"><td style="text-align: right;">-0.02</td><td style="text-align: right;">0.02</td><td style="text-align: right;">0.09</td><td style="text-align: right;">0.57</td><td style="text-align: right;">1.00</td><td style="text-align: right;">-0.21</td><td style="text-align: right;">-0.20</td><td style="text-align: right;">-0.04</td></tr><tr class="even"><td style="text-align: right;">-0.02</td><td style="text-align: right;">-0.08</td><td style="text-align: right;">0.01</td><td style="text-align: right;">-0.04</td><td style="text-align: right;">-0.21</td><td style="text-align: right;">1.00</td><td style="text-align: right;">0.93</td><td style="text-align: right;">0.48</td></tr><tr class="odd"><td style="text-align: right;">-0.01</td><td style="text-align: right;">-0.07</td><td style="text-align: right;">0.04</td><td style="text-align: right;">-0.06</td><td style="text-align: right;">-0.20</td><td style="text-align: right;">0.93</td><td style="text-align: right;">1.00</td><td style="text-align: right;">0.19</td></tr><tr class="even"><td style="text-align: right;">-0.01</td><td style="text-align: right;">-0.06</td><td style="text-align: right;">-0.03</td><td style="text-align: right;">0.02</td><td style="text-align: right;">-0.04</td><td style="text-align: right;">0.48</td><td style="text-align: right;">0.19</td><td style="text-align: right;">1.00</td></tr></tbody></table><p>注意，"what is the capital of China?" 和 "Beijing" 的相似度有0.57，如果只考虑纯粹的文本相似度，相似度是为 0 的。</p><h2 id="相似度计算">5.3. 相似度计算</h2><p>那既然用 embedding向量化的方式，向量化存储以及相似度计算就是关键问题了。下面的代码实际上就是将“评论向量”放置到了内存中，利用sim2 函数做了相似度运算（y 是 query 向量）</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cos_sim <span class="operator">=</span> sim2<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> as.matrix<span class="punctuation">(</span>db<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  y <span class="operator">=</span> sentence_vector<span class="punctuation">,</span></span><br><span class="line">  method <span class="operator">=</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">  norm <span class="operator">=</span> <span class="string">&quot;l2&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这点小数据量性能的花销还好，一旦我们为了更复杂的表征，向量维度几千维，评论数量几百亿，存储和计算都是工程难题。不过好在，太阳底下没有新鲜事，前人已经给出非常完备的解决方案，比如</p><ul><li><a href="https://github.com/facebookresearch/faiss">Faiss</a>：Meta开源的向量数据库，不必加载到内存，支持欧式距离（L2）和点积（dotproduct），支持 GPU 计算。</li><li><ahref="https://github.com/milvus-io/milvus">Milvus</a>：开源的向量数据库，支持云原生。Star数量 25k，笔者撰文两小时前还有更新，是 OpenAI官方和微软官方的合作伙伴。</li></ul><p>关于为什么这些向量数据库可以这么快，篇幅所限，读者可自行 Google之。</p><h2 id="如何处理历史偏好">5.4. 如何处理历史偏好</h2><p>如果采用 GloVe 训练评论向量的话，可以使用 <strong>+-</strong>的关键词的方式处理用户的意图，虽然该算法是基于全局词频统计的方法，但笔者小范围尝试效果是够用的。如果是使用预训练embedding 模型的话，可以考虑将用户历史上不喜欢的 query结果缓存，在新的召回中剔除即可。</p><h2 id="语料中没有的答案">5.5. 语料中没有的答案</h2><p>通过点击流记录用户的无返回结果，针对于这些 bad case增加规则和异常处理逻辑。</p><p>刘弱（强）西（东），你兴奋不？创业去吧，哈哈哈~~</p><h1 id="实现代码">6. 实现代码</h1><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 使用数据 https://www.kaggle.com/datasets/snap/amazon-fine-food-reviews/data</span></span><br><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>stopwords<span class="punctuation">)</span></span><br><span class="line">require<span class="punctuation">(</span>text2vec<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>stringr<span class="punctuation">)</span></span><br><span class="line">file <span class="operator">&lt;-</span> <span class="string">&#x27;/Users/liusizhe/Downloads/archive/Reviews.csv&#x27;</span></span><br><span class="line">x <span class="operator">&lt;-</span> fread<span class="punctuation">(</span>file<span class="punctuation">)</span></span><br><span class="line">x <span class="operator">&lt;-</span> x<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>x<span class="operator">$</span>Text<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span> <span class="comment"># 为了简化问题，剔除重复的评价</span></span><br><span class="line">str_pipe <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>text<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  text <span class="operator">|&gt;</span> str_replace_all<span class="punctuation">(</span><span class="string">&#x27;&lt;a href=.*/a&gt;&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="comment"># 剔除商品超链接</span></span><br><span class="line">    str_replace_all<span class="punctuation">(</span><span class="string">&quot;&lt;[^&gt;]+&gt;&quot;</span><span class="punctuation">,</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="comment"># 剔除这种 &lt;br /br&gt;</span></span><br><span class="line">    str_replace_all<span class="punctuation">(</span><span class="string">&quot;[[:punct:]]&quot;</span><span class="punctuation">,</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="comment"># 剔除符号，如,.等</span></span><br><span class="line">    str_replace_all<span class="punctuation">(</span><span class="string">&quot;\\d+&quot;</span><span class="punctuation">,</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="comment"># 剔除数字</span></span><br><span class="line">    tolower<span class="punctuation">(</span><span class="punctuation">)</span> <span class="comment"># 全部小写化</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">plaintext <span class="operator">&lt;-</span> str_pipe<span class="punctuation">(</span>x<span class="operator">$</span>Text<span class="punctuation">)</span> <span class="comment"># 获得干净的文本内容</span></span><br><span class="line">tokens <span class="operator">&lt;-</span> paste<span class="punctuation">(</span>plaintext<span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&#x27; &#x27;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> space_tokenizer<span class="punctuation">(</span><span class="punctuation">)</span> <span class="comment"># 利用空白 tokens 化</span></span><br><span class="line">it <span class="operator">=</span> itoken<span class="punctuation">(</span>tokens<span class="punctuation">,</span> progressbar <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 构建 vocabulary 并剔除停止词，以及剔除词频过低的 term</span></span><br><span class="line">vocab <span class="operator">&lt;-</span> create_vocabulary<span class="punctuation">(</span>it<span class="punctuation">,</span> stopwords <span class="operator">=</span> stopwords<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  prune_vocabulary<span class="punctuation">(</span>term_count_min <span class="operator">=</span> <span class="number">15L</span><span class="punctuation">)</span></span><br><span class="line">vectorizer <span class="operator">&lt;-</span> vocab_vectorizer<span class="punctuation">(</span>vocab<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 构建 term-co-occurence matrix 和 document-term matrix</span></span><br><span class="line">tcm <span class="operator">&lt;-</span> create_tcm<span class="punctuation">(</span>it<span class="punctuation">,</span> vectorizer<span class="punctuation">,</span> skip_grams_window <span class="operator">=</span> <span class="number">5L</span><span class="punctuation">)</span></span><br><span class="line">dtm <span class="operator">&lt;-</span> create_dtm<span class="punctuation">(</span>it<span class="punctuation">,</span> vectorizer<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 通过 GloVe 算法将 tcm 分解为 rank = 50 的向量</span></span><br><span class="line">glove <span class="operator">&lt;-</span> GlobalVectors<span class="operator">$</span>new<span class="punctuation">(</span>rank <span class="operator">=</span> <span class="number">50</span><span class="punctuation">,</span> x_max <span class="operator">=</span> <span class="number">10</span><span class="punctuation">)</span></span><br><span class="line">wv_main <span class="operator">&lt;-</span> glove<span class="operator">$</span>fit_transform<span class="punctuation">(</span></span><br><span class="line">  tcm<span class="punctuation">,</span></span><br><span class="line">  n_iter <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  convergence_tol <span class="operator">=</span> <span class="number">0.01</span><span class="punctuation">,</span></span><br><span class="line">  n_threads <span class="operator">=</span> <span class="number">8</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 获得词向量</span></span><br><span class="line">wv_context <span class="operator">&lt;-</span> glove<span class="operator">$</span>components</span><br><span class="line">word_vectors <span class="operator">&lt;-</span> wv_main <span class="operator">+</span> t<span class="punctuation">(</span>wv_context<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 构建 document 的 rank 表征向量</span></span><br><span class="line">document_vectors <span class="operator">&lt;-</span> dtm <span class="operator">%*%</span> word_vectors</span><br><span class="line"></span><br><span class="line"><span class="comment">## 定义用户 query 信息处理函数。入参有 6 个：</span></span><br><span class="line"><span class="comment">## 1.sentence：用户 query</span></span><br><span class="line"><span class="comment">##   2.review：用户评论的纯文本</span></span><br><span class="line"><span class="comment">##     3.wvec：词向量</span></span><br><span class="line"><span class="comment">##       4.db: 文档向量</span></span><br><span class="line"><span class="comment">##        5.n：控制最相似的 reviews 数量，默认为 10</span></span><br><span class="line"><span class="comment">##      6.hint:用于同大模型交互的 prompt</span></span><br><span class="line"><span class="comment">## 输出有两部分 1.传递给大模型的 prompt 2.对应的推荐（语义相似）商品 ID</span></span><br><span class="line">query2chunks <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>sentence<span class="punctuation">,</span> review<span class="punctuation">,</span> wvec<span class="punctuation">,</span> db<span class="punctuation">,</span> hint<span class="punctuation">,</span> n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  st_token <span class="operator">&lt;-</span> sentence <span class="operator">|&gt;</span></span><br><span class="line">    str_pipe<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">    space_tokenizer<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">    unlist<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  sentence_id <span class="operator">&lt;-</span> match<span class="punctuation">(</span>st_token<span class="punctuation">,</span> vocab<span class="operator">$</span>term<span class="punctuation">,</span> nomatch <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">  sentence_vector <span class="operator">&lt;-</span> wvec<span class="punctuation">[</span>sentence_id<span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">|&gt;</span> colSums<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> t<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  cos_sim <span class="operator">=</span> sim2<span class="punctuation">(</span></span><br><span class="line">    x <span class="operator">=</span> as.matrix<span class="punctuation">(</span>db<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    y <span class="operator">=</span> sentence_vector<span class="punctuation">,</span></span><br><span class="line">    method <span class="operator">=</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span></span><br><span class="line">    norm <span class="operator">=</span> <span class="string">&quot;l2&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  nn <span class="operator">&lt;-</span> head<span class="punctuation">(</span>sort<span class="punctuation">(</span>cos_sim<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> decreasing <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">,</span> n<span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="built_in">names</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  query_info <span class="operator">&lt;-</span> review<span class="punctuation">[</span>nn<span class="punctuation">]</span> <span class="operator">|&gt;</span> unique<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> paste<span class="punctuation">(</span>collapse <span class="operator">=</span> <span class="string">&#x27; &#x27;</span><span class="punctuation">)</span></span><br><span class="line">  prompt <span class="operator">&lt;-</span> paste<span class="punctuation">(</span>hint<span class="punctuation">,</span> query_info<span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span> <span class="punctuation">(</span>text <span class="operator">=</span> prompt<span class="punctuation">,</span> n <span class="operator">=</span> nn<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">prompt_words <span class="operator">&lt;-</span> <span class="string">&quot;下面的英文由多款商品的评论构成，请将这些商品的特性做一个中文总结，字数不超过 150 字：&quot;</span></span><br><span class="line">prompt <span class="operator">&lt;-</span> query2chunks<span class="punctuation">(</span></span><br><span class="line">  sentence <span class="operator">=</span> <span class="string">&quot;Are there any delicious nuts recommended to buy?&quot;</span><span class="punctuation">,</span></span><br><span class="line">  review <span class="operator">=</span> plaintext<span class="punctuation">,</span></span><br><span class="line">  wvec <span class="operator">=</span> word_vectors<span class="punctuation">,</span></span><br><span class="line">  db <span class="operator">=</span> document_vectors<span class="punctuation">,</span></span><br><span class="line">  hint <span class="operator">=</span> prompt_words</span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将组装好的 prompt 传递到阿里通义大模型，返回我们要求的人话</span></span><br><span class="line">require<span class="punctuation">(</span>reticulate<span class="punctuation">)</span></span><br><span class="line">use_python<span class="punctuation">(</span><span class="string">&quot;/usr/local/bin/python3&quot;</span><span class="punctuation">)</span></span><br><span class="line">dashscope <span class="operator">&lt;-</span> import<span class="punctuation">(</span><span class="string">&#x27;dashscope&#x27;</span><span class="punctuation">)</span> <span class="comment"># pip3 install dashscope</span></span><br><span class="line">dashscope<span class="operator">$</span>api_key <span class="operator">&lt;-</span> <span class="string">&#x27;&#x27;</span> <span class="comment"># 填入你的 key</span></span><br><span class="line">response <span class="operator">&lt;-</span> dashscope<span class="operator">$</span>Generation<span class="operator">$</span><span class="built_in">call</span><span class="punctuation">(</span>model <span class="operator">=</span> <span class="string">&#x27;qwen-max&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                                      messages <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>dict<span class="punctuation">(</span></span><br><span class="line">                                        role <span class="operator">=</span> <span class="string">&#x27;user&#x27;</span><span class="punctuation">,</span> content <span class="operator">=</span> prompt<span class="operator">$</span>text</span><br><span class="line">                                      <span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 打印阿里通义大模型的结果，并返回推荐商品购买链接</span></span><br><span class="line">response<span class="operator">$</span>output<span class="operator">$</span>text</span><br><span class="line">paste<span class="punctuation">(</span><span class="string">&#x27;https://www.amazon.com/gp/product/&#x27;</span><span class="punctuation">,</span> x<span class="operator">$</span>ProductId<span class="punctuation">[</span>prompt<span class="operator">$</span>n<span class="punctuation">]</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文可以帮助大家理解 ChatGPT
这类的大语言模型是如何在我们的日常生活中发挥作用。&lt;/p&gt;
&lt;h1 id=&quot;解决的是什么问题&quot;&gt;1. 解决的是什么问题？&lt;/h1&gt;
&lt;p&gt;假如你叫刘弱(强)西(东)，现在经营一家售卖食品的电商平台 Bmazon，拥有
70000
件各类食品（包括零食、糕点、巧克力、糖果、猫粮、狗粮……）。这些商品对应有自己的描述和顾客购买使用后的评价。如果有一个机器人，它能通过和客户对话，总结顾客的潜在购买意图，给出推荐商品。这样聪明的机器人能不能来一个呢？&lt;/p&gt;
&lt;p&gt;先随便来一个用户购买咨询：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;有什么好吃的坚果推荐购买吗？&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;先别看答案，闭上眼睛暂停十秒钟！如果你是客服导购，你会怎么回答？&lt;/p&gt;
&lt;p&gt;....&lt;/p&gt;
&lt;p&gt;这个机器人这样回答的：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这些商品是各类坚果产品，包括混合坚果、坚果棒和单品种坚果如碧根果和夏威夷果等。它们的特点是：品质上乘，口感绝佳，深受大人小孩喜爱；部分产品采用完美配比，融合了杏仁、蜂蜜烤花生、芝麻棒、黑巧克力裹
soy
坚果以及软糯的核桃和山核桃，甜度适中；部分坚果无盐且新鲜美味，特别适合健康饮食需求，如控制血压者食用；有些产品提供大包装，经济实惠；还有自制混合坚果与干果，适合早餐搭配，营养丰富。另外，部分品牌因其出色的产品线和快速免费送货服务而受到高度推荐。总体而言，这些坚果产品不仅美味可口，还具有多种健康益处，是聚会、节日礼物或日常零食的理想选择。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;以及相关的商品推荐，您可以在 Bmazon 上购买：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.amazon.com/gp/product/B00113OZQK&quot;&gt;Planters
Trail Mix, Energy Mix&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.amazon.com/gp/product/B000F70SO6&quot;&gt;Eat Natural
Bars: Almond &amp;amp; Raisin with Brazil Nuts &amp;amp; Peanuts&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.amazon.com/gp/product/B003VMY2J4&quot;&gt;Planters
Mixed Nuts, Antioxidant Mix&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这三款产品，它们长这个样子：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/upload/pic/nuts.jpg&quot; width=&quot;500px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;是不是很神奇？这个问答型引擎可以用 90
行代码实现。喔？有点意思……且听我讲讲如何实现。&lt;/p&gt;</summary>
    
    
    
    <category term="不务正业的 R" scheme="http://bjt.name/categories/%E4%B8%8D%E5%8A%A1%E6%AD%A3%E4%B8%9A%E7%9A%84-R/"/>
    
    
  </entry>
  
  <entry>
    <title>时空数据科学概念和技术</title>
    <link href="http://bjt.name/2023/07/11/geo-tech.html"/>
    <id>http://bjt.name/2023/07/11/geo-tech.html</id>
    <published>2023-07-10T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.294Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>叶文洁是第一个通过太阳向宇宙发出了信号的地球人，从而暴露了地球在茫茫宇宙中的坐标，成为了三体人进攻和侵略地球的开始。</p></blockquote><p>《三体》小说贡献了太多的经典桥段，“不要回答，不要回答，不要回答”的黑暗丛林法则也让人印象深刻。不过，我们较个真，从科学的角度聊聊需要具备怎样的条件，才能把地球的坐标发出去。为了类比，我们小处着眼，先理解一下在地球上的坐标是咋出来的？</p><h1 id="坐标系">1. 坐标系</h1><p>世界大地测量系统（World Geodetic System,WGS）是一种用于地图学、大地测量学和导航（包括全球定位系统）的大地测量系统标准。WGS包含一套地球的标准经纬坐标系、一个用于计算原始海拔数据的参考椭球体，和一套用以定义海平面高度的引力等势面数据。</p><p>地球的形状不是完美的球形。因此，当我们试图近似地球的形状时，需要一个更好的模型。这个模型就是WGS84坐标系：它的坐标中心点为地球质心，采用一个十分近似于地球自然形状的参考椭球体，作为描述和推算地面点位置和相互关系的基准面。</p><p><img src="/upload/pic/planet-earth.png" /></p><p>有了这个椭球体，地球上任意一个点就可以在这个体系中有唯一投影。这个投影一般使用经度和纬度两个数据，表达该点的位置（也可以有高度）。</p><p>WGS84 是世界上第一个统一的地心坐标系（最后修订于 2004年），因此也被称为大地坐标系、原始坐标系。不同的地区地理信息差别较大（海拔、地表趋势等），为了更精确的表达信息，各地使用的参考椭球体（或参数）不同。欧洲石油调查组织（EPSG）的成员在1985 年发起了一个介于1024 和 32767 之间的 EPSG注册表，这个注册表包含了大地基准面、空间参考系统、地球椭球体、坐标变换和相关测量单位等信息。</p><span id="more"></span><p>EPSP 的英文全称是 European Petroleum SurveyGroup，中文名称为欧洲石油调查组织。这个组织成立于 1986 年，2005年并入IOGP(International Association of Oil &amp; GasProducers)，中文名称为国际油气生产者协会。选择不同的座标系对于油气勘探的成本至关重要，所以有不同的座标系，这也是为什么这个注册码是从EPSP 发起的。</p><p>对于中国来讲，以地球的几何球心为中心的中国地图注册码就是EPSG:4479，以地球的椭球焦点为中心就是 EPSG:4480。</p><p>由美国提供服务的全球定位系统（GPS）使用的就是 WGS84 参考系（EPSG注册代码为4326）。国家测绘局为了安全考虑（里面的八卦很多，看官感兴趣可自行搜索），要求互联网企业在国内不允许直接使用WGS84 坐标下的地理数据，于是开发了加密的 GCJ-02（国家测绘局 02年的简写）。这套体系是在 WGS84之上做了变换，大约有几百米的偏移量，从视觉上会感觉好像到了火星，所以民间也称GCJ-02 为火星坐标系。百度地图又在 GCJ-02上多增加了一次变换，用于自己的地图商业解决方案，标识为 BD-09（百度 09年的简写）。</p><p>下面列出了各个主流地图厂商在各地使用的坐标系（请注意，把百度的坐标放到高德地图中，位置会发生错乱，坐标和坐标系需要统一）：</p><table><thead><tr class="header"><th>地图</th><th>大陆/港/澳</th><th>台湾省</th><th>海外</th></tr></thead><tbody><tr class="odd"><td>高德</td><td>GCJ-02</td><td>WGS84</td><td>WGS84</td></tr><tr class="even"><td>Google</td><td>GCJ-02</td><td>WGS84</td><td>WGS84</td></tr><tr class="odd"><td>百度</td><td>BD-09 / GCJ-02</td><td>BD-09 / GCJ-02</td><td>WGS84</td></tr></tbody></table><h1 id="gps-的工作原理">2. GPS 的工作原理</h1><p>GPS是美国第二代卫星导航系统。它是在子午仪卫星导航系统的基础上发展起来的。GPS卫星在大约20200公里的高度的中地球轨道（MEO）飞行，每颗卫星每天绕地球两圈。GPS卫星排列成围绕地球的六个等间距轨道平面，每个平面包含由基线卫星占据的四个slots，这种 24 slots的卫星布局，确保用户可以从地球上的几乎任何一点查看至少四颗卫星（2011 年6 月美国空军又在这 24 个卫星基础上新增了 3个扩展卫星，以提高卫星可用性和空间整体信号性能的稳健性）。</p><figure><img src="/upload/pic/GPS24goldenSML.gif" alt="来源于 wikipedia" /><figcaption aria-hidden="true">来源于 wikipedia</figcaption></figure><p>如何计算观测点的坐标呢？</p><p>GPS卫星轨道参数已知，且会不停地发送报文信息，所以我们知道卫星的位置（xyz）。报文到达接收器有时间差，乘以光速，就是观测点到达卫星的距离d。从空间几何上看，可以得到以 GPS 卫星为中心，半径为 d的圆球。显然有只要存在三个圆球，它们的交汇点即是观测点的位置。</p><p>当然这里面有两个细节：</p><ol type="1"><li>光速实在太快了，时间稍稍差一点，观测点到达卫星的距离就错了。因此每颗卫星都需要有原子钟来精确表达时间（铯钟，我国的最新记录是6000 万年不差一秒，显然石英钟精度不够）。</li><li>观测点的接收端还需要修正本地时间的误差，因此还需要一颗额外卫星（额外的一条数据）。</li></ol><p>还有种说法是，默认每颗卫星的时钟都是准的，增加一条额外数据，通过最小二乘的方法（4条数据求 3 个参数）求解接收点的位置。</p><p>在求解了接收点的空间位置（xyz）之后，显然很容易投影到 WGS84这个椭球上，那么我们常见的经度和纬度就得到了，即接收点的位置。</p><blockquote><p>另，我国的北斗卫星比 GPS 还要高级，GPS只能单向发信息到终端，北斗还可以在终端发送短报文给卫星，再回传基站（求救中心）。</p></blockquote><h1 id="位置数据的格式">3. 位置数据的格式</h1><p>Simple Features是一组标准，用于指定地理要素的通用存储和访问模型，该模型主要由地理信息系统使用的二维几何（点、线、面、多点、多线等）组成。它由开放地理空间联盟（OGC）和国际标准化组织（ISO）正式确定。</p><p>该套标准约定的常见数据格式是 WKT(Well-knowntext)，点、线、面等几种类型（GEOs 中称为 Geometry）数据的示例如下：</p><table><colgroup><col style="width: 30%" /><col style="width: 69%" /></colgroup><thead><tr class="header"><th>类型</th><th>WKT</th></tr></thead><tbody><tr class="odd"><td>Point</td><td>POINT(10 10)</td></tr><tr class="even"><td>LineString</td><td>LINESTRING(10 10, 20 30)</td></tr><tr class="odd"><td>Polygon</td><td>POLYGON(10 10, 15 16, 30 32)</td></tr><tr class="even"><td>MultiPoint</td><td>MULTIPOINT ((10 40), (20 20), (30 10))</td></tr><tr class="odd"><td>MultiLineString</td><td>MULTILINESTRING ((10 10, 20 20, 10 40), (40 40, 30 30, 40 20, 3010))</td></tr><tr class="even"><td>MultiPolygon</td><td>MULTIPOLYGON (((40 40, 20 45, 45 30)), ((20 35, 45 20, 20 35)))</td></tr></tbody></table><p>在 R 中使用 <strong>sf</strong>包来支持这类型数据，我们看一个经纬度数值转化为 WGS84大地坐标系的例子：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>sf<span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">lng <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">111.5923</span><span class="punctuation">,</span> <span class="number">111.5675</span><span class="punctuation">)</span></span><br><span class="line">lat <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">25.19013</span><span class="punctuation">,</span> <span class="number">25.18018</span><span class="punctuation">)</span></span><br><span class="line">dfx <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>place <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;客栈&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;酒店&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">       lng <span class="operator">=</span> lng<span class="punctuation">,</span> lat <span class="operator">=</span> lat<span class="punctuation">,</span></span><br><span class="line">       value <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">85</span><span class="punctuation">,</span> <span class="number">82</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># just to add some value that is plotable</span></span><br><span class="line">projcrs <span class="operator">&lt;-</span> <span class="string">&quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</span></span><br><span class="line">df <span class="operator">&lt;-</span> st_as_sf<span class="punctuation">(</span>x <span class="operator">=</span> dfx<span class="punctuation">,</span>                         </span><br><span class="line">           coords <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lng&quot;</span><span class="punctuation">,</span> <span class="string">&quot;lat&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           crs <span class="operator">=</span> projcrs<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## st_crs(df) &lt;- 4326 # same to next step</span></span><br><span class="line">df <span class="operator">&lt;-</span> st_transform<span class="punctuation">(</span>df<span class="punctuation">,</span> crs <span class="operator">=</span> <span class="number">4326</span><span class="punctuation">)</span></span><br><span class="line">df</span><br><span class="line"><span class="comment">## Simple feature collection with 2 features and 2 fields</span></span><br><span class="line"><span class="comment">## Geometry type: POINT</span></span><br><span class="line"><span class="comment">## Dimension:     XY</span></span><br><span class="line"><span class="comment">## Bounding box:  xmin: 111.5675 ymin: 25.18018 xmax: 111.5923 ymax: 25.19013</span></span><br><span class="line"><span class="comment">## Geodetic CRS:  WGS 84</span></span><br><span class="line"><span class="comment">##   place value                  geometry</span></span><br><span class="line"><span class="comment">## 1  客栈    85 POINT (111.5923 25.19013)</span></span><br><span class="line"><span class="comment">## 2  酒店    82 POINT (111.5675 25.18018)</span></span><br></pre></td></tr></table></figure><p>这样我们就将这两个位置对应位置信息以及不同的描述信息组合在了一起。</p><p>还有一种格式是 GeoJSON，基于 JSON 的 Feature 输出格式，它便于被JavaScript 等脚本语言处理，OpenLayers 等地理库便是采用 GeoJSON格式。</p><h1 id="uber-的全球-h3-体系">4. Uber 的全球 H3 体系</h1><p><a href="https://github.com/uber/h3">H3</a> 是 Uber开源的一个地理空间索引系统，它可以将地球表面分成一系列六边形的网格，并对每个六边形进行编码，从而实现对地球表面的高效索引和查询。H3的设计目标是提供一种高效、可扩展、灵活的地理空间索引方案。</p><figure><img src="http://eng.uber.com/wp-content/uploads/2018/06/image12.png"alt="H3 将地球切分成了一个个的六边形，可以用于更精确的分析任务。" /><figcaption aria-hidden="true">H3将地球切分成了一个个的六边形，可以用于更精确的分析任务。</figcaption></figure><p>H3的六边形网格是根据一定的分辨率级别进行划分的，分辨率级别越高，网格越小，精度越高。H3支持 16个不同的分辨率级别，从全球范围到具体的街区和建筑物等级别都可以进行索引。每个六边形都有一个唯一的H3 编码，可以用于快速查找和比较不同的地理位置。每个六边形大致覆盖 7个子六边形，也就是说子六边形面积大约是父六边形的1/7。以下的示例是根据前文中提供的两个点返回的 resolution 为 8、9、15六边形区块的索引。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>h3jsr<span class="punctuation">)</span></span><br><span class="line">d1 <span class="operator">&lt;-</span> df<span class="operator">$</span>geometry <span class="operator">|&gt;</span> point_to_cell<span class="punctuation">(</span>res <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;88403532cdfffff&quot; &quot;884035ad37fffff&quot;</span></span><br><span class="line">d2 <span class="operator">&lt;-</span> df<span class="operator">$</span>geometry <span class="operator">|&gt;</span> point_to_cell<span class="punctuation">(</span>res <span class="operator">=</span> <span class="number">9</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;89403532cdbffff&quot; &quot;894035ad36fffff&quot;</span></span><br><span class="line">d3 <span class="operator">&lt;-</span> df<span class="operator">$</span>geometry <span class="operator">|&gt;</span> point_to_cell<span class="punctuation">(</span>res <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;8f403532cd91666&quot; &quot;8f4035ad36f1433&quot;</span></span><br><span class="line">grid_distance<span class="punctuation">(</span>d3<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> d3<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="comment"># cell 间距离</span></span><br><span class="line"><span class="comment">## [1] 25</span></span><br><span class="line">dp_9 <span class="operator">&lt;-</span> grid_path<span class="punctuation">(</span>d2<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> d2<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="comment"># cell 间的路径</span></span><br><span class="line"><span class="comment">## [1] &quot;89403532cdbffff&quot; &quot;89403532cc3ffff&quot; &quot;89403532cc7ffff&quot; &quot;89403532c8bffff&quot;</span></span><br><span class="line"><span class="comment">## [5] &quot;89403532c8fffff&quot; &quot;89403532cbbffff&quot; &quot;89403532ca3ffff&quot; &quot;89403532cb7ffff&quot;</span></span><br><span class="line"><span class="comment">## [9] &quot;894035ad36bffff&quot; &quot;894035ad36fffff&quot;</span></span><br></pre></td></tr></table></figure><p>H3广泛应用于各种地理信息系统，如共享经济、交通运输、城市规划等领域。例如，在Uber 的出行服务中，利用 H3快速计算乘客和司机之间的距离和路线，辅以车乘匹配算法，提高乘客出行效率。以下代码的意思是将前文提到的点转化为resolution 为 8 和 9 的 H3 cell，并找到 9 级 H3 cell对应的最短路径。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">df_h3_8 <span class="operator">&lt;-</span> df<span class="operator">$</span>geometry <span class="operator">|&gt;</span> point_to_cell<span class="punctuation">(</span>res <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> cell_to_polygon<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">df_h3_8</span><br><span class="line"><span class="comment">## Geometry set for 2 features </span></span><br><span class="line"><span class="comment">## Geometry type: POLYGON</span></span><br><span class="line"><span class="comment">## Dimension:     XY</span></span><br><span class="line"><span class="comment">## Bounding box:  xmin: 111.564 ymin: 25.17322 xmax: 111.5936 ymax: 25.19341</span></span><br><span class="line"><span class="comment">## Geodetic CRS:  WGS 84</span></span><br><span class="line"><span class="comment">## POLYGON ((111.5929 25.18562, 111.5936 25.19029,...</span></span><br><span class="line"><span class="comment">## POLYGON ((111.573 25.17477, 111.5737 25.17943, ...</span></span><br><span class="line">df_h3_9 <span class="operator">&lt;-</span> df<span class="operator">$</span>geometry <span class="operator">|&gt;</span> point_to_cell<span class="punctuation">(</span>res <span class="operator">=</span> <span class="number">9</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> cell_to_polygon<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">dp_path_9 <span class="operator">&lt;-</span> dp_9 <span class="operator">|&gt;</span> cell_to_polygon<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> df_h3_8<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> df_h3_9<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> df<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> dp_path_9<span class="punctuation">,</span> alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> fill <span class="operator">=</span> <span class="string">&#x27;blue&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_viridis_d<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><figure><img src="/upload/pic/h3-1.png"alt="将前文中两个点对应为 resolution 为 8 和 9 的 H3 cell和最短路径" /><figcaption aria-hidden="true">将前文中两个点对应为 resolution 为 8 和 9的 H3 cell和最短路径</figcaption></figure><p>H3最大的好处是将全球所有的位置以不重不漏的方式进行了重组，极大的方便了我们对于空间中点（比如人、车、事件等）的后续分析。</p><h1 id="空间拓扑关系">5. 空间拓扑关系</h1><p>已知两个几何对象A，B，看他们之间的关系：比如一个点是不是在一个面里，面和另一个面是不是重叠？……这些说的就是空间拓扑关系，常用的拓扑关系有这些：</p><ul><li>Intersects</li><li>Disjoint</li><li>Contains</li><li>Within</li><li>Equal</li><li>Overlap</li><li>Touch</li><li>Cross</li></ul><p>客官如果有兴趣可以参考“<ahref="https://en.wikipedia.org/wiki/DE-9IM">九交模型（DE-9IM）</a>”，这套拓扑模型有更加科学和严格的定义。</p><p>在实际项目中 Contains 这个关系用的最多，拿一个例子说明：有 2个车站（定义为：前文提到的 df 是站点的中心，半径为 450米的圆），判断每个车站内有几辆车。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 随机生成 10 个车辆位置</span></span><br><span class="line">n <span class="operator">&lt;-</span> 10</span><br><span class="line">l1 <span class="operator">&lt;-</span> runif<span class="punctuation">(</span>n<span class="punctuation">,</span> <span class="built_in">min</span><span class="punctuation">(</span>lng<span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">max</span><span class="punctuation">(</span>lng<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">l2 <span class="operator">&lt;-</span> runif<span class="punctuation">(</span>n<span class="punctuation">,</span> <span class="built_in">min</span><span class="punctuation">(</span>lat<span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">max</span><span class="punctuation">(</span>lat<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pts <span class="operator">&lt;-</span> st_as_sf<span class="punctuation">(</span>x <span class="operator">=</span> data.frame<span class="punctuation">(</span>lon <span class="operator">=</span> l1<span class="punctuation">,</span> lat <span class="operator">=</span> l2<span class="punctuation">)</span><span class="punctuation">,</span>                         </span><br><span class="line">           coords <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lon&quot;</span><span class="punctuation">,</span> <span class="string">&quot;lat&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           crs <span class="operator">=</span> projcrs<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">df_circle <span class="operator">&lt;-</span> st_buffer<span class="punctuation">(</span>df<span class="punctuation">,</span> <span class="number">450</span><span class="punctuation">)</span> <span class="comment"># 以 df 为圆心画半径为 450 米的圆</span></span><br><span class="line">st_contains<span class="punctuation">(</span>df_circle<span class="punctuation">,</span> pts<span class="punctuation">,</span> sparse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span> <span class="comment"># 是否重合</span></span><br><span class="line"><span class="comment">##       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10]</span></span><br><span class="line"><span class="comment">## [1,] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE</span></span><br><span class="line"><span class="comment">## [2,] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> df_circle<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> pts<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><figure><img src="/upload/pic/h3-2.png"alt="可以看到 10 辆车只有 1 辆车在站内" /><figcaption aria-hidden="true">可以看到 10 辆车只有 1辆车在站内</figcaption></figure><p>这里有一个细节，我们做空间拓扑的包含判断，数据量少的话性能还OK，但数据量一旦上来，会出现巨大的笛卡尔积，性能会出现指数级下降。这个问题在<strong>sf</strong>包中已经被考虑，通过构建空间索引，计算耗时基本是线性的，细节可以参考<ahref="https://r-spatial.org/r/2017/06/22/spatial-index.html">这里</a>。另外，其他时空工具也同样考虑了这个性能问题，这也是为什么空间统计是独一份存在。</p><p>再来个例子：因为业务考虑，其中一个车站要更大（具体是和一个三角形合并），再判断车在不在这两个车站。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 假如我们要增加一个三角形 polygon</span></span><br><span class="line">s_list <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>rbind<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">111.577</span><span class="punctuation">,</span><span class="number">25.177</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">111.563</span><span class="punctuation">,</span><span class="number">25.183</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">111.581</span><span class="punctuation">,</span><span class="number">25.185</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">111.577</span><span class="punctuation">,</span><span class="number">25.177</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">polygon_s <span class="operator">&lt;-</span> st_polygon<span class="punctuation">(</span>s_list<span class="punctuation">)</span> <span class="operator">|&gt;</span> st_sfc<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">st_crs<span class="punctuation">(</span>polygon_s<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="number">4326</span></span><br><span class="line"></span><br><span class="line">polygon_u <span class="operator">&lt;-</span> st_union<span class="punctuation">(</span>polygon_s<span class="punctuation">,</span> df_circle<span class="punctuation">)</span> <span class="comment"># 合并polygon</span></span><br><span class="line">ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> polygon_u<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> pts<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">st_contains<span class="punctuation">(</span>polygon_u<span class="punctuation">,</span> pts<span class="punctuation">,</span> sparse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##      [,1] [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10]</span></span><br><span class="line"><span class="comment">## [1,] TRUE TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE</span></span><br><span class="line"><span class="comment">## [2,] TRUE TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span><br></pre></td></tr></table></figure><figure><img src="/upload/pic/h3-3.png"alt="站点的形状发生变化，生成的 10 辆车，有 3 辆车在站内" /><figcaption aria-hidden="true">站点的形状发生变化，生成的 10 辆车，有 3辆车在站内</figcaption></figure><h1 id="平面可视化">6. 平面可视化</h1><p>前面的小例子都是在地理坐标系（Geographic coordinatesystem）下做的说明。如果我们需要和实际地图做联动的话，就需要从地理坐标系的三维投影到电脑屏幕的二维上，这时需要使用投影坐标系（Projectedcoordinatesystems），常用的是墨卡托投影（Mercator）。需要注意的是，墨卡托投影纬度越高，放大效应越厉害。下图是墨卡托投影下每个国家的大小和实际大小的差别：</p><p><img src="/upload/pic/Worlds_animate.gif" /></p><p>墨卡托投影的线型比例尺在图中任意一点周围都保持不变，从而可以保持大陆轮廓投影后的角度和形状不变，非常适合做二维平面可视化。墨卡托投影对应的EPSG 注册码为 3857。目前主要是各大互联网地图公司以它为基准，例如 Google地图，Microsoft 地图。</p><p>假设我们希望绘制一个点，这个点是全国最贵农田的坐标（lng=116.331415,lat=39.965217，猜猜是哪）。使用百度坐标在 leaflet 中做展示，需要配置好EPSG 相关的参数和百度自己的地图瓦片，代码见下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>leaflet<span class="punctuation">)</span></span><br><span class="line">epsgBaidu <span class="operator">&lt;-</span> leafletCRS<span class="punctuation">(</span></span><br><span class="line">  crsClass <span class="operator">=</span> <span class="string">&quot;L.Proj.CRS&quot;</span><span class="punctuation">,</span> </span><br><span class="line">  code <span class="operator">=</span> <span class="string">&quot;EPSG:3857&quot;</span><span class="punctuation">,</span></span><br><span class="line">  proj4def <span class="operator">=</span> <span class="string">&#x27;+proj=merc +a=6378206 +b=6356584.314245179 +lat_ts=0.0 +lon_0=0.0 +x_0=0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  resolutions <span class="operator">=</span> <span class="number">2</span><span class="operator">^</span><span class="punctuation">(</span><span class="number">18</span><span class="operator">:</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  origin <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  bounds <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span><span class="number">20037508.342789244</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">20037508.342789244</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最新的百度地图瓦片</span></span><br><span class="line">newBaiduTileLayerConf <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">  tile_url <span class="operator">=</span> <span class="string">&quot;https://maponline&#123;s&#125;.bdimg.com/tile/?qt=vtile&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;&amp;styles=pl&amp;scaler=4&quot;</span><span class="punctuation">,</span></span><br><span class="line">  subdomains<span class="operator">=</span><span class="string">&#x27;0123&#x27;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">baseBaiduMap <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>...<span class="punctuation">,</span> layerConfig <span class="operator">=</span> newBaiduTileLayerConf<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  leaflet<span class="punctuation">(</span>...<span class="punctuation">,</span> options <span class="operator">=</span> leafletOptions<span class="punctuation">(</span>crs <span class="operator">=</span> epsgBaidu<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    addTiles<span class="punctuation">(</span>urlTemplate <span class="operator">=</span> layerConfig<span class="operator">$</span>tile_url<span class="punctuation">,</span></span><br><span class="line">             options <span class="operator">=</span> tileOptions<span class="punctuation">(</span>tms <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> subdomains<span class="operator">=</span>layerConfig<span class="operator">$</span>subdomains<span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">m <span class="operator">&lt;-</span> baseBaiduMap<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  addMarkers<span class="punctuation">(</span>lng<span class="operator">=</span><span class="number">116.331415</span><span class="punctuation">,</span> lat<span class="operator">=</span><span class="number">39.965217</span><span class="punctuation">,</span> popup<span class="operator">=</span><span class="string">&quot;中国最贵的一块农田&quot;</span><span class="punctuation">)</span></span><br><span class="line">m</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/upload/pic/weigongcun.png" /></p><h1 id="工具和解决方案">7. 工具和解决方案</h1><p>前面简要的介绍了和时空相关的一些基础知识，利用 R作为工具做了一些演示。实际上时空数据包含了至少存储、计算、可视化、模型四部分。如果想省心，可以转向最成熟的商业软件ArcGIS，如果工作只是涉及其中的一部分，也有不同的开源的工具可以使用，成体系的有Apache 协议下的 GeoMesa、Sedona（支持分布式，个人比较推荐），下图是Sedona 的系统架构图：</p><p><imgsrc="https://sedona.apache.org/1.4.1/image/architecture.svg" /></p><p>如果工作只是一部分涉及的话，可以单独看解决方案：</p><ul><li>存储：PostGIS、redis</li><li>计算：<a href="https://github.com/locationtech/jts">JTS</a>、<ahref="https://trac.osgeo.org/geos">GEOS</a>、R(wrapper)、Python(wrapper)</li><li>可视化：一般都是 JS 框架，如 <ahref="https://leafletjs.com/index.html">Leaflet</a>(乌克兰作者，愿战争远离我们每个人)、<ahref="https://deck.gl">deck.gl</a> 等</li><li>模型：建议先用 R、Python跑通，这个体系太庞大，看如果有空我再单独写一篇。</li></ul><h1 id="回到开始的问题">8. 回到开始的问题</h1><p>基于以上获得地球上任意物体的坐标的讨论，可以推断地球人没法给三体人发送自己的坐标，大刘的这个设定存在问题。</p><p>理由如下：</p><ol type="1"><li>宇宙中地球的位置需要有一个参照系，这个参照系显然需要“三体人”给我们，这样我们才能给出”合理“的位置数据（参考火星坐标系现象）。</li><li>要计算地球的位置，需要有若干个发射源不停地广播自己的位置，地球进行接收（参考GPS原理）。地球人显然不知道这个广播源在哪里，从能量损耗角度讲，除非人类知道三体人的方向，朝着那个方向发射过去，才有可能接收到表示位置的能量。</li><li>以及通讯的文字解码也是个问题。</li></ol><p>如果三体人获得了地球的坐标，那么大概率会使用空间 H3的类似技术快速锁定我们从属的区域（空间检索），甚至做一些空间拓扑关系的运算（从属区域历史上还有没有报告坐标的生命体，有几个？）。最后通过类似墨卡托投影的技术，把地球投影在星图上。</p><p>要解决这些问题必须要说明白宇宙的中心在哪里，这样后面就可以一步一步解决了。那宇宙的中心在哪里呢？两脚兽有个说法——宇宙的中心在铁岭。</p><p>一本正经地胡说八道完毕。</p><p>参考文献：</p><ul><li><ahref="https://zh.wikipedia.org/zh-hans/%E5%85%A8%E7%90%83%E5%AE%9A%E4%BD%8D%E7%B3%BB%E7%BB%9F">全球定位系统维基百科</a></li><li><a href="https://www.gps.gov/">GPS 官网</a></li><li><ahref="https://en.wikipedia.org/wiki/Mercator_projection">墨卡托投影维基百科（英文）</a></li><li><a href="https://e7868a.com/gis-coordinate-project">GIS基础知识 -坐标系、投影、EPSG:4326、EPSG:3857</a></li><li><a href="https://www.uber.com/en-KR/blog/h3/">H3: Uber’s HexagonalHierarchical Spatial Index</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;叶文洁是第一个通过太阳向宇宙发出了信号的地球人，从而暴露了地球在茫茫宇宙中的坐标，成为了三体人进攻和侵略地球的开始。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;《三体》小说贡献了太多的经典桥段，“不要回答，不要回答，不要回答”的黑暗丛林法则也让人印象深刻。不过，我们较个真，从科学的角度聊聊需要具备怎样的条件，才能把地球的坐标发出去。为了类比，我们小处着眼，先理解一下在地球上的坐标是咋出来的？&lt;/p&gt;
&lt;h1 id=&quot;坐标系&quot;&gt;1. 坐标系&lt;/h1&gt;
&lt;p&gt;世界大地测量系统（World Geodetic System,
WGS）是一种用于地图学、大地测量学和导航（包括全球定位系统）的大地测量系统标准。WGS
包含一套地球的标准经纬坐标系、一个用于计算原始海拔数据的参考椭球体，和一套用以定义海平面高度的引力等势面数据。&lt;/p&gt;
&lt;p&gt;地球的形状不是完美的球形。因此，当我们试图近似地球的形状时，需要一个更好的模型。这个模型就是
WGS84
坐标系：它的坐标中心点为地球质心，采用一个十分近似于地球自然形状的参考椭球体，作为描述和推算地面点位置和相互关系的基准面。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/upload/pic/planet-earth.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;有了这个椭球体，地球上任意一个点就可以在这个体系中有唯一投影。这个投影一般使用经度和纬度两个数据，表达该点的位置（也可以有高度）。&lt;/p&gt;
&lt;p&gt;WGS84 是世界上第一个统一的地心坐标系（最后修订于 2004
年），因此也被称为大地坐标系、原始坐标系。不同的地区地理信息差别较大（海拔、地表趋势等），为了更精确的表达信息，各地使用的参考椭球体（或参数）不同。欧洲石油调查组织（EPSG）的成员在
1985 年发起了一个介于1024 和 32767 之间的 EPSG
注册表，这个注册表包含了大地基准面、空间参考系统、地球椭球体、坐标变换和相关测量单位等信息。&lt;/p&gt;</summary>
    
    
    
    <category term="数据思维" scheme="http://bjt.name/categories/%E6%95%B0%E6%8D%AE%E6%80%9D%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>合成双重差分法</title>
    <link href="http://bjt.name/2023/05/20/synthetic-did.html"/>
    <id>http://bjt.name/2023/05/20/synthetic-did.html</id>
    <published>2023-05-19T16:00:00.000Z</published>
    <updated>2025-05-04T09:16:21.780Z</updated>
    
    <content type="html"><![CDATA[<h1 id="研究背景">1. 研究背景</h1><p>1988 年 11 月，California 发起了一项名为”99号提案“的选民倡议，该提案是美国第一个现代大规模烟草控制项目（次年 1月正式生效）。在该法案的有两项主要内容：</p><ol type="1"><li>California 的每包香烟香烟的消费税（cigarette excise tax）提高了 25美分；</li><li>法案的所得收入专项用于控烟的教育与媒体宣传。</li></ol><p>P.S. California 香烟消费税现在是每包 87美分，为美国最高的州之一。</p><p>该法案在后续引发了一系列关于室内清洁空气的地方立法。那问题来了：</p><blockquote><p>在 California该项法案的实施，对烟草控制是积极的还是消极的？影响有多大？</p></blockquote><span id="more"></span><h1 id="数据情况">2. 数据情况</h1><p>美国各州从 1970 年开始有完整的香烟消费的数据，随着健康理念的深入，到2000 年大部分州也实施了禁烟措施。因此该案例的观察周期是从 1970 年至 2000年之间。出于研究准确性的考虑，删除了部分州的数据：</p><ul><li>期内采用其他一些大规模烟草控制计划的州（马萨诸塞州、亚利桑那州、俄勒冈州和佛罗里达州）</li><li>在 1989 至 2000 年期间将州烟税提高 50美分或更高的州（阿拉斯加、夏威夷、马里兰，密歇根、新泽西、纽约、华盛顿、哥伦比亚特区）</li></ul><p>最后样本池中剩下 38个州，其他字包含了年份（Year），人均消费卷烟数（PacksPerCapita）。数据大概长这个样子：</p><table><thead><tr class="header"><th style="text-align: left;">State</th><th style="text-align: right;">Year</th><th style="text-align: right;">PacksPerCapita</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">Alabama</td><td style="text-align: right;">1970</td><td style="text-align: right;">89.8</td></tr><tr class="even"><td style="text-align: left;">Arkansas</td><td style="text-align: right;">1970</td><td style="text-align: right;">100.3</td></tr><tr class="odd"><td style="text-align: left;">Colorado</td><td style="text-align: right;">1970</td><td style="text-align: right;">124.8</td></tr><tr class="even"><td style="text-align: left;">Connecticut</td><td style="text-align: right;">1970</td><td style="text-align: right;">120.0</td></tr><tr class="odd"><td style="text-align: left;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td></tr><tr class="even"><td style="text-align: left;">West Virginia</td><td style="text-align: right;">2000</td><td style="text-align: right;">107.9</td></tr><tr class="odd"><td style="text-align: left;">Wisconsin</td><td style="text-align: right;">2000</td><td style="text-align: right;">80.1</td></tr><tr class="even"><td style="text-align: left;">Wyoming</td><td style="text-align: right;">2000</td><td style="text-align: right;">90.5</td></tr><tr class="odd"><td style="text-align: left;">California</td><td style="text-align: right;">2000</td><td style="text-align: right;">41.6</td></tr></tbody></table><p>先用最简化的思路来看 99 法案是否有效。</p><h1 id="双重差分-did">3. 双重差分 (DID)</h1><p>双重差分（difference indifferences）是一种常见的计量经济学方法，用于评估政策或干预措施的影响。它的基本思想是对比实验组和对照组在政策实施前后的差异，以确定政策的影响。</p><p>California 控烟的这个案例中，DID 方法可以通过以下步骤进行：</p><ol type="1"><li>确定实验组（加州）和对照组（其他州）；</li><li>确定政策实施的时间节点（1970-1988 vs 1989-2000）；</li><li>对比政策实施前后实验组和对照组之间的差异（第 1 次差异）；</li><li>对比政策实施前后实验组内部和对照组内部之间的差异（第 2次差异）；</li><li>比较第 3 步和第 4步的差异（所以叫做双重差分），以确定政策的影响。</li></ol><p>DID方法的优点是可以控制时间不变的因素，从而更准确地评估政策的影响。以上思想我们落在实际数据上：</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: left;">时间段</th><th style="text-align: left;">人均消费卷烟数</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">加州</td><td style="text-align: left;">1970-1988</td><td style="text-align: left;">116.2</td></tr><tr class="even"><td style="text-align: left;">加州</td><td style="text-align: left;">1989-2000</td><td style="text-align: left;">60.3</td></tr><tr class="odd"><td style="text-align: left;">其他州</td><td style="text-align: left;">1970-1988</td><td style="text-align: left;">130.6</td></tr><tr class="even"><td style="text-align: left;">其他州</td><td style="text-align: left;">1989-2000</td><td style="text-align: left;">102.1</td></tr></tbody></table><p>结论是：加州从 116.2 下降到 60.3，其他州从 130.6 下降到102.1。加州的"对比降幅"是要高于其他州的，因此这项政策是有效果的。</p><h1 id="合成双重差分-sdid-是什么">4. 合成双重差分 SDID 是什么？</h1><p>Synthetic difference in differences(SDID)是一种利用合成控制组的方法来评估政策干预效果的分析技术。其基本原理是将政策实施地区的观测结果与一个合成控制组进行比较，以便更准确地衡量政策效果。</p><p>SDID 方法的基本步骤如下：</p><ol type="1"><li>选择一个与政策实施地区在政策实施前相似的合成控制组</li><li>使用控制组的数据建立预测模型来估计政策实施地区在政策实施前的预期结果</li><li>然后比较政策实施地区的观测结果与合成控制组的预测结果，以便评估政策干预效果。</li></ol><p>SDID方法可以更准确地评估政策干预效果，因为它可以控制其他可能影响结果的因素，并且可以更好地匹配政策实施地区和合成控制组的特征。</p><p>以下是部分城市和部分年份的示例：</p><table><colgroup><col style="width: 7%" /><col style="width: 12%" /><col style="width: 13%" /><col style="width: 13%" /><col style="width: 18%" /><col style="width: 13%" /><col style="width: 12%" /><col style="width: 9%" /></colgroup><thead><tr class="header"><th style="text-align: right;">Year</th><th style="text-align: right;">Alabama</th><th style="text-align: right;">Arkansas</th><th style="text-align: right;">Colorado</th><th style="text-align: right;">Connecticut</th><th style="text-align: right;">Delaware</th><th style="text-align: right;">Georgia</th><th style="text-align: right;">Idaho</th></tr></thead><tbody><tr class="odd"><td style="text-align: right;">1970</td><td style="text-align: right;">89.8</td><td style="text-align: right;">100.3</td><td style="text-align: right;">124.8</td><td style="text-align: right;">120.0</td><td style="text-align: right;">155.0</td><td style="text-align: right;">109.9</td><td style="text-align: right;">102.4</td></tr><tr class="even"><td style="text-align: right;">1971</td><td style="text-align: right;">95.4</td><td style="text-align: right;">104.1</td><td style="text-align: right;">125.5</td><td style="text-align: right;">117.6</td><td style="text-align: right;">161.1</td><td style="text-align: right;">115.7</td><td style="text-align: right;">108.5</td></tr><tr class="odd"><td style="text-align: right;">1972</td><td style="text-align: right;">101.1</td><td style="text-align: right;">103.9</td><td style="text-align: right;">134.3</td><td style="text-align: right;">110.8</td><td style="text-align: right;">156.3</td><td style="text-align: right;">117.0</td><td style="text-align: right;">126.1</td></tr><tr class="even"><td style="text-align: right;">1973</td><td style="text-align: right;">102.9</td><td style="text-align: right;">108.0</td><td style="text-align: right;">137.9</td><td style="text-align: right;">109.3</td><td style="text-align: right;">154.7</td><td style="text-align: right;">119.8</td><td style="text-align: right;">121.8</td></tr><tr class="odd"><td style="text-align: right;">1974</td><td style="text-align: right;">108.2</td><td style="text-align: right;">109.7</td><td style="text-align: right;">132.8</td><td style="text-align: right;">112.4</td><td style="text-align: right;">151.3</td><td style="text-align: right;">123.7</td><td style="text-align: right;">125.6</td></tr><tr class="even"><td style="text-align: right;">1975</td><td style="text-align: right;">111.7</td><td style="text-align: right;">114.8</td><td style="text-align: right;">131.0</td><td style="text-align: right;">110.2</td><td style="text-align: right;">147.6</td><td style="text-align: right;">122.9</td><td style="text-align: right;">123.3</td></tr></tbody></table><p>我们需要构建一个 1989 年之后没有受到 99 法案影响的California，有一个非常容易想到的思路就是使用 1989 年之前的其他城市对California 进行<strong>拟合</strong>，求出来的模型应用在 1989年之后，即获得了一个的合成 California</p><p>首先看一下拟合出来的模型什么样？</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">系数</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">(Intercept)</td><td style="text-align: right;">6.59</td></tr><tr class="even"><td style="text-align: left;">Colorado</td><td style="text-align: right;">0.05</td></tr><tr class="odd"><td style="text-align: left;">Connecticut</td><td style="text-align: right;">0.17</td></tr><tr class="even"><td style="text-align: left;">Idaho</td><td style="text-align: right;">0.04</td></tr><tr class="odd"><td style="text-align: left;">Illinois</td><td style="text-align: right;">0.16</td></tr><tr class="even"><td style="text-align: left;">Montana</td><td style="text-align: right;">0.14</td></tr><tr class="odd"><td style="text-align: left;">Nebraska</td><td style="text-align: right;">0.14</td></tr><tr class="even"><td style="text-align: left;">Nevada</td><td style="text-align: right;">0.17</td></tr><tr class="odd"><td style="text-align: left;">New Hampshire</td><td style="text-align: right;">0.01</td></tr><tr class="even"><td style="text-align: left;">Tennessee</td><td style="text-align: right;">-0.24</td></tr><tr class="odd"><td style="text-align: left;">Utah</td><td style="text-align: right;">0.22</td></tr><tr class="even"><td style="text-align: left;">West Virginia</td><td style="text-align: right;">0.07</td></tr></tbody></table><p>也就是说 California 的人均消费卷烟数可以这样表示：</p><p><span class="math display">\[C_{California} = 6.59 + 0.05C_{Colorado} + 0.17C_{Connecticut} +0.04C_{Idaho} + \cdots + 0.07C_{West Virginia}\]</span></p><p>这个公式合成了一个实际上并不存在的 California，我们假设</p><ol type="1"><li>其他州在后续的时间没有大规模的变化；</li><li>1988 年之前 California 可以被其他州的线性组合替代，1989年之后线性关系依然存在。</li></ol><p>这样我们就可以通过真实发生的 California 数据，对比这个合成 California数据，来观察政策带来的影响：</p><p><img src="/upload/pic/sdid.png" /></p><p>根据以上构建的合成双重差分法得到的分析结果看，加州实施的烟草控制计划的影响就非常显然了。在第99 号提案之后：</p><ul><li>California 每年的人均消费卷烟数逐年下降，且呈现扩大趋势；</li><li>在 2000 年，California 年人均消费卷烟数比没有第 99号提案时的情况低了约 24 包。</li></ul><h1 id="其他问题的讨论">5. 其他问题的讨论</h1><p>该方法很容易将线性模型升级为非线性模型，从笔者的实际业务操作上看，该方法的稳健性和解释性可以到大幅提升。</p><h1 id="附数据和代码">6. 附数据和代码</h1><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#| message: false</span></span><br><span class="line"><span class="comment">## DID 部分</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>knitr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">prop99_tr <span class="operator">&lt;-</span> read.csv<span class="punctuation">(</span><span class="string">&#x27;https://bjt.name/upload/csv/california_prop99.csv&#x27;</span><span class="punctuation">)</span></span><br><span class="line">prop99_tr<span class="operator">$</span>treated<span class="punctuation">[</span>prop99_tr<span class="operator">$</span>Year <span class="operator">&gt;=</span> <span class="number">1989</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="string">&#x27;1989-2000&#x27;</span></span><br><span class="line">prop99_tr<span class="operator">$</span>treated<span class="punctuation">[</span>prop99_tr<span class="operator">$</span>Year <span class="operator">&lt;</span> <span class="number">1989</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="string">&#x27;1970-1988&#x27;</span></span><br><span class="line">s_prop99_tr <span class="operator">&lt;-</span> prop99_tr <span class="operator">|&gt;</span> </span><br><span class="line">  group_by<span class="punctuation">(</span>State<span class="punctuation">,</span> treated<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  summarise<span class="punctuation">(</span>ave <span class="operator">=</span> mean<span class="punctuation">(</span>PacksPerCapita<span class="punctuation">)</span><span class="punctuation">,</span> .groups <span class="operator">=</span> <span class="string">&#x27;keep&#x27;</span><span class="punctuation">)</span></span><br><span class="line">s_prop99_tr <span class="operator">|&gt;</span> mutate<span class="punctuation">(</span></span><br><span class="line">  New_class <span class="operator">=</span> ifelse<span class="punctuation">(</span>State <span class="operator">==</span> <span class="string">&#x27;California&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;california&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;else&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  group_by<span class="punctuation">(</span>New_class<span class="punctuation">,</span> treated<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  summarise<span class="punctuation">(</span>v <span class="operator">=</span> mean<span class="punctuation">(</span>ave<span class="punctuation">)</span><span class="punctuation">,</span> .groups <span class="operator">=</span> <span class="string">&#x27;keep&#x27;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  kable<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data_wide_all <span class="operator">&lt;-</span> prop99_tr <span class="operator">|&gt;</span> pivot_wider<span class="punctuation">(</span></span><br><span class="line">    id_cols <span class="operator">=</span> <span class="string">&quot;Year&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    names_from <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    values_from <span class="operator">=</span> <span class="string">&quot;PacksPerCapita&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 拟合 SDID 的线性模型</span></span><br><span class="line">data_wide <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>data_wide_all<span class="punctuation">,</span> Year <span class="operator">&lt;</span> <span class="number">1989</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>glmnet<span class="punctuation">)</span></span><br><span class="line">Y <span class="operator">=</span> data_wide<span class="operator">$</span>California</span><br><span class="line">X <span class="operator">=</span> select<span class="punctuation">(</span>data_wide<span class="punctuation">,</span><span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Year&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;California&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> as.matrix<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">model_glmnet <span class="operator">&lt;-</span> cv.glmnet<span class="punctuation">(</span>y <span class="operator">=</span> Y<span class="punctuation">,</span> x <span class="operator">=</span> X <span class="punctuation">,</span> family <span class="operator">=</span> <span class="string">&#x27;gaussian&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># model_glmnet</span></span><br><span class="line">coef<span class="punctuation">(</span>model_glmnet<span class="punctuation">,</span> s <span class="operator">=</span> <span class="string">&quot;lambda.min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="built_in">round</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">X_all <span class="operator">&lt;-</span></span><br><span class="line">  select<span class="punctuation">(</span>data_wide_all<span class="punctuation">,</span><span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Year&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;California&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> as.matrix<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">DID_data <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">  Year <span class="operator">=</span> data_wide_all<span class="operator">$</span>Year<span class="punctuation">,</span></span><br><span class="line">  California <span class="operator">=</span> data_wide_all<span class="operator">$</span>California<span class="punctuation">,</span></span><br><span class="line">  Synthetic <span class="operator">=</span> predict<span class="punctuation">(</span></span><br><span class="line">    model_glmnet<span class="punctuation">,</span> newx <span class="operator">=</span> X_all<span class="punctuation">,</span> s <span class="operator">=</span> <span class="number">0.1089</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">|&gt;</span> gather<span class="punctuation">(</span><span class="string">&#x27;Type&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;PacksPerCapita&#x27;</span><span class="punctuation">,</span> <span class="operator">-</span>Year<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 绘制差异图</span></span><br><span class="line">gs <span class="operator">&lt;-</span> tribble<span class="punctuation">(</span></span><br><span class="line">  <span class="operator">~</span>start<span class="punctuation">,</span> <span class="operator">~</span>end<span class="punctuation">,</span></span><br><span class="line">  <span class="number">1970</span><span class="punctuation">,</span> <span class="number">1988</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> DID_data<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Year<span class="punctuation">,</span> y <span class="operator">=</span> PacksPerCapita<span class="punctuation">,</span> colour <span class="operator">=</span> Type<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_line<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_rect<span class="punctuation">(</span></span><br><span class="line">    data <span class="operator">=</span> gs<span class="punctuation">,</span></span><br><span class="line">    aes<span class="punctuation">(</span></span><br><span class="line">      xmin <span class="operator">=</span> start<span class="punctuation">,</span></span><br><span class="line">      xmax <span class="operator">=</span> end<span class="punctuation">,</span></span><br><span class="line">      ymin <span class="operator">=</span> <span class="operator">-</span><span class="literal">Inf</span><span class="punctuation">,</span></span><br><span class="line">      ymax <span class="operator">=</span> <span class="literal">Inf</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    fill <span class="operator">=</span> <span class="string">&#x27;purple&#x27;</span><span class="punctuation">,</span></span><br><span class="line">    alpha <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">    show.legend <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">    inherit.aes <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">   labs<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&#x27;California 在 1989 年实施的 99 号控烟法案对人均消费卷烟数的影响&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    theme_minimal<span class="punctuation">(</span>base_family <span class="operator">=</span> <span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;研究背景&quot;&gt;1. 研究背景&lt;/h1&gt;
&lt;p&gt;1988 年 11 月，California 发起了一项名为”99
号提案“的选民倡议，该提案是美国第一个现代大规模烟草控制项目（次年 1
月正式生效）。在该法案的有两项主要内容：&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;California 的每包香烟香烟的消费税（cigarette excise tax）提高了 25
美分；&lt;/li&gt;
&lt;li&gt;法案的所得收入专项用于控烟的教育与媒体宣传。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;P.S. California 香烟消费税现在是每包 87
美分，为美国最高的州之一。&lt;/p&gt;
&lt;p&gt;该法案在后续引发了一系列关于室内清洁空气的地方立法。那问题来了：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在 California
该项法案的实施，对烟草控制是积极的还是消极的？影响有多大？&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="因果推断" scheme="http://bjt.name/categories/%E5%9B%A0%E6%9E%9C%E6%8E%A8%E6%96%AD/"/>
    
    
  </entry>
  
  <entry>
    <title>混合整数规划常用方法 R 实现</title>
    <link href="http://bjt.name/2022/11/13/operational-research.html"/>
    <id>http://bjt.name/2022/11/13/operational-research.html</id>
    <published>2022-11-12T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.294Z</updated>
    
    <content type="html"><![CDATA[<p>运筹学（OperationalResearch）是一门应用于管理有组织系统的科学，最早的朴素思想在中国的古文献中多有记载，比如耳熟能详的田忌赛马的故事。运筹的一般思想是：在各项资源条件优先的情况下，如何确定一个方案，使得预期目标最优；或者为了达到预期目标，确定资源消耗最小的方案。在二次世界大战之后，组织和企业的活动规模更大，信息系统化空前完备（想象一下水晶报表的诞生多么让人兴奋），加之各类数学算法模型层出不穷，研究如何做好决策的运筹学也有了极大的发展。</p><p>运筹学方向很多，比如线性规划、非线性规划、整数规划、目标规划、动态规划、排队论、对策论等。笔者偷个懒，找一些在整数规划体系下的例子，让大家感受一下在日常企业中这些方法的应用。</p><h1 id="一个简化问题">1. 一个简化问题</h1><p>公司有 4 条生产线，每条生产线的月产量分别为 0.56, 3.11, 3.04,2.11。近期因为经济不景气，需要将月产量总和控制在 5以内，但出于总成本摊销的考虑，又要保证产出尽可能的大，那么哪几条产线需要被关闭。我们盲猜结果：3和 4需要被关闭。当然这个问题手指头可以掰过来，超过十个手指头怎么办？</p><span id="more"></span><p>我们先约定一些参数的数学表达：</p><ol type="1"><li>每条生产线的月产量为 <span class="math inline">\(w_i\)</span></li><li>产线是否开启用 <span class="math inline">\(x_i\)</span> 表示，要么是0 要么是 1</li></ol><p>那这个问题就可以用统一框架结构化表述该问题。</p><ol type="1"><li>设置决策变量 <span class="math inline">\(x_{i} \in \{0, 1\}, i =1,2,3,4\)</span></li><li>目标：最大化 <span class="math inline">\(\sum x_i w_i\)</span></li><li>约束条件：<span class="math inline">\(\sum x_i w_i \le5\)</span></li><li>求解 <span class="math inline">\(x_i\)</span></li></ol><p>我们尝试使用 R 包 <ahref="https://cran.r-project.org/package=ompr">ompr</a>来实现上述过程（Optimization Modeling Package）：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ompr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ompr.roi<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ROI.plugin.glpk<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">max_capacity <span class="operator">&lt;-</span> 5</span><br><span class="line">n <span class="operator">&lt;-</span> 4</span><br><span class="line">weights <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.56</span><span class="punctuation">,</span> <span class="number">3.11</span><span class="punctuation">,</span> <span class="number">3.04</span><span class="punctuation">,</span> <span class="number">2.11</span><span class="punctuation">)</span></span><br><span class="line">m <span class="operator">&lt;-</span> MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n<span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;binary&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>weights<span class="punctuation">[</span>i<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;max&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>weights<span class="punctuation">[</span>i<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n<span class="punctuation">)</span> <span class="operator">&lt;=</span> max_capacity<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> m</span><br><span class="line">  variable i value</span><br><span class="line"><span class="number">1</span>        x <span class="number">1</span>     <span class="number">1</span></span><br><span class="line"><span class="number">2</span>        x <span class="number">2</span>     <span class="number">1</span></span><br><span class="line"><span class="number">3</span>        x <span class="number">3</span>     <span class="number">0</span></span><br><span class="line"><span class="number">4</span>        x <span class="number">4</span>     <span class="number">0</span></span><br></pre></td></tr></table></figure><p>果然和我们猜想一样，3 和 4 需要被关闭。</p><p>P.S.</p><p>ompr这个包非常优秀，将设置决策变量、最优化目标、约束条件，以及求解四个步骤，很清晰地通过管道操作来表达。具体细节各位看官可以参考官方文档。</p><h1 id="排班">2. 排班</h1><p>假设某培训机构，周一到周日所需要的老师数为3782, 3718, 2580, 2912,4112, 7862, 7007，设为 <spanclass="math inline">\(b\)</span>，且要保证老师每周有连续两天的休息，有两个问题需要回答：</p><ol type="1"><li>机构需要准备多少老师</li><li>这些老师该如何排班</li></ol><p>首先生成所有的排班可能 <spanclass="math inline">\(A_{ij}\)</span>，表示第<spanclass="math inline">\(i\)</span>天的第 <spanclass="math inline">\(j\)</span> 个班型需要的人数，同时假设第 <spanclass="math inline">\(i\)</span> 天的工作人数为 <spanclass="math inline">\(x_{i}\)</span>，那么满足</p><p><span class="math display">\[\min z= \sum_{i} x_i \\\]</span></p><p><span class="math display">\[s.t. \sum_i\sum_j x_i A_{i,j} \le b_i\]</span></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 周一到周日所需要的分配老师数</span></span><br><span class="line">b <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">3782</span><span class="punctuation">,</span> <span class="number">3718</span><span class="punctuation">,</span> <span class="number">2580</span><span class="punctuation">,</span> <span class="number">2912</span><span class="punctuation">,</span> <span class="number">4112</span><span class="punctuation">,</span> <span class="number">7862</span><span class="punctuation">,</span> <span class="number">7007</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 老师每周需要有连续 2 天的休息</span></span><br><span class="line">A <span class="operator">&lt;-</span> matrix<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">7</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">7</span><span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  A<span class="punctuation">[</span>i<span class="punctuation">,</span> i <span class="operator">%%</span> <span class="number">7</span> <span class="operator">+</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="number">0</span>; A<span class="punctuation">[</span>i<span class="punctuation">,</span> <span class="punctuation">(</span>i <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">%%</span> <span class="number">7</span> <span class="operator">+</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="number">0</span>;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">m <span class="operator">&lt;-</span> MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>A<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">)</span> <span class="operator">&gt;=</span> b<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> m</span><br><span class="line">  variable i value</span><br><span class="line"><span class="number">1</span>        x <span class="number">1</span>   <span class="number">757</span></span><br><span class="line"><span class="number">2</span>        x <span class="number">2</span>   <span class="number">744</span></span><br><span class="line"><span class="number">3</span>        x <span class="number">3</span>   <span class="number">516</span></span><br><span class="line"><span class="number">4</span>        x <span class="number">4</span>   <span class="number">583</span></span><br><span class="line"><span class="number">5</span>        x <span class="number">5</span>   <span class="number">823</span></span><br><span class="line"><span class="number">6</span>        x <span class="number">6</span>  <span class="number">1573</span></span><br><span class="line"><span class="number">7</span>        x <span class="number">7</span>  <span class="number">1402</span></span><br></pre></td></tr></table></figure><p>排班的班型和结果如下：</p><table><thead><tr class="header"><th style="text-align: right;">周1</th><th style="text-align: right;">周2</th><th style="text-align: right;">周3</th><th style="text-align: right;">周4</th><th style="text-align: right;">周5</th><th style="text-align: right;">周6</th><th style="text-align: right;">周7</th><th style="text-align: right;">数量</th></tr></thead><tbody><tr class="odd"><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">757</td></tr><tr class="even"><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">744</td></tr><tr class="odd"><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">516</td></tr><tr class="even"><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">583</td></tr><tr class="odd"><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">823</td></tr><tr class="even"><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">1573</td></tr><tr class="odd"><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">1402</td></tr></tbody></table><p>看一下差异有多大</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> m<span class="operator">$</span>value <span class="operator">*</span> A <span class="operator">|&gt;</span> colSums<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">3785</span> <span class="number">3720</span> <span class="number">2580</span> <span class="number">2915</span> <span class="number">4115</span> <span class="number">7865</span> <span class="number">7010</span></span><br><span class="line"><span class="operator">&gt;</span> b</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">3782</span> <span class="number">3718</span> <span class="number">2580</span> <span class="number">2912</span> <span class="number">4112</span> <span class="number">7862</span> <span class="number">7007</span></span><br></pre></td></tr></table></figure><h1 id="装箱问题">3. 装箱问题</h1><p>有一堆物品长度分别为 <spanclass="math inline">\(w_i\)</span>，若干长度为 <spanclass="math inline">\(C\)</span> 的箱子（<span class="math inline">\(w_i\le C\)</span>）。问：最少需要几个箱子才能把所有物品全部装进箱子？</p><p>最坏的情况是一个箱子装一个物品，最好的情况是物品恰好可以完美的放入在箱子内，那么箱子数为<spanclass="math inline">\(\sumw_i/C\)</span>，所以说取值应该在这两个值之间。抽象一下这个问题，我们希望最小化箱子数量，设</p><ol type="1"><li><span class="math inline">\(y_i = 1\)</span>，表示第 <spanclass="math inline">\(i\)</span> 个箱子被使用</li><li><span class="math inline">\(x_{ij} = 1\)</span>，表示 第 <spanclass="math inline">\(j\)</span> 个物品被放入了第 <spanclass="math inline">\(i\)</span> 个箱子中</li></ol><p>那么优化的目标是：</p><p><span class="math display">\[\min z = \sum_{i=1}^{n} y_i\]</span> 约束条件是：</p><p><span class="math display">\[\begin{aligned}&amp;\sum_{j=1}^n w_i x_{i j} \leq C y_i, \quad i=1,2, \ldots, n\\&amp;\sum_{i=1}^n x_{i j}=1, \quad j=1,2, \ldots, n\\&amp;y_i \in\{0,1\}, \quad i=1,2, \ldots, n\\&amp;x_{i j} \in\{0,1\}, \quad i, j=1,2, \ldots, n\end{aligned}\]</span> 用一个例子来说明：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">max_bins <span class="operator">&lt;-</span> 10 <span class="comment"># 箱子的最大个数</span></span><br><span class="line">bin_size <span class="operator">&lt;-</span> 3 <span class="comment"># 每个箱子的size</span></span><br><span class="line">n <span class="operator">&lt;-</span> 10 <span class="comment"># 有多少个物品</span></span><br><span class="line">weights <span class="operator">&lt;-</span> runif<span class="punctuation">(</span>n<span class="punctuation">,</span> <span class="built_in">max</span> <span class="operator">=</span> bin_size<span class="punctuation">)</span> <span class="comment"># 随机生成物品的大小，不大于 bin_size</span></span><br><span class="line"><span class="comment">## 按照上面的模型设置参数</span></span><br><span class="line">MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>y<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>max_bins<span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;binary&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span> j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>max_bins<span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n<span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;binary&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>y<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>max_bins<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>weights<span class="punctuation">[</span>j<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">,</span> j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n<span class="punctuation">)</span> <span class="operator">&lt;=</span> y<span class="punctuation">[</span>i<span class="punctuation">]</span> <span class="operator">*</span> bin_size<span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>max_bins<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span> j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>max_bins<span class="punctuation">)</span> <span class="operator">==</span> <span class="number">1</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span> j<span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  filter<span class="punctuation">(</span>value <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  arrange<span class="punctuation">(</span>i<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h1 id="指派问题">4. 指派问题</h1><p>指派的标准问题是，有 <span class="math inline">\(n\)</span> 个人和<span class="math inline">\(n\)</span> 件事，已知第 <spanclass="math inline">\(i\)</span> 个人做第 <spanclass="math inline">\(j\)</span> 个事的费用为 <spanclass="math inline">\(C_{ij}\)</span>，要求确定人和事之间的关系，使得这<span class="math inline">\(n\)</span> 件事情的总费用最小。</p><p>数学模型可以写成：</p><p><span class="math display">\[\min z=\sum\limits_{i=1}^n\sum\limits_{j=1}^n c_{ij}x_{ij}\]</span></p><p><span class="math display">\[\mathrm{s.t}\begin{cases}\sum\limits_{i=1}^n x_{ij}=1,\quad i=1,2,\cdots,n  \\\sum\limits_{j=1}^n x_{ij}=1,\quad j=1,2,\cdots,n  \\x_{ij} \in \{0,1\}, \quad i,j=1,2,\cdots,n  \end{cases}\]</span></p><p>模拟一个示例做演示：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">cost <span class="operator">&lt;-</span> rnorm<span class="punctuation">(</span><span class="number">16</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> <span class="built_in">round</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> matrix<span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line">m <span class="operator">&lt;-</span> MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;binary&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>cost<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span> j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="number">1</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span> j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="number">1</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> cost</span><br><span class="line">     <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="number">3.37</span> <span class="number">4.33</span> <span class="number">4.58</span> <span class="number">3.38</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="number">4.18</span> <span class="number">3.18</span> <span class="number">3.69</span> <span class="number">1.79</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="number">3.16</span> <span class="number">4.49</span> <span class="number">5.51</span> <span class="number">5.12</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="number">5.60</span> <span class="number">4.74</span> <span class="number">4.39</span> <span class="number">3.96</span></span><br><span class="line"><span class="operator">&gt;</span> z <span class="operator">&lt;-</span> matrix<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> z<span class="punctuation">[</span>cbind<span class="punctuation">(</span>m<span class="operator">$</span>i<span class="punctuation">,</span> m<span class="operator">$</span>j<span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> m<span class="operator">$</span>value</span><br><span class="line"><span class="operator">&gt;</span> z <span class="comment"># 人和事的分配关系</span></span><br><span class="line">     <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="最优传输问题">5. 最优传输问题</h1><p>最优传输比指派问题稍复杂一点点：假如有 6 个生产点和 8个销售点，他们之间的存在距离成本矩阵。且约束条件有：</p><ul><li>A1-A6 的产量是：60,55,51,43,41,52</li><li>B1-B8 的销量是：35,37,22,32,41,32,43,38</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">costs<span class="operator">&lt;-</span>matrix<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">6</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">2</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">9</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span> <span class="comment"># 运费矩阵</span></span><br><span class="line"></span><br><span class="line">n_row <span class="operator">&lt;-</span> nrow<span class="punctuation">(</span>costs<span class="punctuation">)</span></span><br><span class="line">n_col <span class="operator">&lt;-</span> ncol<span class="punctuation">(</span>costs<span class="punctuation">)</span></span><br><span class="line">row.rhs <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">60</span><span class="punctuation">,</span><span class="number">55</span><span class="punctuation">,</span><span class="number">51</span><span class="punctuation">,</span><span class="number">43</span><span class="punctuation">,</span><span class="number">41</span><span class="punctuation">,</span><span class="number">52</span><span class="punctuation">)</span> <span class="comment"># 产量约束向量</span></span><br><span class="line">col.rhs <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">35</span><span class="punctuation">,</span><span class="number">37</span><span class="punctuation">,</span><span class="number">22</span><span class="punctuation">,</span><span class="number">32</span><span class="punctuation">,</span><span class="number">41</span><span class="punctuation">,</span><span class="number">32</span><span class="punctuation">,</span><span class="number">43</span><span class="punctuation">,</span><span class="number">38</span><span class="punctuation">)</span> <span class="comment"># 销量约束向量</span></span><br></pre></td></tr></table></figure><p>构建传输模型，假设生产点的产量为 <spanclass="math inline">\(P_i\)</span>, 销售点的预期销量为 <spanclass="math inline">\(S_j\)</span>，生产点到销售点运费矩阵为 <spanclass="math inline">\(C_{ij}\)</span>，不考虑对于每次传输的限制，销售点的需求必须满足：</p><p><span class="math display">\[\begin{gathered}min \sum_i \sum_j C_{ij} X_{ij} \\s.t. \\\sum_{i}\sum_j X_{ij} \le P_i;i = 1,2...,M \\\sum_{i}\sum_j X_{ij} = S_j;j = 1,2,...,N \\\end{gathered}\]</span></p><p>构建混合整数规划模型：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tm <span class="operator">&lt;-</span> MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  <span class="comment"># 添加长度为 i * j 变量组  </span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_row<span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_col<span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>costs<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_row<span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_col<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_col<span class="punctuation">)</span> <span class="operator">&lt;=</span> row.rhs<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_row<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_row<span class="punctuation">)</span> <span class="operator">==</span> col.rhs<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span>n_col<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">m <span class="operator">&lt;-</span> matrix<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> n_row<span class="punctuation">,</span> n_col<span class="punctuation">)</span></span><br><span class="line">index <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>tm<span class="operator">$</span>i<span class="punctuation">,</span> tm<span class="operator">$</span>j<span class="punctuation">)</span></span><br><span class="line">m<span class="punctuation">[</span>index<span class="punctuation">]</span> <span class="operator">&lt;-</span> tm<span class="operator">$</span>value</span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> m</span><br><span class="line">     <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>   <span class="number">19</span>    <span class="number">0</span>    <span class="number">0</span>   <span class="number">41</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>   <span class="number">32</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>   <span class="number">11</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>   <span class="number">40</span>    <span class="number">0</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">5</span>    <span class="number">0</span>   <span class="number">38</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">5</span><span class="punctuation">,</span><span class="punctuation">]</span>   <span class="number">34</span>    <span class="number">7</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">6</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">0</span>    <span class="number">0</span>   <span class="number">22</span>    <span class="number">0</span>    <span class="number">0</span>   <span class="number">27</span>    <span class="number">3</span>    <span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="分货优化">6. 分货优化</h1><p>最优传输问题是一个相对简化的模型，我们将这个问题更一般化。假设有 M个大仓，N 个门店。第 <span class="math inline">\(i\)</span>个大仓的分货限额为 <spanclass="math inline">\(C_i=1,2,3,...,M\)</span>，需要将 <spanclass="math inline">\(C_i\)</span> 分配给各个门店，第 <spanclass="math inline">\(i\)</span> 个门店分得 <spanclass="math inline">\(X_{ij},i=1,2,3,...,M,j=1,2,...,N\)</span>，使得</p><p><span class="math display">\[min(OBJ)\]</span></p><p>约束条件为</p><p><span class="math display">\[\sum_{j}^{N} X_{i, j} \leq C_{i}, i=1,2, \ldots, M\]</span></p><p>这里的 OBJ是某种可以衡量分货策略好坏的函数，分货策略越好，该函数值越小。举个简单的例子，OBJ可以是该分货策略的预期缺货量，那么显然，缺货量越小，说明分货策略越好。当然，在实际生产决策中，衡量分货策略好坏往往是从多个维度来考量，诸如现货率、补货次数、补货周期等核心优化指标均要纳入考虑。</p><h2 id="传输优先级">6.1. 传输优先级</h2><p>构建最简化的模型，仅仅考虑一个约束条件，传输的优先级（该情况即为最优传输模型）。<spanclass="math inline">\(j\)</span> 个门店的库存为 0，完全达成门店要求。此时抽象的公式为：</p><p><span class="math display">\[min \sum_{i}\sum_{j} P_{ij} X_{ij}\]</span> 设门店的目标要求为 <spanclass="math inline">\(V_j\)</span>，约束条件为：</p><p><span class="math display">\[\begin{gathered}\sum_{j}^{M} X_{i, j} \leq C_{i}, i=1,2, \ldots, M \\\sum_{i}^{N} X_{i, j} = V_{j}, j=1,2, \ldots, N\end{gathered}\]</span></p><p>构建模型，及结果是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">## 大仓总量</span><br><span class="line">wh_capacity &lt;- c(100, 300)</span><br><span class="line">## 门店目标库存水平</span><br><span class="line">store_target &lt;- c(100, 80, 120)</span><br><span class="line">## 大仓优先级</span><br><span class="line">priority &lt;- matrix(c(0.9, 0.1, 0.9, 0.1, 0.05, 0.95), 2, 3)</span><br><span class="line">## 构建模型</span><br><span class="line">tm1 &lt;- MIPModel() |&gt;</span><br><span class="line">  # 添加长度为 i * j 变量组  </span><br><span class="line">  add_variable(x[i,j], i = 1:2, j = 1:3, type = &quot;integer&quot;, lb = 0) |&gt;</span><br><span class="line">  ## 设置目标函数</span><br><span class="line">  set_objective(sum_over(priority[i,j] * x[i,j], i = 1:2, j = 1:3), &quot;min&quot;) |&gt;</span><br><span class="line">  ## 增加约束</span><br><span class="line">  add_constraint(sum_over(x[i,j], j = 1:3) &lt;= wh_capacity[i], i = 1:2) |&gt;</span><br><span class="line">  add_constraint(sum_over(x[i,j], i = 1:2) == store_target[j], j = 1:3) |&gt;</span><br><span class="line">  solve_model(with_ROI(solver = &quot;glpk&quot;)) |&gt;</span><br><span class="line">  get_solution(x[i,j])</span><br><span class="line"></span><br><span class="line">&gt; tm1</span><br><span class="line">  variable i j value</span><br><span class="line">1        x 1 1     0</span><br><span class="line">4        x 2 1   100</span><br><span class="line">2        x 1 2     0</span><br><span class="line">5        x 2 2    80</span><br><span class="line">3        x 1 3   100</span><br><span class="line">6        x 2 3    20</span><br></pre></td></tr></table></figure><h2 id="考虑实际库存">6.2. 考虑实际库存</h2><p>上面的抽象模型显然太过于理想化，事实上门店显然是有库存的。</p><p>假设目标库存车辆数是 <span class="math inline">\(Tar_j \ge0\)</span>，当前库存数车辆数为 <span class="math inline">\(Inv_j \ge0\)</span>，<span class="math inline">\(X_{ij} \ge 0\)</span> 为从 <spanclass="math inline">\(i\)</span> 位置到 <spanclass="math inline">\(j\)</span> 站点的调度量，<spanclass="math inline">\(S_j \ge 0\)</span> 为站点 <spanclass="math inline">\(j\)</span>取得调度量之后的未满足量。那么则有这样的限制条件：</p><p><span class="math display">\[Inv_j + \sum_j^N X_{ij} + S_j \ge Tar_j\]</span></p><p>显然我们希望<code>未满足量</code>最小：</p><p><span class="math display">\[min \sum_j^N S_j\]</span> 也就是说我们需要的目标是两个同时优化：</p><p><span class="math display">\[\min (\sum_i^M \sum_j^N P_{ij} X_{ij} + \sum_{j} S_{j})\]</span></p><p>约束条件是：</p><p><span class="math display">\[\begin{gathered}\sum_{j} X_{ij} \leq C_{i}, i=1,2, \ldots, M \\I n v_{j}+\sum_{i} X_{ij}+S_{j} \geq Tar_{j}, j=1,2, \ldots, N\end{gathered}\]</span></p><p>这个混合整数规划问题变成了更复杂的样子：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 门店库存水平</span></span><br><span class="line">store_inv <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">50</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">,</span> <span class="number">30</span><span class="punctuation">)</span></span><br><span class="line">store_mip <span class="operator">&lt;-</span> MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>b<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&#x27;integer&#x27;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  <span class="comment">## 设置目标函数</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>priority<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">+</span> sum_over<span class="punctuation">(</span><span class="number">1000</span><span class="operator">*</span>b<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  <span class="comment">## 增加约束</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">&lt;=</span> wh_capacity<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span> store_inv<span class="punctuation">[</span>j<span class="punctuation">]</span> <span class="operator">+</span>  b<span class="punctuation">[</span>j<span class="punctuation">]</span> <span class="operator">&gt;=</span> store_target<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> store_mip</span><br><span class="line">  variable i j value</span><br><span class="line"><span class="number">1</span>        x <span class="number">1</span> <span class="number">1</span>     <span class="number">0</span></span><br><span class="line"><span class="number">4</span>        x <span class="number">2</span> <span class="number">1</span>    <span class="number">50</span></span><br><span class="line"><span class="number">2</span>        x <span class="number">1</span> <span class="number">2</span>     <span class="number">0</span></span><br><span class="line"><span class="number">5</span>        x <span class="number">2</span> <span class="number">2</span>    <span class="number">60</span></span><br><span class="line"><span class="number">3</span>        x <span class="number">1</span> <span class="number">3</span>    <span class="number">90</span></span><br><span class="line"><span class="number">6</span>        x <span class="number">2</span> <span class="number">3</span>     <span class="number">0</span></span><br></pre></td></tr></table></figure><h2 id="最小分货单元">6.3. 最小分货单元</h2><p>因为分货的车每次只能装载 6 件商品，因此我们还有一个条件：分货量必须为6 的倍数。可以考虑引入一个辅助变量 <spanclass="math inline">\(O_{ij}\)</span>，引入 mlc 之后约束条件增加</p><p><span class="math display">\[\begin{gathered}mlc \times O_{ij} = X_{ij}\\end{gathered}\]</span> 模型又发生了一些改变：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Minimum loading capacity</span></span><br><span class="line">mlc <span class="operator">&lt;-</span> 6</span><br><span class="line">store_mip <span class="operator">&lt;-</span> MIPModel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>b<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&#x27;integer&#x27;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_variable<span class="punctuation">(</span>o<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&#x27;integer&#x27;</span><span class="punctuation">,</span> lb <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  <span class="comment">## 设置目标函数</span></span><br><span class="line">  set_objective<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>priority<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">*</span> x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">+</span> sum_over<span class="punctuation">(</span>b<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;min&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  <span class="comment">## 增加约束</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">&lt;=</span> wh_capacity<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>sum_over<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span> store_inv<span class="punctuation">[</span>j<span class="punctuation">]</span> <span class="operator">+</span>  b<span class="punctuation">[</span>j<span class="punctuation">]</span> <span class="operator">&gt;=</span> store_target<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_constraint<span class="punctuation">(</span>mlc <span class="operator">*</span> o<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">==</span> x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">,</span> i <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span> j <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  solve_model<span class="punctuation">(</span>with_ROI<span class="punctuation">(</span>solver <span class="operator">=</span> <span class="string">&quot;glpk&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  get_solution<span class="punctuation">(</span>x<span class="punctuation">[</span>i<span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> store_mip</span><br><span class="line">  variable i j value</span><br><span class="line"><span class="number">1</span>        x <span class="number">1</span> <span class="number">1</span>     <span class="number">0</span></span><br><span class="line"><span class="number">4</span>        x <span class="number">2</span> <span class="number">1</span>    <span class="number">54</span></span><br><span class="line"><span class="number">2</span>        x <span class="number">1</span> <span class="number">2</span>     <span class="number">0</span></span><br><span class="line"><span class="number">5</span>        x <span class="number">2</span> <span class="number">2</span>    <span class="number">60</span></span><br><span class="line"><span class="number">3</span>        x <span class="number">1</span> <span class="number">3</span>    <span class="number">90</span></span><br><span class="line"><span class="number">6</span>        x <span class="number">2</span> <span class="number">3</span>     <span class="number">0</span></span><br></pre></td></tr></table></figure><p>当然，以上示例均为演示而构造，实际生产过程会远比这些示例复杂，有些明确需要使用其他方法来进行拟合或逼近。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;运筹学（Operational
Research）是一门应用于管理有组织系统的科学，最早的朴素思想在中国的古文献中多有记载，比如耳熟能详的田忌赛马的故事。运筹的一般思想是：在各项资源条件优先的情况下，如何确定一个方案，使得预期目标最优；或者为了达到预期目标，确定资源消耗最小的方案。在二次世界大战之后，组织和企业的活动规模更大，信息系统化空前完备（想象一下水晶报表的诞生多么让人兴奋），加之各类数学算法模型层出不穷，研究如何做好决策的运筹学也有了极大的发展。&lt;/p&gt;
&lt;p&gt;运筹学方向很多，比如线性规划、非线性规划、整数规划、目标规划、动态规划、排队论、对策论等。笔者偷个懒，找一些在整数规划体系下的例子，让大家感受一下在日常企业中这些方法的应用。&lt;/p&gt;
&lt;h1 id=&quot;一个简化问题&quot;&gt;1. 一个简化问题&lt;/h1&gt;
&lt;p&gt;公司有 4 条生产线，每条生产线的月产量分别为 0.56, 3.11, 3.04,
2.11。近期因为经济不景气，需要将月产量总和控制在 5
以内，但出于总成本摊销的考虑，又要保证产出尽可能的大，那么哪几条产线需要被关闭。我们盲猜结果：3
和 4
需要被关闭。当然这个问题手指头可以掰过来，超过十个手指头怎么办？&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="http://bjt.name/categories/%E7%AE%97%E6%B3%95/"/>
    
    
  </entry>
  
  <entry>
    <title>数据科学家能力素质模型</title>
    <link href="http://bjt.name/2021/09/28/statistician.html"/>
    <id>http://bjt.name/2021/09/28/statistician.html</id>
    <published>2021-09-27T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.294Z</updated>
    
    <content type="html"><![CDATA[<p>话说在遥远的 2012年的某天，我突然感慨：作为一名数据挖掘工程师，要做好本职工作非常不易。于是在微博上吐槽了一句，刚好被“数据挖掘和数据分析”的大 V转发，引发了数据科学圈的广泛转发和讨论，很多位大佬都给出了自己对于数据科学所需要能力的理解。</p><p>话题的争议性体现在一千多个转发上，放在今天必然是一篇 10 万+的文章。不扯别的，看看当时吐槽的是什么？</p><p><img src="/upload/pic/statistician.jpeg" width="500px"/></p><p>几个关键词：技术、市场、工具、战略、管理、沟通影响力……当然数据挖掘的内核已经随着 21世纪最性感的数据科学家这一职业变的更加与时俱进了，然而我们依然还是有困惑。</p><span id="more"></span><h1 id="数据科学领域的工作划分">1. 数据科学领域的工作划分</h1><p>为了简化起见，后面我们统一用数据科学来定义我们讨论的问题（如果看官对数据挖掘和数据科学边界有异议的话，可以Google 一下 KDD）。 先从这个领域从业者构成说起：</p><h2 id="工作类型">1.1. 工作类型</h2><p>第一类偏重数据从无到有，数据存储和清洗，高可用平台：</p><ul><li>数据开发：点击流相关、ETL开发、爬虫工程师、数据稽核、数据血缘和治理、实时数据开发等</li><li>数据平台：高可用集群（离线和实时）、DMP 开发等</li></ul><p>Hadoop 生态主要以 Java 为开发语言，所以很多平台开发工程师是从 Java开发岗转过来的。 数据开发主要以 Python（ETL 等）和PHP（前端的有些功能）为技能栈，从业人员主要以计算机相关专业为主。但不同的岗位对技术和业务的侧重又有不同，比如数据开发（数仓）对如何理解业务有很高的要求，需要大量方法论的支撑，和学习开发语言又不太一样。</p><p>这里不做展开，用一句话来表达这类型工作的意义：</p><blockquote><p>数据到工具，到效率，到价值</p></blockquote><p>第二类偏重描述和总结：</p><ul><li>分析师：商业分析师、策略分析师、运营分析师、数据 BP 等</li><li>BI 开发：需求分析师、利用某种工具的开发工程师（比如通过拖拽完成的Quick BI，通过代码实现的 R Shiny 等）</li></ul><p>这类型的工作初级、中级工程师通过“接需求”实现自身价值，SQL 和 Excel是必备技能；高级别的工程师需要对商业、用户、流程、模型有非常深刻的理解，且要求结论可复现，因此会要求R 或 Python 这类环境。 当然有些分析师级别很高 Excel 也照样通天下。</p><p>分析师需要回答，资源到产出的路径；BI开发需要呈现，数据到信息的路径。一句话总结：</p><blockquote><p>数据到结论，到行动，到价值</p></blockquote><p>第三类偏重推断和应用：</p><ul><li>算法：算法平台、算法优化</li><li>数据挖掘：风控、全 CRM 流程优化（获客、交叉销售、活跃、留存等）</li><li>数据产品经理：面向用户的数据产品、面向内部员工的分析型 CRM产品经理</li></ul><p>算法类岗位主要以计算机背景的同学为主，少量统计系学生；数据挖掘岗位计算机和统计均有，但统计系学生更有优势。为什么算法类岗位统计系的学生少，和统计系的专业设置有极大关系。比如统计系的课程体系下，模型参数习惯追求精确解，重解释性；而计算机系侧重迭代近似解，重预测精度。</p><p>讲个笑话：大概 2010年看到一个并行求解逻辑回归参数的方法：一份算不动，所以把数据分成十份，再把10 个模型的参数加起来平均……batch。一句话总结这类型工种的意义：</p><blockquote><p>数据到应用，到影响，到价值</p></blockquote><p>以上这三大类型的数据工作，如果都做到了“到价值”，那理论上都可以称之为数据科学家。</p><h2 id="需求的条件">1.2. 需求的条件</h2><p>经验上说，年销售额不超过 1 亿 RMB 时，直接在生产库上跑 SQL，raw data拿下来通过 Excel 做数据加工，基本就够用。这时候企业面临的问题并不复杂，核心就是看个业绩结果（What），初、中级分析师可以覆盖大部分需求。</p><p>年销售额介于 1-10亿间，企业开始关注过程中优化可能（How、Why），这时需要建制完备的平台和数仓团队，以及BI 团队。 设想一下，没有中台的数仓，没有统一的BI，分析师一个需求一个烟囱。长此以往，数据不一致问题会让你怀疑人生。这个时期组织上下同域（欲）非常关键，但数据不一致各层级之间的沟通极为困难，大幅降低协同组织效率，这是企业发展的大忌。</p><p>年销售额超过 10亿，就需要有算法、挖掘数据、数据产品的同学介入了，比如 5% 的优化就是5000 万。公司可以养得起这帮人了，值得规划和组建团队来做更高级、更体系的策略来支撑业务。</p><p>但是！</p><p>数据科学变为“显学”大概是 2012年之后的事情，企业在这个方向的基因进化还不够，不是每个企业家都拥有这个能力。一般情况下企业一号位（或CTO）会忽视三个阶段数据团队的规划和组建，有些决策者有感觉，但并不知道数据相关的人、财、物在何时、在什么情况下、如何推进。当然，具备数据科学基因的企业家天然就是领先的，这是平庸和卓越的差别（有想知道卓越的企业家姓名的，可以私信我）。</p><h1 id="解决问题的数据科学家">2. 解决问题的数据科学家</h1><p>人、财、物三个话题有点大，我们回归到人本身，企业到底需要什么样子的数据科学家？我增加了一个定语：</p><blockquote><p>解决问题的数据科学家！</p></blockquote><h2 id="如何定义的">2.1. 如何定义的</h2><p>去年，这个问题刚好在我的分析师团队的 workshop有讨论。通过集体智慧，大家给出了以下 23 项能力。</p><ol type="1"><li>统计专业知识</li><li>机器学习</li><li>编程能力</li><li>领域知识（营销、财务等）</li><li>可视化能力</li><li>数据预处理能力</li><li>报告和演讲呈现能力</li><li>时间规划和管理能力</li><li>问题界定和拆解能力</li><li>快速学习能力</li><li>系统性和结构化思维</li><li>价值和重要性判断能力</li><li>复盘和反思能力</li><li>沟通和表达能力</li><li>协作和项目管理能力</li><li>抗压能力</li><li>好奇心</li><li>获取有效信息能力</li><li>细节处理能力</li><li>人际关系和影响力</li><li>执行能力</li><li>决策和推动能力</li><li>创新能力</li></ol><p>在进入到下个小节前，看官们可以想想是不是还缺了哪项？以及哪项你认为是最重要的？</p><h2 id="能力敏感性分析">2.2. 能力敏感性分析</h2><p>显然上述 23项能力不可能是独立的，他们之间是相互影响的。假设我们给定以下打分规则：</p><ol type="1"><li>如果 A 改变一点，B 改变很大，A = 3</li><li>A 改变很大，才能取得 B 大小差不多的改变，A = 2</li><li>A 有了极其显著的改变，但 B 的改变还是比较弱 A = 1</li><li>没有影响，非常微弱，或者长时间的延迟，A = 0</li></ol><p>经过内部讨论（人工智能，两两比较），我们得到这个矩阵（示例，从行到列）：</p><table><colgroup><col style="width: 18%" /><col style="width: 18%" /><col style="width: 13%" /><col style="width: 13%" /><col style="width: 13%" /><col style="width: 16%" /><col style="width: 6%" /></colgroup><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">统计专业能力</th><th style="text-align: right;">机器学习</th><th style="text-align: right;">编程能力</th><th style="text-align: right;">领域知识</th><th style="text-align: right;">可视化能力</th><th>...</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">统计专业能力</td><td style="text-align: right;">0</td><td style="text-align: right;">2</td><td style="text-align: right;">1</td><td style="text-align: right;">1</td><td style="text-align: right;">2</td><td>...</td></tr><tr class="even"><td style="text-align: left;">机器学习</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td>...</td></tr><tr class="odd"><td style="text-align: left;">编程能力</td><td style="text-align: right;">1</td><td style="text-align: right;">2</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">1</td><td>...</td></tr><tr class="even"><td style="text-align: left;">领域知识</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td>...</td></tr><tr class="odd"><td style="text-align: left;">可视化能力</td><td style="text-align: right;">1</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td style="text-align: right;">0</td><td>...</td></tr><tr class="even"><td style="text-align: left;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td style="text-align: right;">...</td><td>...</td></tr></tbody></table><p>我们将：</p><ul><li>矩阵横向加分总和为 active total，影响其他因素程度；</li><li>矩阵的纵向加分总和为 passitive total，被其他因素影响的程度；</li></ul><h2 id="关键能力项">2.3. 关键能力项</h2><p>我们在分析复杂系统时，关联关系实际是更为重要的信息。尤其在穷尽系统中，如果他的 active total巨大，这个项被解决后对其他因素的帮助也显然是巨大的。 如果 passitivetotal 巨大，显然这个项是被其他因素决定的，可以放在最后面解决。</p><p>将 23 个关键能力放置在平面上，并切成四个象限：</p><p><img src="/upload/pic/20210927182953.png"/></p><p>显然，应该关注最上面的两个象限：</p><ol type="1"><li>右上角象限：剧烈的影响其他能力，也同时被系统中其他能力剧烈的影响。</li><li>左上角象限：剧烈的影响其他能力，被系统中其他能力影响较小。</li></ol><p>关键的四项能力浮出了水面，他们是：</p><ol type="1"><li>系统和结构化思维</li><li>价值和重要性判断能力</li><li>问题定义和拆解能力</li><li>复盘和反思能力</li></ol><p>当然我们也很容易判断这些能力项的难易度，1-3能力是很难获得的，需要大量经验碰撞和沉淀，故此他们存在于右上角象限。 4可通过刻意练习习得（曾子曰：吾日三省吾身），甚至这项能力有标准方法论。</p><p>看官们可能会对结果有些诧异，拿出一项我们当时觉得有点意思的一项能力——报告和演讲呈现能力。最开始我们认为是推动项目很关键的能力，但这张图出来后，因果非常清晰：如果上述四项能力都很优异，报告和演讲呈现能力必然会被提高到很高的段位。</p><h1 id="方法的局限性">3. 方法的局限性</h1><p>我们通过能力敏感分析将数据科学家的能力项做了一次全面的梳理，方法科学，言之凿凿。但对于数据科学家的能力素质模型讨论实际上并不全面，如果大家有兴趣做一个更为全面的版本的话，可以参考“麦克利兰能力素质模型”。</p><p>例如，我们发现的 1-3 实际上是通用素质模型中“认知族”里面的内容，麦克利兰明确认为“认知族”是支持“影响力族”与“管理族”发挥作用的基础，已经跨越到HR 领域，不再赘述。</p><p>本文讨论的关键能力是“解决问题的数据科学家”简化拆解模型，是一个更容易理解的版本。希望对大家思考自己的核心能力有所帮助。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;话说在遥远的 2012
年的某天，我突然感慨：作为一名数据挖掘工程师，要做好本职工作非常不易。
于是在微博上吐槽了一句，刚好被“数据挖掘和数据分析”的大 V
转发，引发了数据科学圈的广泛转发和讨论，
很多位大佬都给出了自己对于数据科学所需要能力的理解。&lt;/p&gt;
&lt;p&gt;话题的争议性体现在一千多个转发上，放在今天必然是一篇 10 万+
的文章。不扯别的，看看当时吐槽的是什么？&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/upload/pic/statistician.jpeg&quot; width=&quot;500px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;几个关键词：技术、市场、工具、战略、管理、沟通影响力……
当然数据挖掘的内核已经随着 21
世纪最性感的数据科学家这一职业变的更加与时俱进了，然而我们依然还是有困惑。&lt;/p&gt;</summary>
    
    
    
    <category term="数据思维" scheme="http://bjt.name/categories/%E6%95%B0%E6%8D%AE%E6%80%9D%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>从北京地铁规划再看地段的重要性</title>
    <link href="http://bjt.name/2021/02/13/subway.html"/>
    <id>http://bjt.name/2021/02/13/subway.html</id>
    <published>2021-02-12T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.294Z</updated>
    
    <content type="html"><![CDATA[<p>距离上一篇《好地段是怎么选出来的-从北京地铁看区域的重要性》已经过去八年有余，一直念叨着重新更新一下北京的地铁数据。话说deadline 是第一生产力，春节前立了 flag，今天利利索索地把它拔了。</p><p>读者可以从本文得到什么信息呢？</p><ol type="1"><li>从全新的 2024年北京地铁规划，识别以北京（地铁）交通便利视角的关键区域。</li><li>获取这些关键地段的二手房产信息，通过供给量和均价两个角度，帮助大家找到可能的价值洼地。</li></ol><h1 id="构建地铁的网络">1. 构建地铁的网络</h1><p>首先重新认识一下 2024 年的北京地铁线路规划图：</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/20210214144227.png"/></p><p>至 2024 年全北京一共 422 个地铁站点（约数，有些懒得调整，比如 13号线会拆分，没有做调整）。回想二十年前北京只有1号线、2号线两条地铁线，北京的发展速度也确实让人咂舌（回龙观最初房价2000，一声叹息）。</p><span id="more"></span><p>这 422 个站点信息如何获得，可以分为两步来进行：</p><ol type="1"><li>通过<ahref="http://map.amap.com/subway/index.html">高德地图的网页</a>中获取正在运营地铁站点的经纬度和隶属信息。</li><li>补齐缺失了 8 号线的中段，14 号线中段，16 号线南段信息；补充了3、11、12、17、19、22、28 号线的全部站点信息（无经纬度）</li></ol><p>高德地图不但提供了北京地铁数据，还非常贴心地提供了上海、广州、武汉、深圳等地地铁运营数据。一段很短的定向爬虫，拿下这份数据（示例）：</p><table><thead><tr class="header"><th style="text-align: left;">names</th><th style="text-align: left;">terminal</th><th style="text-align: left;">longitude</th><th style="text-align: left;">latitude</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">亦庄线</td><td style="text-align: left;">荣昌东街</td><td style="text-align: left;">39.782832</td><td style="text-align: left;">116.521688</td></tr><tr class="even"><td style="text-align: left;">亦庄线</td><td style="text-align: left;">同济南路</td><td style="text-align: left;">39.772962</td><td style="text-align: left;">116.539901</td></tr><tr class="odd"><td style="text-align: left;">亦庄线</td><td style="text-align: left;">经海路</td><td style="text-align: left;">39.783673</td><td style="text-align: left;">116.562321</td></tr><tr class="even"><td style="text-align: left;">亦庄线</td><td style="text-align: left;">次渠南</td><td style="text-align: left;">39.795118</td><td style="text-align: left;">116.581357</td></tr><tr class="odd"><td style="text-align: left;">亦庄线</td><td style="text-align: left;">次渠</td><td style="text-align: left;">39.803500</td><td style="text-align: left;">116.591502</td></tr><tr class="even"><td style="text-align: left;">亦庄线</td><td style="text-align: left;">亦庄火车站</td><td style="text-align: left;">39.812607</td><td style="text-align: left;">116.601913</td></tr></tbody></table><p>这里面有一些细节，比如地铁网络的边是有权重的。一种做法是将站点和站点之间的权重用<strong>两个站点距离的倒数</strong>来度量（距离越近关联性性越强），没有经纬度的站点之间的权重统一设置为全部边的平均值。但考虑地铁出行的实际体验，以及真实的两站之间的关联性（想象一下在知春路，从十号线换乘十三号线的换乘感受），这个距离一般还真不一定是关键因素，所以我粗暴地去掉了边权重这个指标，认为两站之间的权重一致。</p><p>有了站点数据后，就可以构建北京地铁的网络拓扑图，进而度量和描述每个地铁站在全网络的作用。可问题又来了，我们应该用什么指标来衡量呢？重新查阅了相关资料后，了解到中心度大概有三十几种，有些还不太好解释，所以度量方式依然采用了《好地段是怎么选出来的-从北京地铁看区域的重要性》中的三个指标：</p><ol type="1"><li>Betweenness centrality：如果地铁网络中有这样一个站点A，其他的站点都要通过 A才能到达其他的站，那么这个站点越重要。想象极端的情况，如果没有了站点A，你需要绕行很大一段，才能从一个站点到达另一个站点。</li><li>PageRank centrality：如果同 A站点连接的站点都非常好，那么物以类聚，A站点也应该是一个很好的站点。简单地可以理解为 A点的重要程度是周围连接点重要程度的加权。</li><li>Closeness centrality：如果从地铁网络中 A点，到所有其他地铁站的“最短距离”的和最小的话，那这个站点一定是最便捷的，它反映的是网络节点A 到其他节点的平均最短距离。</li></ol><p>这个工作准备结束后，我们计算出了 422 个站点的三个核心指标：</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">betweenness</th><th style="text-align: right;">pagerank</th><th style="text-align: right;">closeness</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">巴沟</td><td style="text-align: right;">2080.0000</td><td style="text-align: right;">0.0022162</td><td style="text-align: right;">6122</td></tr><tr class="even"><td style="text-align: left;">苏州街</td><td style="text-align: right;">2490.0000</td><td style="text-align: right;">0.0020500</td><td style="text-align: right;">5712</td></tr><tr class="odd"><td style="text-align: left;">海淀黄庄</td><td style="text-align: right;">3942.2897</td><td style="text-align: right;">0.0035418</td><td style="text-align: right;">5304</td></tr><tr class="even"><td style="text-align: left;">知春里</td><td style="text-align: right;">815.0526</td><td style="text-align: right;">0.0018323</td><td style="text-align: right;">5323</td></tr><tr class="odd"><td style="text-align: left;">知春路</td><td style="text-align: right;">6412.0152</td><td style="text-align: right;">0.0034080</td><td style="text-align: right;">5001</td></tr><tr class="even"><td style="text-align: left;">西土城</td><td style="text-align: right;">1178.9848</td><td style="text-align: right;">0.0018085</td><td style="text-align: right;">5044</td></tr><tr class="odd"><td style="text-align: left;">牡丹园</td><td style="text-align: right;">2657.0143</td><td style="text-align: right;">0.0025725</td><td style="text-align: right;">4818</td></tr><tr class="even"><td style="text-align: left;">健德门</td><td style="text-align: right;">2124.6522</td><td style="text-align: right;">0.0017950</td><td style="text-align: right;">5074</td></tr><tr class="odd"><td style="text-align: left;">北土城</td><td style="text-align: right;">4253.7759</td><td style="text-align: right;">0.0033441</td><td style="text-align: right;">5084</td></tr><tr class="even"><td style="text-align: left;">安贞门</td><td style="text-align: right;">1738.8012</td><td style="text-align: right;">0.0017301</td><td style="text-align: right;">5136</td></tr></tbody></table><p>直接描述 422个站点信息是没有意义的，我们需要将他们聚成几个类，辅助我们理解这些站点的表现。</p><h1 id="相似地域的聚类">2. 相似地域的聚类</h1><blockquote><p>聚类是一种统计方法。如果我们将样本分为多个类，聚类方法可以保证类和类之间的差异度足够大，而类间的差异则足够小。这样我们就可以只看这几个类，他们代表所有样本信息。</p></blockquote><p>如果每个站点可以用以上三个指标来表达，那这 422个地铁站点（区域）可以简单的认为是几类？这个问题统计学家已经给我们很多方法了，比如R. Tibshirani, G. Walther, and T. Hastie (Standford University, 2001)给的 Gap Statistic Method 就很好用，原理这里不介绍了，直接看结果：</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/20210216190838.png" width="500"/></p><p>建议是 1 类，这显然不合理，我们不能不分类。从图上看，如果切分为 5类也是很不错的选择，所以将这 422 个站点分为五类看效果：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> size <span class="operator">&lt;-</span> 5</span><br><span class="line"><span class="operator">&gt;</span> k <span class="operator">&lt;-</span> kmeans<span class="punctuation">(</span>scale<span class="punctuation">(</span>dat<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> size<span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> k<span class="operator">$</span>centers <span class="comment"># 观察中心点</span></span><br><span class="line">           b         PR          <span class="built_in">c</span></span><br><span class="line"><span class="number">1</span> <span class="operator">-</span><span class="number">0.3289514</span> <span class="operator">-</span><span class="number">0.7113196</span> <span class="operator">-</span><span class="number">0.5270072</span></span><br><span class="line"><span class="number">2</span> <span class="operator">-</span><span class="number">0.4928851</span> <span class="operator">-</span><span class="number">0.0680553</span>  <span class="number">2.1105316</span></span><br><span class="line"><span class="number">3</span> <span class="operator">-</span><span class="number">0.3164911</span> <span class="operator">-</span><span class="number">0.1204436</span>  <span class="number">0.5436801</span></span><br><span class="line"><span class="number">4</span>  <span class="number">0.4761036</span>  <span class="number">1.5785205</span> <span class="operator">-</span><span class="number">0.6878083</span></span><br><span class="line"><span class="number">5</span>  <span class="number">2.9584748</span>  <span class="number">0.8770382</span> <span class="operator">-</span><span class="number">0.9454840</span></span><br><span class="line"><span class="operator">&gt;</span> k<span class="operator">$</span>size <span class="comment"># 类大小</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">165</span>  <span class="number">47</span> <span class="number">113</span>  <span class="number">70</span>  <span class="number">27</span></span><br></pre></td></tr></table></figure><p>从刚才三个指标的描述上看，betweenness 和 page rank越大越好，closeness 我取了倒数，越小越好。从中心点上看，第 4 类（有 70个）和第 5 类（有 27个）是我们需要重点关注的站点类别。这两类的三个指标表现都是最优秀的，当然第5 类显著好于第 4 类。</p><p>如果将所有的站点进行（主成分）二维展示的话，是这个样子的：</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/20210217150635.png"/></p><p>为了更直观，我将这两类的所有站点，按照 betweenness 和 page rank两个值做了可视化：</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/20210217161616.png"/></p><ol type="1"><li>两类的 betweeness 和 page rank 都很高</li><li>第 4 类的 page rank 更高，第 5 类的 betweeness更高（网络中的瓶颈点）</li></ol><h1 id="寻求价值洼地">3. 寻求价值洼地</h1><p>这 97 个站点占据了全部 422个地铁站点中相对关键的位置，如果我们还能够知道这些区域的房产均价和二手房供应量信息，那大家上车的姿势就可以确定了。</p><p>这个数据可以从<ahref="https://map.ke.com/map/110000/ESF/">贝壳网页端</a>的 API中获取（很容易找到）。这里忍不住要赞一下贝壳，二手房的基础数据整理的非常完备！比如这是获取的一个片段数据（西二旗附近）：</p><table><thead><tr class="header"><th style="text-align: left;">name</th><th style="text-align: left;">price</th><th style="text-align: right;">count</th><th style="text-align: right;">longitude</th><th style="text-align: right;">latitude</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">领秀慧谷C区</td><td style="text-align: left;">57595</td><td style="text-align: right;">23</td><td style="text-align: right;">116.3105</td><td style="text-align: right;">40.10650</td></tr><tr class="even"><td style="text-align: left;">领秀慧谷B区</td><td style="text-align: left;">48309</td><td style="text-align: right;">11</td><td style="text-align: right;">116.3087</td><td style="text-align: right;">40.10320</td></tr><tr class="odd"><td style="text-align: left;">领秀慧谷D区</td><td style="text-align: left;">55930</td><td style="text-align: right;">8</td><td style="text-align: right;">116.3065</td><td style="text-align: right;">40.10525</td></tr><tr class="even"><td style="text-align: left;">领秀慧谷A区</td><td style="text-align: left;">48422</td><td style="text-align: right;">7</td><td style="text-align: right;">116.3106</td><td style="text-align: right;">40.10314</td></tr><tr class="odd"><td style="text-align: left;">TBD住总万科天地</td><td style="text-align: left;">42256</td><td style="text-align: right;">3</td><td style="text-align: right;">116.3225</td><td style="text-align: right;">40.10905</td></tr><tr class="even"><td style="text-align: left;">领秀慧谷D2区</td><td style="text-align: left;">51769</td><td style="text-align: right;">1</td><td style="text-align: right;">116.3049</td><td style="text-align: right;">40.10625</td></tr></tbody></table><p>有个两个小细节：</p><ol type="1"><li>我为了保证步行 10分钟内能走到地铁站，所有获取的小区是在该站点纬度正负 0.02201548/4区间，经度正负 0.04132205/4 区间。</li><li>该地域的二手房均价我采用的是区域房价的加权平均值，并未考虑几居室分布的问题（贝壳暂时只有这个数据）。</li></ol><p>将区域的二手房均价和二手房供应量放在一张图上就清楚很多了：</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/20210217225022.png"/></p><p>这张图的信息量有点略大，比如：</p><ol type="1"><li>有些二环外，如东城区的一些地方也不是不能考虑，当然还要具体看楼龄和学区情况；</li><li>立水桥、九龙山这些地方从来都不在视野之内，未来应该多给一些关注；</li><li>首经贸、管庄、草桥隶属于第五类，本应属于高攀不起的那一波，但可以再咂摸咂摸；</li><li>200 套以上，均价在 75000以下在图的左上方，说明的是选择空间大，预算相对可控；</li><li>可以把具体某个站点的数据单拎出来细看，包括三个核心中心度指标和二手房小区信息。</li></ol><p>然，每位看官关注点必然不同，我也就能帮到这里了。未来不论各位是新上车还是需求改善，有行动也记得给我一些反馈。</p><p>获取数据，数据预处理，作图、注释，总计代码量共计 190行，见后文。全文完毕，收工！</p><h1 id="代码">4. 代码</h1><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 获取北京地铁数据，源自于`http://map.amap.com/subway/index.html`</span></span><br><span class="line">library<span class="punctuation">(</span>jsonlite<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>magrittr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>igraph<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">url <span class="operator">&lt;-</span></span><br><span class="line">  <span class="string">&#x27;http://map.amap.com/service/subway?_1612711668721&amp;srhdata=1100_drw_beijing.json&#x27;</span></span><br><span class="line">x <span class="operator">&lt;-</span> fromJSON<span class="punctuation">(</span>url<span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="comment"># x$l 是关键数据对象</span></span><br><span class="line">subwaynames <span class="operator">&lt;-</span> <span class="built_in">rep</span><span class="punctuation">(</span>x<span class="operator">$</span>l<span class="operator">$</span>ln<span class="punctuation">,</span> times <span class="operator">=</span> sapply<span class="punctuation">(</span>x<span class="operator">$</span>l<span class="operator">$</span>st<span class="punctuation">,</span> nrow<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">subwaydata <span class="operator">&lt;-</span> do.call<span class="punctuation">(</span>rbind<span class="punctuation">,</span> x<span class="operator">$</span>l<span class="operator">$</span>st<span class="punctuation">)</span></span><br><span class="line">titude <span class="operator">&lt;-</span> do.call<span class="punctuation">(</span>rbind<span class="punctuation">,</span> strsplit<span class="punctuation">(</span>subwaydata<span class="operator">$</span>sl<span class="punctuation">,</span> <span class="string">&#x27;,&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 得到各个站点的名称和经纬度，包括隶属于几号线</span></span><br><span class="line">subway <span class="operator">&lt;-</span></span><br><span class="line">  data.frame<span class="punctuation">(</span></span><br><span class="line">    subwaynames<span class="punctuation">,</span></span><br><span class="line">    terminal <span class="operator">=</span> subwaydata<span class="operator">$</span>n<span class="punctuation">,</span></span><br><span class="line">    longitude <span class="operator">=</span> titude<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    latitude <span class="operator">=</span> titude<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 构造函数处理 json 里面的数据，得到带边权重的 graph</span></span><br><span class="line">weight_graph <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  line_names <span class="operator">&lt;-</span> x<span class="operator">$</span>terminal</span><br><span class="line">  n <span class="operator">&lt;-</span> <span class="built_in">length</span><span class="punctuation">(</span>line_names<span class="punctuation">)</span></span><br><span class="line">  a <span class="operator">&lt;-</span> 1<span class="operator">:</span><span class="punctuation">(</span>n <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  b <span class="operator">&lt;-</span> 2<span class="operator">:</span>n</span><br><span class="line">  m <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>a<span class="punctuation">,</span> b<span class="punctuation">)</span></span><br><span class="line">  distance <span class="operator">&lt;-</span> x<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;longitude&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;latitude&#x27;</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span> dist<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  weight_g_df <span class="operator">&lt;-</span></span><br><span class="line">    data.frame<span class="punctuation">(</span>from <span class="operator">=</span> line_names<span class="punctuation">[</span>a<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">               to <span class="operator">=</span> line_names<span class="punctuation">[</span>b<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">               w <span class="operator">=</span> as.matrix<span class="punctuation">(</span>distance<span class="punctuation">)</span><span class="punctuation">[</span>m<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>weight_g_df<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 获得构建北京地铁 graph 的 data frame</span></span><br><span class="line">d1 <span class="operator">&lt;-</span></span><br><span class="line">  by<span class="punctuation">(</span>subway<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">2</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">,</span> subway<span class="operator">$</span>subwaynames<span class="punctuation">,</span> weight_graph<span class="punctuation">)</span> <span class="operator">%&gt;%</span> do.call<span class="punctuation">(</span>rbind<span class="punctuation">,</span> .<span class="punctuation">)</span></span><br><span class="line">mean_weight <span class="operator">&lt;-</span> mean<span class="punctuation">(</span>d1<span class="operator">$</span>w<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## d1[grep(&#x27;16号线&#x27;, rownames(d1)),] # 看是否有遗漏</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 增加 2024 年未来规划的线路</span></span><br><span class="line"><span class="comment">## 包括补充了 8 号线中段，14 号线中段，16 号线南段</span></span><br><span class="line"><span class="comment">## https://upload.wikimedia.org/wikipedia/commons/a/a2/Beijing-Subway-Plan.png</span></span><br><span class="line">line3 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;东四十条&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;工人体育场&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;团结湖&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;朝阳公园&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;石佛营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;星火站&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;朝阳体育中心&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;平房村&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;东坝中街&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;东风&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;楼梓庄桥西&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;楼梓庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;高辛庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;曹各庄北&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line8 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;中国美术馆&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;金鱼胡同&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;王府井&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;前门&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;珠市口&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line11 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;模式口&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;金安桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北辛安&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;新首钢&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line12 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;四季青&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;远大路&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;长春桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;苏州桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;人民大学&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;大钟寺&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;蓟门桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北太平庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;马甸&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;安华桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;安贞桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;和平西桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;光熙门&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;西坝河&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;三元桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;芳园里&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;高家园&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;酒仙桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北岗子&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;东风&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;管庄路&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line14 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;西局&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;东管头&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;丽泽商务区&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;菜户营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;西铁营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;景风门&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北京南站&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;永定门外&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line16 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;国家图书馆&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;二里沟&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;甘家口&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;玉渊潭东门&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;木樨地&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;达官营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;红莲南里&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;丽泽商务区&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;东管头南&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;丰台站&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;丰台南路&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;富丰桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;看丹&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;榆树庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;宛平城&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line17 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;未来各科技城&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;天通苑东&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;清河营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;勇士营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;望京西&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;太阳宫&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;西坝河&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;香河园&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;工人体育场&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;东大桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;永安里&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;广渠门外&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;潘家园西&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;十里河&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;十八里店&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;朝阳港&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北神树&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;次渠北&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;次渠&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;亦庄站前区南&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line19 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;牡丹园&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北太平庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;积水潭&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;平安里&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;金融街&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;牛街&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;景风门&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;草桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;新发地&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;新宫&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line22 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;东大桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;金台夕照&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;红庙&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;慈云寺桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;甘露园&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;定福庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;管庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;永顺&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;通州北关&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;运河商务区&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;副中心站&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;政务中心&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;政务中心东&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;燕郊镇&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;神威大街&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;潮白大街&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;高楼&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;齐心庄&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;马坊&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;马昌营&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;平谷&#x27;</span><span class="punctuation">)</span></span><br><span class="line">line28 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;东大桥&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;金台夕照&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;光华路&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;核心区&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;大望路&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;北京东站&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;大郊亭&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;广渠路&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;广渠东路&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">line_graph <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">,</span> w <span class="operator">=</span> mean_weight<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  n <span class="operator">&lt;-</span> <span class="built_in">length</span><span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">  a <span class="operator">&lt;-</span> 1<span class="operator">:</span><span class="punctuation">(</span>n<span class="operator">-</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  b <span class="operator">&lt;-</span> 2<span class="operator">:</span>n</span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>data.frame<span class="punctuation">(</span>from <span class="operator">=</span> x<span class="punctuation">[</span>a<span class="punctuation">]</span><span class="punctuation">,</span> to <span class="operator">=</span> x<span class="punctuation">[</span>b<span class="punctuation">]</span><span class="punctuation">,</span> w <span class="operator">=</span> w<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">l3 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line3<span class="punctuation">)</span></span><br><span class="line">l8 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line8<span class="punctuation">)</span></span><br><span class="line">l11 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line11<span class="punctuation">)</span></span><br><span class="line">l12 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line12<span class="punctuation">)</span></span><br><span class="line">l14 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line14<span class="punctuation">)</span></span><br><span class="line">l16 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line16<span class="punctuation">)</span></span><br><span class="line">l17 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line17<span class="punctuation">)</span></span><br><span class="line">l19 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line19<span class="punctuation">)</span></span><br><span class="line">l22 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line22<span class="punctuation">)</span></span><br><span class="line">l28 <span class="operator">&lt;-</span> line_graph<span class="punctuation">(</span>line28<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 合并无权重的图数据</span></span><br><span class="line">dd <span class="operator">&lt;-</span> unique<span class="punctuation">(</span>rbind<span class="punctuation">(</span>d1<span class="punctuation">,</span> l3<span class="punctuation">,</span> l8<span class="punctuation">,</span> l11<span class="punctuation">,</span> l12<span class="punctuation">,</span> l14<span class="punctuation">,</span> l16<span class="punctuation">,</span> l17<span class="punctuation">,</span> l19<span class="punctuation">,</span> l22<span class="punctuation">,</span> l28<span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">g <span class="operator">&lt;-</span> graph_from_data_frame<span class="punctuation">(</span>dd<span class="punctuation">,</span> directed <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## E(g)$weight &lt;- sqrt(1/subway_graph_dataframe$w)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 观察中心度相关指标是否合理</span></span><br><span class="line">data.frame<span class="punctuation">(</span>name <span class="operator">=</span> V<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="operator">$</span>name<span class="punctuation">,</span> v <span class="operator">=</span> betweenness<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>desc<span class="punctuation">(</span>v<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> head<span class="punctuation">(</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">data.frame<span class="punctuation">(</span>name <span class="operator">=</span> V<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="operator">$</span>name<span class="punctuation">,</span> v <span class="operator">=</span> <span class="number">1</span> <span class="operator">/</span> closeness<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>desc<span class="punctuation">(</span>v<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> tail<span class="punctuation">(</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 聚类，确定聚多少类</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggsci<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>factoextra<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cluster<span class="punctuation">)</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">123</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dat <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">  name <span class="operator">=</span> V<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="operator">$</span>name<span class="punctuation">,</span></span><br><span class="line">  b <span class="operator">=</span> betweenness<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  PR <span class="operator">=</span> page_rank<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="operator">$</span>vector<span class="punctuation">,</span></span><br><span class="line">  <span class="built_in">c</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">/</span>closeness<span class="punctuation">(</span>g<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">gap_stat <span class="operator">&lt;-</span> clusGap<span class="punctuation">(</span>scale<span class="punctuation">(</span>dat<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> FUN <span class="operator">=</span> kmeans<span class="punctuation">,</span> nstart <span class="operator">=</span> <span class="number">25</span><span class="punctuation">,</span> K.max <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> B <span class="operator">=</span> <span class="number">50</span><span class="punctuation">)</span></span><br><span class="line">fviz_gap_stat<span class="punctuation">(</span>gap_stat<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">size <span class="operator">&lt;-</span> 5</span><br><span class="line">k <span class="operator">&lt;-</span> kmeans<span class="punctuation">(</span>scale<span class="punctuation">(</span>dat<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> size<span class="punctuation">)</span> <span class="comment"># 每次结果可能略有不同</span></span><br><span class="line">k<span class="operator">$</span>centers <span class="comment"># 观察中心点</span></span><br><span class="line">k<span class="operator">$</span>size <span class="comment"># 类大小</span></span><br><span class="line">fviz_cluster<span class="punctuation">(</span>k<span class="punctuation">,</span> data <span class="operator">=</span> scale<span class="punctuation">(</span>dat<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">k4 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>n <span class="operator">=</span> V<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="operator">$</span>name<span class="punctuation">,</span> k <span class="operator">=</span> k<span class="operator">$</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> subset<span class="punctuation">(</span>k <span class="operator">==</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line">k5 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>n <span class="operator">=</span> V<span class="punctuation">(</span>g<span class="punctuation">)</span><span class="operator">$</span>name<span class="punctuation">,</span> k <span class="operator">=</span> k<span class="operator">$</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> subset<span class="punctuation">(</span>k <span class="operator">==</span> <span class="number">5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 绘制第一类和第二类的 betweeness 和 PageRank 图</span></span><br><span class="line">library<span class="punctuation">(</span>showtext<span class="punctuation">)</span></span><br><span class="line">showtext_auto<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">font_add<span class="punctuation">(</span><span class="string">&quot;Noto Sans SC&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/Users/liusizhe/Library/Fonts/NotoSansSC-Regular.otf&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p4 <span class="operator">&lt;-</span> dat<span class="punctuation">[</span>dat<span class="operator">$</span>name <span class="operator">%in%</span> k4<span class="operator">$</span>n<span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span></span><br><span class="line">ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>b<span class="punctuation">,</span> PR<span class="punctuation">,</span> label <span class="operator">=</span> name<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>color <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_text_repel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;k = 4&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.y<span class="operator">=</span>element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">90</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p5 <span class="operator">&lt;-</span> dat<span class="punctuation">[</span>dat<span class="operator">$</span>name <span class="operator">%in%</span> k5<span class="operator">$</span>n<span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span></span><br><span class="line">ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>b<span class="punctuation">,</span> PR<span class="punctuation">,</span> label <span class="operator">=</span> name<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>color <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_text_repel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;k = 5&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.y<span class="operator">=</span>element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">90</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>gridExtra<span class="punctuation">)</span></span><br><span class="line">grid.arrange<span class="punctuation">(</span>p4<span class="punctuation">,</span> p5<span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 从贝壳获取房源和价格信息，来定义该区域是否有价值洼地。</span></span><br><span class="line"><span class="comment">## 需要看附近房价的地铁站</span></span><br><span class="line">subway <span class="operator">&lt;-</span> unique<span class="punctuation">(</span>subway<span class="punctuation">[</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">k4_5 <span class="operator">&lt;-</span> rbind.data.frame<span class="punctuation">(</span>k4<span class="punctuation">,</span>k5<span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>k4_5<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;terminal&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;n&#x27;</span><span class="punctuation">)</span></span><br><span class="line">subway_price_list <span class="operator">&lt;-</span> inner_join<span class="punctuation">(</span>subway<span class="punctuation">,</span> k4_5<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">lat_minmax_diff <span class="operator">&lt;-</span> 0.02201548<span class="operator">/</span><span class="number">4</span> <span class="comment"># 经纬度查询数据的区间</span></span><br><span class="line">longi_minmax_diff <span class="operator">&lt;-</span> 0.04132205<span class="operator">/</span><span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 构造获取贝壳的区域数据源</span></span><br><span class="line">price <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">bubbleList <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">steps <span class="operator">&lt;-</span> nrow<span class="punctuation">(</span>subway_price_list<span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span>steps<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  longitude <span class="operator">&lt;-</span> subway_price_list<span class="punctuation">[</span>i<span class="punctuation">,</span> <span class="string">&#x27;longitude&#x27;</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  latitude <span class="operator">&lt;-</span> subway_price_list<span class="punctuation">[</span>i<span class="punctuation">,</span> <span class="string">&#x27;latitude&#x27;</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  url <span class="operator">&lt;-</span></span><br><span class="line">    sprintf<span class="punctuation">(</span></span><br><span class="line">      <span class="string">&quot;https://map.ke.com/proxyApi/i.c-pc-webapi.ke.com/map/bubblelist?cityId=110000&amp;dataSource=ESF&amp;condition=&amp;id=&amp;groupType=community&amp;maxLatitude=%s&amp;minLatitude=%s&amp;maxLongitude=%s&amp;minLongitude=%s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      longitude <span class="operator">+</span> lat_minmax_diff<span class="punctuation">,</span></span><br><span class="line">      longitude <span class="operator">-</span> lat_minmax_diff<span class="punctuation">,</span></span><br><span class="line">      latitude <span class="operator">+</span> longi_minmax_diff<span class="punctuation">,</span></span><br><span class="line">      latitude <span class="operator">-</span> longi_minmax_diff</span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">  house_raw_data <span class="operator">&lt;-</span> fromJSON<span class="punctuation">(</span>url<span class="punctuation">)</span></span><br><span class="line">  bubbleListData <span class="operator">&lt;-</span></span><br><span class="line">    house_raw_data<span class="operator">$</span>data<span class="operator">$</span>bubbleList<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;name&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;price&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;count&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;longitude&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;latitude&#x27;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">  bubbleList<span class="punctuation">[[</span>i<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> bubbleListData</span><br><span class="line">  ave <span class="operator">&lt;-</span></span><br><span class="line">    bubbleListData <span class="operator">%&gt;%</span></span><br><span class="line">    transform<span class="punctuation">(</span>price <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>price<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    summarise<span class="punctuation">(</span>aveprice <span class="operator">=</span> <span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">sum</span><span class="punctuation">(</span>price <span class="operator">*</span> count<span class="punctuation">)</span> <span class="operator">/</span> <span class="built_in">sum</span><span class="punctuation">(</span>count<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              countsum <span class="operator">=</span> <span class="built_in">sum</span><span class="punctuation">(</span>count<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  price<span class="punctuation">[[</span>i<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> ave</span><br><span class="line">  Sys.sleep<span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&#x27;This is the&#x27;</span><span class="punctuation">,</span> i<span class="punctuation">,</span> <span class="string">&#x27;step of&#x27;</span><span class="punctuation">,</span> steps<span class="punctuation">,</span> <span class="string">&#x27;total steps&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;\n&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">price_count <span class="operator">&lt;-</span> price <span class="operator">%&gt;%</span> do.call<span class="punctuation">(</span>rbind<span class="punctuation">,</span> .<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  data.frame<span class="punctuation">(</span>subway_price_list<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  mutate<span class="punctuation">(</span>n <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>n<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>price_count<span class="punctuation">,</span> aes<span class="punctuation">(</span>aveprice<span class="punctuation">,</span> countsum<span class="punctuation">,</span> color <span class="operator">=</span> n<span class="punctuation">,</span> label <span class="operator">=</span> terminal<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_text_repel<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_color_d3<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;第 4 和 5 类区域的二手房价格和供给量情况&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&#x27;均价&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&#x27;房源供给量&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;距离上一篇《好地段是怎么选出来的-从北京地铁看区域的重要性》已经过去八年有余，一直念叨着重新更新一下北京的地铁数据。话说
deadline 是第一生产力，春节前立了 flag，今天利利索索地把它拔了。&lt;/p&gt;
&lt;p&gt;读者可以从本文得到什么信息呢？&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;从全新的 2024
年北京地铁规划，识别以北京（地铁）交通便利视角的关键区域。&lt;/li&gt;
&lt;li&gt;获取这些关键地段的二手房产信息，通过供给量和均价两个角度，帮助大家找到可能的价值洼地。&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;构建地铁的网络&quot;&gt;1. 构建地铁的网络&lt;/h1&gt;
&lt;p&gt;首先重新认识一下 2024 年的北京地铁线路规划图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/20210214144227.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;至 2024 年全北京一共 422 个地铁站点（约数，有些懒得调整，比如 13
号线会拆分，没有做调整）。回想二十年前北京只有1号线、2号线两条地铁线，北京的发展速度也确实让人咂舌（回龙观最初房价
2000，一声叹息）。&lt;/p&gt;</summary>
    
    
    
    <category term="玩数据" scheme="http://bjt.name/categories/%E7%8E%A9%E6%95%B0%E6%8D%AE/"/>
    
    
  </entry>
  
  <entry>
    <title>你为什么可以被晋升？</title>
    <link href="http://bjt.name/2020/04/12/value.html"/>
    <id>http://bjt.name/2020/04/12/value.html</id>
    <published>2020-04-11T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>本篇文章 2900 字，预计阅读时间为 12分钟，建议找一个安静的时间阅读，以及隔一段时间翻出来再看。</p><p>在任何一家公司，每一个对自己职业生涯有规划的员工都希望在更短的时间内晋升，这意味着更多的关注和资源倾斜，更大的责任和职责范围。当然，与之匹配的收益必然也是同步提高的。</p><p>对于晋升这件事情本身，我们应该怎样理解？有哪些误解需要澄清，我们需要做什么准备？今天就花一些时间和大家聊一聊你为什么会被提名晋升，或者晋升成功。</p><span id="more"></span><h1 id="引子">1. 引子</h1><p>一位工程师作为主力，花了 2个月开发了一套数据字典系统：数据维护页面、展示页面、搜索功能，关联关系等模块一应俱全……从开发角度而言，项目交付得漂亮，此为背景。但当我询问团队的分析师，这套系统对比以前的wiki系统是否更好地解决了大家寻找数据解释的这个难题。然而让我大跌眼镜的是，这么关键的工具，分析师们并不知道它的存在……</p><p>我反问研发人员其中原因，他也很委屈：系统上线时，给全员发送了邮件，在工作群里也有提到。我开发完了，我交付完毕了，为什么大家不用？</p><blockquote><p>你所服务的用户，因为思维方式、背景、动机的不同，同样一件事情，他和你的理解可能完全不是一回事。</p></blockquote><p>请读者思考以下三个问题：</p><ol type="1"><li>你负责产品的最终用户是怎么想的？</li><li>你表达的语言，用户听懂了么？</li><li>你的产品如果不被接受，更多的是产品的问题还是信息传递的问题？</li></ol><p>当然也可以对照一下产品方法论，产品 + 用户 + 场景 +效率是我们考虑的四个目标：分析师在什么场景下使用你的产品，是否真的提高了他们发现数据的效率？</p><h1 id="员工的能力要求">2. 员工的能力要求</h1><p>这里不涉及所谓的企业价值观表现和组织能力，是纯粹个人能力的讨论。先快速讨论一下不同层级员工的核心区别：</p><ul><li>一线员工：他关注的是做什么？（事情的本身，重在执行）</li><li>高级别员工：他关注的怎么做才能做得更好？（模式的抽象，框架下的预见）</li><li>管理者：他关注的是为什么要做这个？不做可以么？做了其他的事情是否可以更好地解决这个问题？（关系和结构，顶层设计）</li></ul><p>每周你都要反问自己这几个问题：</p><ol type="1"><li>我对于老板，不可替代的作用是什么？</li><li>对接的业务，你只是在被动的支持么？</li><li>因为你的存在，哪些执行的结果变的不一样了？</li><li>你对你的上下游做了什么，让组织变得更高效了？</li></ol><p>答案每个人都会不同，只要你做到任意一点，都会提高你被提名晋升的概率。细节这里不做过多的解释。再给大家另外一个事实讨论：有两个员工晋升答辩，只能晋升一个，你会选择谁？</p><ol type="1"><li>项目方向是老板定的，公司关键性项目，该员工在执行，项目带来的公司业绩很多。</li><li>直接产生的业绩很少，但任务复杂度高，该员工给出了高明的解决方案，且项目完成度很好。</li></ol><p>回顾一下前面提到的不同层级员工的差别：第 1位员工其实只是在忠实的执行，而第 2位员工表现出了高级别员工该有的基本素质——模式抽象能力，甚至表现出了解决问题的前置能力（你没看错，是解决问题的前置能力）。第2种情况在后面一般都会有个更大价值的事情，需要提前梳理和解决一些依赖问题。</p><p>要分清楚，到底是项目成就了你，还是你成就了这个项目。切忌把项目的价值等同于自己的价值！搞清楚这个关键点，面试官会选择谁，答案很显然。</p><h1 id="价值是如何被创造浪费的">3. 价值是如何被创造（浪费）的</h1><p>我们回到文章开头的那个故事，不管是研发工程师还是数据科学线的工程师，当你做完一项工作的时候，或者交付一款产品的话，下游用户使用这个产品的量越大，这个产品的价值也就越大。反之，你开发完了，但下游用户并没有人去使用，那你不如不做这个事情，因为从个人角度讲，你的时间和精力被浪费了。</p><p>我们再从团队管理的视角看一下这个事情：</p><ol type="1"><li>你做了一件你认为有意义东西，但并没有进行推广，我更倾向于说：你并不知道这个事情的价值有多大，或者说你对整个项目的理解高度并不高。</li><li>你开发完产品后并没有做推广，其他团队不知情，做了另外一款类似的东西，公司的研发资源被浪费。</li><li>两个关联团队可能发生后续资源的争夺，轻则心存芥蒂，破坏协作氛围，重则双方拆台，相互攻击。</li></ol><p>时不时有员工对我抱怨说：为什么我做出了很大的工作业绩，然而大家并不认可我？</p><blockquote><p>牛逼的三重境界：你觉得自己牛逼，别人觉得你牛逼，觉得你牛逼的人牛逼。</p></blockquote><p>小伙，请利用好一切可利用的机会：工作例会、私人交谈、周报……想尽一切办法，反复对你的下游用户兜售观念或已交付产品，直到比你牛逼的人也觉得这个很牛逼为止。</p><p>这里分享给大家一个小技巧，如果是小范围沟通的话，你可以让对方复述一遍你的陈述内容，或者你复述对方的陈述事实，这都是很好的工作习惯。</p><p>最后，请记住这条准则（比例）：</p><blockquote><p>我们创造价值的 70%来源于协作，30%来源于自己。</p></blockquote><p>不要过高的估计自己的作用，和上下游有效同步信息是创造价值的必备条件。</p><h1 id="还有成本">4. 还有成本</h1><p>想晋升，想尽办法把个人和组织的收益提高到极致，那从成本角度呢？想象以下情况：</p><ol type="1"><li>如果你没有留下足够说清楚你工作内容的文档和代码，那么你未来离开之后的潜在补救成本很高；</li><li>如果你在关键的节点上掉了链子，那么你会导致你的下游拖慢进度，潜在的人力损耗会很高；</li><li>如果你讲不清楚你的产品、你的理念，这个产品后期应用的成本会很高；</li></ol><p>你虽然有产出，甚至还不错，但带来了更多的隐性成本，这些未来的损失需要从你的工资中扣除，所以你不应该拿很高的工资。我经常半开玩笑地问团队成员一句话：</p><blockquote><p>如果我接管了一个五倍规模的新团队，你能够成为其中独当一面的 leader么？</p></blockquote><p>如果不行，你会白白浪费一个headcount，我为什么不找一个更厉害的员工替换你？回顾一下《亮剑》的经典桥段：李云龙是一个团长，攻打平安县城时，他不小心成了师长。原因是他的每个营，在那样的时间点，不论人数还是装备都已然达到团级配置（还有意大利炮）。既然有一个师的兵力和装备，当然可以攻打平安县城。</p><p>我未来必然有恶仗，如果你成长的速度不行，你是负债，对不起，请离开！</p><h1 id="我们该如何提高">5. 我们该如何提高？</h1><p>不管作为高级员工还是管理者，都需要应用元认知策略来升华自身。不废话，直接列四个重点：</p><p><strong>Situational Awareness</strong></p><p>看字面意思就大概应该能猜测出来是什么意思，前文讲的故事里和这点关系很强，不再多解释。</p><p><strong>Trade-off Analysis</strong></p><p>可以译作得失分析或取舍分析。如果是做算法的同学，应该比较清楚是什么意思。不过需要注意的是，实际工作中，我们需要自己定义alternatives，以及自己定义准则和权重，最终通过评分来考虑取舍，每个事件都不一样。</p><p><strong>Second and Third order Effects</strong></p><p>二阶和三阶影响，至少有两个层面的意义：</p><ol type="1"><li>问题背后的问题，以及三阶问题</li><li>关键人背后的关键人，以及三阶关键人</li></ol><p>第 2点稍作展开：想象一下，你是研发工程师，你听产品经理的，产品经理听业务方的，业务方听用户的……那问题来了，从职位划分上说，你要忠实地完成产品经理提过来的需求。但你确定只管产品经理的需求，这样做是对的么？多一些提示：关键人并不是自然人，而是特定场景下某些需求的集合。想象一下你的老板在讲项目，老板是关键人（需求集合），这个关键人背后的关键人是谁？</p><p><strong>Clear-Hold-Build</strong></p><p>清除-维持-重建：这个说法源自于美军的军事战术动作，在伊拉克战争时被广泛讨论和并被接受。其实也很简单，想象一下我们如果要进攻一个区域，首先要清除，再保持住占领，最后构筑自己的军事设施。任何技能知识、管理知识的学习都要经历这三步，千万不要认为自己在某个领域稍稍资深，就可以不按照CHB 的原则来操作。俗语说的“空杯心态”其实就是 Clear 的意思，但我个人认为Clear-Hold-Build 体现了全过程，更值得仔细揣摩和执行。</p><h1 id="干货">6. 干货</h1><p>最后来点更干的，当你述职的时候，灵魂七问：</p><ol type="1"><li>面对新业务时体现出的分解问题的能力？</li><li>项目过程中作为高级别员工体现出的协调和统筹能力，比如出现冲突时你的做法？</li><li>项目复盘和内部经验推广的能力？</li><li>对本部门技术框架的沉淀和总结？</li><li>技术上的前瞻性，对团队前进方向的思考和努力，包括对自己的 leader的影响力？</li><li>如何成就下属，或如何成就团队。标志性的结果是什么？</li><li>内部效率和外部效率提升的思考和行动，以及结果是什么？</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;本篇文章 2900 字，预计阅读时间为 12
分钟，建议找一个安静的时间阅读，以及隔一段时间翻出来再看。&lt;/p&gt;
&lt;p&gt;在任何一家公司，每一个对自己职业生涯有规划的员工都希望在更短的时间内晋升，这意味着更多的关注和资源倾斜，更大的责任和职责范围。当然，与之匹配的收益必然也是同步提高的。&lt;/p&gt;
&lt;p&gt;对于晋升这件事情本身，我们应该怎样理解？有哪些误解需要澄清，我们需要做什么准备？今天就花一些时间和大家聊一聊你为什么会被提名晋升，或者晋升成功。&lt;/p&gt;</summary>
    
    
    
    <category term="数据思维" scheme="http://bjt.name/categories/%E6%95%B0%E6%8D%AE%E6%80%9D%E7%BB%B4/"/>
    
    
    <category term="management" scheme="http://bjt.name/tags/management/"/>
    
  </entry>
  
  <entry>
    <title>数据分析师的生存手记</title>
    <link href="http://bjt.name/2020/01/05/make-better.html"/>
    <id>http://bjt.name/2020/01/05/make-better.html</id>
    <published>2020-01-04T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>本篇关键内容（阅读需要约 15 分钟）：</p><ol type="1"><li>分析师的职责范围</li><li>重定义：数据科学合作伙伴</li><li>数据需求的标准流程</li><li>工欲善其事，必先利其器 - tapd</li></ol><p>为什么写这篇文章？起因是分析师团队的 leader离职了，作为大老板，我只能选择暂代管理一段时间。在帮团队成员梳理工作内容的过程，我抽象了其中一些关键的要素，以及需要澄清的认知误区。这些总结我不想仅仅封闭在自己的团队内部，还希望能帮到正在职业生涯迷茫的分析师们。</p><span id="more"></span><h1 id="分析师的职责范围">1. 分析师的职责范围</h1><p>为了说清楚为什么会有后面这么庞大的逻辑体系，需要从分析师处理的主要三种类型工作说起：</p><ol type="1"><li>临时性数据需求（或专项分析报告）</li><li>快速可视化报表开发（BI）</li><li>专业角度的数据挖掘任务</li></ol><p>几乎所有人都希望承担第 3种类型工作。为什么呢——无外乎，节奏更主动，复杂度高，彰显个人的专业价值呗。第1 和 2种工作往往被贴上了被动、低价值、重复劳动这些标签。先别急着下结论，这个观点背后是因为不匹配的认知和流程而导致的，如果1 和 2不能正确的搞定，你会因为不懂业务，也不可能玩转这些所谓的专业数据挖掘任务的。</p><p>在聊正事之前先分享一个故事，故事的名字叫做《第 7个馒头》，情节很简单：</p><blockquote><p>有个老头儿饿坏了，一连吃了 6 个馒头还没吃饱，当他吃下第 7个馒头时，终于吃饱了。</p><p>于是好事者开始研究第 7个馒头的做法和用料，想从中挖决出老头吃饱的奥秘……</p></blockquote><p>这个故事周鸿祎经常挂在嘴边，虽然听起来像笑话，但实际上每天都在重复上演。想想我们在教科书、外部分享看到或听到的拍案叫绝的案例，它们都在讲第7 个馒头。我们所有的分析训练（并不是特指狭义的数据分析）都在指向研究第 7个馒头的做法和用料，而忽视了前 6 个馒头的过程和作用。</p><p>“凡战者，以正和，以奇胜”，一定要谨记：“正和”是在“奇胜”之前。临时性数据分析需求就是前6 个馒头，恰恰可以让分析师全方位、深入理解业务问题，是极佳的契机点！</p><p>核心点说清楚了，那如何解构呢？我们需要从角色定位、环节内容、机制等环节来重塑流程。</p><h1 id="角色定位和机制">2. 角色定位和机制</h1><p>传统上，我们一般定义了数据分析师、数据分析专员这两个角色。但仔细想想这两个名词的字面意义，问题其实非常大，他们居然全是面向数据的，而不是面向业务问题或者价值本身的！</p><p>更恰当的定义是什么呢？在我的团队，我把她重新定义成了 DSP（DataSciencePartner），是披着数据科学外衣的合作伙伴。不要小看这个角色定义的不同，这个角色要求数据分析师从一个被动接受需求的定位直接过渡到合作者模式。（为了保持行文和观念的一致性，后面依然会使用数据分析师的称呼）</p><p>输出决定于输入。角色重新定义之后，分析师如何获得更多的信息？如果不能够第一时间获取公司的决策信息，那么工作还是会非常被动。不同的公司有不同的操作方法，这里面给出建议的操作步骤：</p><ol type="1"><li>利用好列席其他部门的周例会的机会。既然定义为partner，那么伙伴部门的周例会必须要全程参加，以伙伴视角观察这个部门日常运作的情况，不超过一个月，分析师会在目标认知上有长足变化。</li><li>利用非工作时间（如午餐）同伙伴部门的关键人物进行一对一非正式沟通，并持续保持频率。</li><li>以上信息定期同数据部门老大做更新，得到反馈。</li></ol><p>以上动作释放给了外部一个信号，我们可以一起通过数据搞定业务问题，在有需要的第一时间马上可以找到数据分析师。在有效信息输入问题得到改善之后，分析师将面临接到需求之后如何更高效率的整合这些零散。<strong>整合的效率和1 年之后的分析师价值高度相关。</strong></p><p>注：（对于我司来说）分析师负责的十条业务线分别是：CEO、市场、运营、外教、产品、学术、用户体验、技术，财务，人力。</p><h1 id="数据分析的工作流程">3. 数据分析的工作流程</h1><blockquote><p>数据分析工作最终指向的是，通过业务问题的拆解和合并，最终形成业务问题图谱。</p></blockquote><p>先针对于单一分析任务，我把这个数据分析师的工作流程划分成了八个状态，这些状态（环节）的简要介绍如下：</p><p><imgsrc="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/analysis-workflow.png" /></p><p>"新" 这个状态是起始状态，"已拒绝" 和 "价值回顾和复盘"这两个状态是结束状态。我们逐个分析为什么在数据分析的过程中必须要这些环节？</p><h2 id="环节新">3.1. 环节：新</h2><p>这个状态是不做任何评判，纯粹从需求方角度，忠实的记录原始需求。这里只是纯粹的记录，而不进行judgment，这里借鉴了ORID焦点讨论法的第一个步骤，其中的奥妙请自行思考。</p><h2 id="环节业务确认">3.2. 环节：业务确认</h2><p>这个环节是分析师显示自身的专业能力的关键环节，也是分析任务成败的首要关键步骤。由于需求方背景不同，对于数据认知能力也参差不齐。这里面会存在几种可能：</p><ol type="1"><li>业务方无法描述问题</li><li>业务方将很多问题混杂在一起</li><li>业务方清楚面临问题，但无法和数据进行映射</li><li>业务方清楚面临问题，提出了错误的数据需求</li><li>业务方无法预判可能的分析结果</li></ol><p>对于 1 类需求方，专业技能不合格，会祸害上下游，fire掉就可以了，<strong>绝对不可以手软。</strong>（如果你是我的分析师，请告诉我这个业务是谁）</p><p>对于 2类需求方，非常普遍，因为很多人并没有经受过严格的系统化思维，分析师需要使用MECE原则帮助业务方梳理业务，在期间找到机会点。同时在梳理问题的同时，需要了解清楚什么是主要问题，什么是次要问题？什么是问题背后的问题？</p><p>对于第 3类需求方，也相对普遍，一般企业是通过角色前置来缓解这个问题，通常这个前置的角色是产品经理，不过悲剧的是前置角色可能不合格，这时又需要分析师在<sub>数据源确认</sub>环节给出专业建议。</p><p>第 4 类业务方的问题和第 3种很像，但需要单独提出来，想想一下，对方提了一个错误的数据需求，但作为分析师的你居然漂亮地执行完成了……然后业务方不满意，又提了一遍，可能还有第三遍……新手分析师应该没少吃过这个哑巴亏。</p><p>对于第 5类，我们实际上对业务方提出了更高的要求，这背后的逻辑有两层：</p><ul><li>业务方是否游刃有余的掌控业务和数据之间的所有可能关系；</li><li>如果有和预期一致的数据分析结果，那么接下来的行动方案是否值得执行。</li></ul><p><strong>如果以上两点业务方把控的非常完美，不论你是否是资深数据分析师，赶紧抱大腿！</strong>如果大腿不知道怎么抱，私信我。</p><h2 id="环节数据源确认">3.3. 环节：数据源确认</h2><p>这个环节可能会有以下几个问题：</p><ol type="1"><li>期望的数据在技术层没有存储</li><li>有数据，但数据分散在数据仓库的不同位置</li></ol><p>第 1个问题在初创公司比较常见，第一责任人是研发，顺次是产品经理，再次是业务方。如果作为分析师搞定了这个数据源问题，你实际在变相帮助产品经理和业务方，甚至是研发。久而久之，你的技术层面影响力会得到持续强化。</p><p>第 2个问题体现了数据仓库设计的不完备。这种情况下，首先判断是否是经常性问题，如果不是，临时解决即可；如果是，有两种策略：</p><ol type="1"><li>告知数据仓库开发对应负责人，等待预期数据结果的交付；</li><li>主动了解底层的数据逻辑，在 ODS层做二次处理，在临时数据层形成结果集，最终将工程化的代码交付数据仓库团队。</li></ol><p>考虑到分析师团队一般同仓库团队隶属于同一个大部门，持续保持这个习惯，也会增强分析师的内部影响力。</p><h2 id="环节实现中">3.4. 环节：实现中</h2><p>这个步骤需要强调的点是如何利用 git 管理好自己的分析代码，以 R为例，尽量使用<code>magrittr</code>、<code>dplyr</code>、<code>dtplyr</code>这类的包，保证数据处理的每个步骤的可读性。同时保证代码内的注释以及 gitcommit 的信息完整性。</p><p>分析师会通过 HIVE SQL 提取数据，再通过 R进行处理，如何设计取数逻辑，利用好 HIVE SQL 和 R两种工具的各自优点，提高数据处理的可理解性和速度，考验的就是基本功了。</p><p>这里多讲一下工具的使用，如果大量使用 R Notebook这类工具，会让你的效率大大提高。</p><h2 id="环节交付">3.5. 环节：交付</h2><p>强调无数次：</p><blockquote><p>从数据到结论！</p></blockquote><p>如果分析师没有结论则不能称之为交付。交付的形式有文档、幻灯片、邮件，不同交付形式会有一些不一样的要求，对于分析师来说幻灯片交付要求最高。未来可能会专门写篇文章来讲述如何做幻灯片（注意slides 不等于 PPT）。</p><p>交付的内容从要素上来说包含文字、表格、图形。文字内容部分是在业务确认环节中梳理的逻辑深度，表格也不详细赘述，在分析的过程如何确定一张合理的图形呢？这里面有一些套路，偷懒了，直接给出一个前人总结的经验：</p><p><imgsrc="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/chart_suggestions.jpg" /></p><h2 id="环节价值回顾和复盘">3.6. 环节：价值回顾和复盘</h2><ol type="1"><li><p>初级分析师经常会在这个环节出现失误，我经常在 review各位分析师项目时会发现，很多项目会停滞在<sub>交付</sub>这个环节，习惯的力量太可怕。这个环节的两个关键点：价值的判断和复盘。</p><p>价值判断至少存在两方面考量：</p><ol type="1"><li>通过分析得到的关键正确决策，影响公司某项进程的直接价值。锻炼的是分析师业务sense 能力；</li><li>个人有限的时间带来的收益，投入产出比。锻炼的是分析师时间规划能力和判断力。</li></ol></li></ol><p>复盘（After ActionReview）这个话题很大，在这个节点我们稍稍聚焦一下：</p><ol type="1"><li>为什么和初始的目标相差很远？关键的事件是什么？</li><li>重新做一遍这个需求，哪些行为需要开始做？那些事情需要停止做？哪些事情需要持续做？</li><li>以上不限于技术、流程、环境、组织、人员的一切因素。</li></ol><h2 id="状态的流转">3.7. 状态的流转</h2><p>已拒绝和挂起两种状态不做更多的赘述。最后我们再看看这 8个状态的流转关系：</p><img src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjI4N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NTU2cHg7aGVpZ2h0OjI4N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDU1NiAyODciIHdpZHRoPSI1NTZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxnPjx0aXRsZT4mIzI2MDMyOzwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjIxNiIgd2lkdGg9IjgiIHg9IjE1IiB5PSIzNi4yOTY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjE4IiB4Mj0iMTgiIHkxPSIzNi4yOTY5IiB5Mj0iMjUyLjI5NjkiLz48L2c+PGc+PHRpdGxlPiYjMTk5OTQ7JiMyMTE1MzsmIzMwODMwOyYjMzU3NDg7PC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMjE2IiB3aWR0aD0iOCIgeD0iNzMuOTk5OCIgeT0iMzYuMjk2OSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSI3Ni45OTk5IiB4Mj0iNzYuOTk5OSIgeTE9IjM2LjI5NjkiIHkyPSIyNTIuMjk2OSIvPjwvZz48Zz48dGl0bGU+JiMyNTk2ODsmIzI1NDU0OyYjMjgzMDQ7JiMzMDgzMDsmIzM1NzQ4OzwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjIxNiIgd2lkdGg9IjgiIHg9IjE2MC45OTk1IiB5PSIzNi4yOTY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjE2My45OTk3IiB4Mj0iMTYzLjk5OTciIHkxPSIzNi4yOTY5IiB5Mj0iMjUyLjI5NjkiLz48L2c+PGc+PHRpdGxlPiYjMjM0NTQ7JiMyOTYxNjsmIzIwMDEzOzwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjIxNiIgd2lkdGg9IjgiIHg9IjI0MC45OTkzIiB5PSIzNi4yOTY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjI0My45OTk0IiB4Mj0iMjQzLjk5OTQiIHkxPSIzNi4yOTY5IiB5Mj0iMjUyLjI5NjkiLz48L2c+PGc+PHRpdGxlPiYjMjAxMzI7JiMyMDE4NDs8L3RpdGxlPjxyZWN0IGZpbGw9IiMwMDAwMDAiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSIyMTYiIHdpZHRoPSI4IiB4PSIyOTkuOTk5MSIgeT0iMzYuMjk2OSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIzMDIuOTk5MiIgeDI9IjMwMi45OTkyIiB5MT0iMzYuMjk2OSIgeTI9IjI1Mi4yOTY5Ii8+PC9nPjxnPjx0aXRsZT4mIzIwMjE1OyYjMjA1NDA7JiMyMjIzODsmIzM5MDM4OyYjMjE2NDQ7JiMyMjc5NzsmIzMwNDI0OzwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjIxNiIgd2lkdGg9IjgiIHg9IjM4Ni45OTg5IiB5PSIzNi4yOTY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjM4OS45OTkxIiB4Mj0iMzg5Ljk5OTEiIHkxPSIzNi4yOTY5IiB5Mj0iMjUyLjI5NjkiLz48L2c+PGc+PHRpdGxlPiYjMjUzNDY7JiMzNjIxNTs8L3RpdGxlPjxyZWN0IGZpbGw9IiMwMDAwMDAiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSIyMTYiIHdpZHRoPSI4IiB4PSI0NzMuOTk4NiIgeT0iMzYuMjk2OSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSI0NzYuOTk4NyIgeDI9IjQ3Ni45OTg3IiB5MT0iMzYuMjk2OSIgeTI9IjI1Mi4yOTY5Ii8+PC9nPjxnPjx0aXRsZT4mIzI1Mjk4OyYjMzI0Nzc7PC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMjE2IiB3aWR0aD0iOCIgeD0iNTI1Ljk5ODUiIHk9IjM2LjI5NjkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iNTI4Ljk5ODUiIHgyPSI1MjguOTk4NSIgeTE9IjM2LjI5NjkiIHkyPSIyNTIuMjk2OSIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0iJiMyNjAzMjsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjcuOTk5OSIgeD0iNSIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzLjk5OTkiIHg9IjEyIiB5PSIyNC45OTUxIj4mIzI2MDMyOzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtcGFydGljaXBhbnQ9IiYjMjYwMzI7Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI3Ljk5OTkiIHg9IjUiIHk9IjI1MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMuOTk5OSIgeD0iMTIiIHk9IjI3MS4yOTIiPiYjMjYwMzI7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0iJiMxOTk5NDsmIzIxMTUzOyYjMzA4MzA7JiMzNTc0ODsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iNDIuOTk5OSIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjQ5Ljk5OTkiIHk9IjI0Ljk5NTEiPiYjMTk5OTQ7JiMyMTE1MzsmIzMwODMwOyYjMzU3NDg7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0iJiMxOTk5NDsmIzIxMTUzOyYjMzA4MzA7JiMzNTc0ODsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iNDIuOTk5OSIgeT0iMjUxLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSI0OS45OTk5IiB5PSIyNzEuMjkyIj4mIzE5OTk0OyYjMjExNTM7JiMzMDgzMDsmIzM1NzQ4OzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtcGFydGljaXBhbnQ9IiYjMjU5Njg7JiMyNTQ1NDsmIzI4MzA0OyYjMzA4MzA7JiMzNTc0ODsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iODMuOTk5NyIgeD0iMTIyLjk5OTciIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIxMjkuOTk5NyIgeT0iMjQuOTk1MSI+JiMyNTk2ODsmIzI1NDU0OyYjMjgzMDQ7JiMzMDgzMDsmIzM1NzQ4OzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtcGFydGljaXBhbnQ9IiYjMjU5Njg7JiMyNTQ1NDsmIzI4MzA0OyYjMzA4MzA7JiMzNTc0ODsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iODMuOTk5NyIgeD0iMTIyLjk5OTciIHk9IjI1MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTI5Ljk5OTciIHk9IjI3MS4yOTIiPiYjMjU5Njg7JiMyNTQ1NDsmIzI4MzA0OyYjMzA4MzA7JiMzNTc0ODs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC1oZWFkIiBkYXRhLXBhcnRpY2lwYW50PSImIzIzNDU0OyYjMjk2MTY7JiMyMDAxMzsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTUuOTk5OCIgeD0iMjE2Ljk5OTQiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS45OTk4IiB4PSIyMjMuOTk5NCIgeT0iMjQuOTk1MSI+JiMyMzQ1NDsmIzI5NjE2OyYjMjAwMTM7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0iJiMyMzQ1NDsmIzI5NjE2OyYjMjAwMTM7Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1Ljk5OTgiIHg9IjIxNi45OTk0IiB5PSIyNTEuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxLjk5OTgiIHg9IjIyMy45OTk0IiB5PSIyNzEuMjkyIj4mIzIzNDU0OyYjMjk2MTY7JiMyMDAxMzs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC1oZWFkIiBkYXRhLXBhcnRpY2lwYW50PSImIzIwMTMyOyYjMjAxODQ7Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQxLjk5OTkiIHg9IjI4Mi45OTkyIiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjcuOTk5OSIgeD0iMjg5Ljk5OTIiIHk9IjI0Ljk5NTEiPiYjMjAxMzI7JiMyMDE4NDs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSImIzIwMTMyOyYjMjAxODQ7Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQxLjk5OTkiIHg9IjI4Mi45OTkyIiB5PSIyNTEuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjI4OS45OTkyIiB5PSIyNzEuMjkyIj4mIzIwMTMyOyYjMjAxODQ7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0iJiMyMDIxNTsmIzIwNTQwOyYjMjIyMzg7JiMzOTAzODsmIzIxNjQ0OyYjMjI3OTc7JiMzMDQyNDsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTExLjk5OTYiIHg9IjMzNC45OTkxIiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzQxLjk5OTEiIHk9IjI0Ljk5NTEiPiYjMjAyMTU7JiMyMDU0MDsmIzIyMjM4OyYjMzkwMzg7JiMyMTY0NDsmIzIyNzk3OyYjMzA0MjQ7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0iJiMyMDIxNTsmIzIwNTQwOyYjMjIyMzg7JiMzOTAzODsmIzIxNjQ0OyYjMjI3OTc7JiMzMDQyNDsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTExLjk5OTYiIHg9IjMzNC45OTkxIiB5PSIyNTEuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjM0MS45OTkxIiB5PSIyNzEuMjkyIj4mIzIwMjE1OyYjMjA1NDA7JiMyMjIzODsmIzM5MDM4OyYjMjE2NDQ7JiMyMjc5NzsmIzMwNDI0OzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtcGFydGljaXBhbnQ9IiYjMjUzNDY7JiMzNjIxNTsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDEuOTk5OSIgeD0iNDU2Ljk5ODciIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy45OTk5IiB4PSI0NjMuOTk4NyIgeT0iMjQuOTk1MSI+JiMyNTM0NjsmIzM2MjE1OzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtcGFydGljaXBhbnQ9IiYjMjUzNDY7JiMzNjIxNTsiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDEuOTk5OSIgeD0iNDU2Ljk5ODciIHk9IjI1MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjcuOTk5OSIgeD0iNDYzLjk5ODciIHk9IjI3MS4yOTIiPiYjMjUzNDY7JiMzNjIxNTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC1oZWFkIiBkYXRhLXBhcnRpY2lwYW50PSImIzI1Mjk4OyYjMzI0Nzc7Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQxLjk5OTkiIHg9IjUwOC45OTg1IiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjcuOTk5OSIgeD0iNTE1Ljk5ODUiIHk9IjI0Ljk5NTEiPiYjMjUyOTg7JiMzMjQ3Nzs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSImIzI1Mjk4OyYjMzI0Nzc7Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQxLjk5OTkiIHg9IjUwOC45OTg1IiB5PSIyNTEuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjUxNS45OTg1IiB5PSIyNzEuMjkyIj4mIzI1Mjk4OyYjMzI0Nzc7PC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSImIzI2MDMyOyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzE5OTk0OyYjMjExNTM7JiMzMDgzMDsmIzM1NzQ4OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NS45OTk4LDQ4LjI5NjksNzUuOTk5OCw1Mi4yOTY5LDY1Ljk5OTgsNTYuMjk2OSw2OS45OTk4LDUyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjE5IiB4Mj0iNzEuOTk5OCIgeTE9IjUyLjI5NjkiIHkyPSI1Mi4yOTY5Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IiYjMTk5OTQ7JiMyMTE1MzsmIzMwODMwOyYjMzU3NDg7IiBkYXRhLXBhcnRpY2lwYW50LTI9IiYjMjU5Njg7JiMyNTQ1NDsmIzI4MzA0OyYjMzA4MzA7JiMzNTc0ODsiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTUyLjk5OTUsNjIuMjk2OSwxNjIuOTk5NSw2Ni4yOTY5LDE1Mi45OTk1LDcwLjI5NjksMTU2Ljk5OTUsNjYuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iNzcuOTk5OCIgeDI9IjE1OC45OTk1IiB5MT0iNjYuMjk2OSIgeTI9IjY2LjI5NjkiLz48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtcGFydGljaXBhbnQtMT0iJiMyNTk2ODsmIzI1NDU0OyYjMjgzMDQ7JiMzMDgzMDsmIzM1NzQ4OyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzIzNDU0OyYjMjk2MTY7JiMyMDAxMzsiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjMyLjk5OTMsNzYuMjk2OSwyNDIuOTk5Myw4MC4yOTY5LDIzMi45OTkzLDg0LjI5NjksMjM2Ljk5OTMsODAuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMTY0Ljk5OTUiIHgyPSIyMzguOTk5MyIgeTE9IjgwLjI5NjkiIHkyPSI4MC4yOTY5Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IiYjMjM0NTQ7JiMyOTYxNjsmIzIwMDEzOyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzE5OTk0OyYjMjExNTM7JiMzMDgzMDsmIzM1NzQ4OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI4OC45OTk4LDkwLjI5NjksNzguOTk5OCw5NC4yOTY5LDg4Ljk5OTgsOTguMjk2OSw4NC45OTk4LDk0LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjgyLjk5OTgiIHgyPSIyNDMuOTk5MyIgeTE9Ijk0LjI5NjkiIHkyPSI5NC4yOTY5Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IiYjMjM0NTQ7JiMyOTYxNjsmIzIwMDEzOyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzI1OTY4OyYjMjU0NTQ7JiMyODMwNDsmIzMwODMwOyYjMzU3NDg7Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3NS45OTk1LDEwNC4yOTY5LDE2NS45OTk1LDEwOC4yOTY5LDE3NS45OTk1LDExMi4yOTY5LDE3MS45OTk1LDEwOC4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Mi4wLDIuMDsiIHgxPSIxNjkuOTk5NSIgeDI9IjI0My45OTkzIiB5MT0iMTA4LjI5NjkiIHkyPSIxMDguMjk2OSIvPjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSImIzIzNDU0OyYjMjk2MTY7JiMyMDAxMzsiIGRhdGEtcGFydGljaXBhbnQtMj0iJiMyMDEzMjsmIzIwMTg0OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyOTEuOTk5MSwxMTguMjk2OSwzMDEuOTk5MSwxMjIuMjk2OSwyOTEuOTk5MSwxMjYuMjk2OSwyOTUuOTk5MSwxMjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMjQ0Ljk5OTMiIHgyPSIyOTcuOTk5MSIgeTE9IjEyMi4yOTY5IiB5Mj0iMTIyLjI5NjkiLz48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtcGFydGljaXBhbnQtMT0iJiMyMDEzMjsmIzIwMTg0OyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzIwMjE1OyYjMjA1NDA7JiMyMjIzODsmIzM5MDM4OyYjMjE2NDQ7JiMyMjc5NzsmIzMwNDI0OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzguOTk4OSwxMzIuMjk2OSwzODguOTk4OSwxMzYuMjk2OSwzNzguOTk4OSwxNDAuMjk2OSwzODIuOTk4OSwxMzYuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMzAzLjk5OTEiIHgyPSIzODQuOTk4OSIgeTE9IjEzNi4yOTY5IiB5Mj0iMTM2LjI5NjkiLz48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtcGFydGljaXBhbnQtMT0iJiMxOTk5NDsmIzIxMTUzOyYjMzA4MzA7JiMzNTc0ODsiIGRhdGEtcGFydGljaXBhbnQtMj0iJiMyNTM0NjsmIzM2MjE1OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0NjUuOTk4NiwxNDYuMjk2OSw0NzUuOTk4NiwxNTAuMjk2OSw0NjUuOTk4NiwxNTQuMjk2OSw0NjkuOTk4NiwxNTAuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iNzcuOTk5OCIgeDI9IjQ3MS45OTg2IiB5MT0iMTUwLjI5NjkiIHkyPSIxNTAuMjk2OSIvPjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSImIzE5OTk0OyYjMjExNTM7JiMzMDgzMDsmIzM1NzQ4OyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzI1Mjk4OyYjMzI0Nzc7Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUxNy45OTg1LDE2MC4yOTY5LDUyNy45OTg1LDE2NC4yOTY5LDUxNy45OTg1LDE2OC4yOTY5LDUyMS45OTg1LDE2NC4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Mi4wLDIuMDsiIHgxPSI3Ny45OTk4IiB4Mj0iNTIzLjk5ODUiIHkxPSIxNjQuMjk2OSIgeTI9IjE2NC4yOTY5Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IiYjMjU5Njg7JiMyNTQ1NDsmIzI4MzA0OyYjMzA4MzA7JiMzNTc0ODsiIGRhdGEtcGFydGljaXBhbnQtMj0iJiMxOTk5NDsmIzIxMTUzOyYjMzA4MzA7JiMzNTc0ODsiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iODguOTk5OCwxNzQuMjk2OSw3OC45OTk4LDE3OC4yOTY5LDg4Ljk5OTgsMTgyLjI5NjksODQuOTk5OCwxNzguMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iODIuOTk5OCIgeDI9IjE2My45OTk1IiB5MT0iMTc4LjI5NjkiIHkyPSIxNzguMjk2OSIvPjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSImIzI1OTY4OyYjMjU0NTQ7JiMyODMwNDsmIzMwODMwOyYjMzU3NDg7IiBkYXRhLXBhcnRpY2lwYW50LTI9IiYjMjUzNDY7JiMzNjIxNTsiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDY1Ljk5ODYsMTg4LjI5NjksNDc1Ljk5ODYsMTkyLjI5NjksNDY1Ljk5ODYsMTk2LjI5NjksNDY5Ljk5ODYsMTkyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjE2NC45OTk1IiB4Mj0iNDcxLjk5ODYiIHkxPSIxOTIuMjk2OSIgeTI9IjE5Mi4yOTY5Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IiYjMjU5Njg7JiMyNTQ1NDsmIzI4MzA0OyYjMzA4MzA7JiMzNTc0ODsiIGRhdGEtcGFydGljaXBhbnQtMj0iJiMyNTI5ODsmIzMyNDc3OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1MTcuOTk4NSwyMDIuMjk2OSw1MjcuOTk4NSwyMDYuMjk2OSw1MTcuOTk4NSwyMTAuMjk2OSw1MjEuOTk4NSwyMDYuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMTY0Ljk5OTUiIHgyPSI1MjMuOTk4NSIgeTE9IjIwNi4yOTY5IiB5Mj0iMjA2LjI5NjkiLz48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtcGFydGljaXBhbnQtMT0iJiMyNTM0NjsmIzM2MjE1OyIgZGF0YS1wYXJ0aWNpcGFudC0yPSImIzE5OTk0OyYjMjExNTM7JiMzMDgzMDsmIzM1NzQ4OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI4OC45OTk4LDIxNi4yOTY5LDc4Ljk5OTgsMjIwLjI5NjksODguOTk5OCwyMjQuMjk2OSw4NC45OTk4LDIyMC4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Mi4wLDIuMDsiIHgxPSI4Mi45OTk4IiB4Mj0iNDc2Ljk5ODYiIHkxPSIyMjAuMjk2OSIgeTI9IjIyMC4yOTY5Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IiYjMjUzNDY7JiMzNjIxNTsiIGRhdGEtcGFydGljaXBhbnQtMj0iJiMyNTk2ODsmIzI1NDU0OyYjMjgzMDQ7JiMzMDgzMDsmIzM1NzQ4OyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzUuOTk5NSwyMzAuMjk2OSwxNjUuOTk5NSwyMzQuMjk2OSwxNzUuOTk5NSwyMzguMjk2OSwxNzEuOTk5NSwyMzQuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMTY5Ljk5OTUiIHgyPSI0NzYuOTk4NiIgeTE9IjIzNC4yOTY5IiB5Mj0iMjM0LjI5NjkiLz48L2c+PCEtLVNSQz1bS3Rlc1JPRUlXZ3drZE9CSWFuc3BkZE9qVkJ2bXRPanJJdkl1S0JhRzVTLWNSZFpNay14UGhXYm1IVVdZNDdMRnJ5cnh0aFZYb093ckcxSzhEYlBScUFLbmhTMG1PRFVJOXhqZFcxbThPSzE1VHN6X3NoM2R3VW52Qm5Wa1VwZ2Z2LWNJdGtVcFAtM21IS19KWXd0UlNTWHJKdGctVW92RVp3NHY3aGlZa0ZhdWZFNU1HREhYRG5iUDNqcVMwMDAwXS0tPjwvZz48L3N2Zz4='><p>以上描述的是一个数据需求的状态定义和流转过程。反复多轮之后，分析师必须通过问题的分解和合并技巧，以及价值排序判断，形成自己的业务知识图谱，这项能力是不可复制的，切记！</p><h1 id="利其器">4. 利其器</h1><p>好记性不如烂笔头，上述道理大家似乎都明白，但真正在执行的时候，很多人会犯错误。强烈分析师团队利用好公司级的项目管理（敏捷开发）工具，比如我们正在使用的tapd，或者 jira 这些都可以。</p><p>拿 tapd 来说，可以自定义workflow，标签，包括消息等，实在太方便。除了记录数据分析需求，tapd还可以帮我们记录平时分析师内部自行发起的需求，比如前文一笔带过的数据挖掘任务或专项分析。</p><p>以及 R 是做数据分析最好的工具，没有之一，不接受反驳<imgsrc="https://res.wx.qq.com/mpres/htmledition/images/icon/common/emotion_panel/smiley/smiley_23.png"alt="img" /></p><p>最后我们再总结一下前面的内容：数据分析师如果希望在职场生存的舒适，角色越来越关键，一定要注意创造好有利的信息输入环境，要么自己行动，要么对老板提要求；在工作职责范围，做好自己的预期管理，分析师的工作不是一锤子买卖，需要统筹好工作的层次和先后顺序；在每个分析需求的完成都要通过前面提到的8 步法，反复锻炼自己抽象和结构问题的能力。</p><p>相信，各位分析师会玩的越来越开心。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本篇关键内容（阅读需要约 15 分钟）：&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;分析师的职责范围&lt;/li&gt;
&lt;li&gt;重定义：数据科学合作伙伴&lt;/li&gt;
&lt;li&gt;数据需求的标准流程&lt;/li&gt;
&lt;li&gt;工欲善其事，必先利其器 - tapd&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;为什么写这篇文章？起因是分析师团队的 leader
离职了，作为大老板，我只能选择暂代管理一段时间。在帮团队成员梳理工作内容的过程，我抽象了其中一些关键的要素，以及需要澄清的认知误区。这些总结我不想仅仅封闭在自己的团队内部，还希望能帮到正在职业生涯迷茫的分析师们。&lt;/p&gt;</summary>
    
    
    
    <category term="数据思维" scheme="http://bjt.name/categories/%E6%95%B0%E6%8D%AE%E6%80%9D%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>在 R 中各种码的转换</title>
    <link href="http://bjt.name/2019/10/21/url-handle.html"/>
    <id>http://bjt.name/2019/10/21/url-handle.html</id>
    <published>2019-10-20T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>各位看官在平时用 R处理网页的过程中，一定会被各种乱码、转码所困扰，这里做一些小型的总结，会涉及到：</p><ol type="1"><li>encode 和 decode</li><li>md5 加密</li><li>字符集转换</li><li>繁体转化为简体</li><li>字体的指定</li></ol><p>逐个解释如何处理：</p><p>Encode 和 Decode 处理最为简单，因为在 R 中自带的 utils就存在方法，具体函数是 <code>URLencode</code> 和<code>URLdecode</code>。</p><span id="more"></span><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> URLencode<span class="punctuation">(</span><span class="string">&#x27;我是谁&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;%E6%88%91%E6%98%AF%E8%B0%81&quot;</span></span><br><span class="line"><span class="operator">&gt;</span> URLdecode<span class="punctuation">(</span><span class="string">&quot;%E6%88%91%E6%98%AF%E8%B0%81&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;我是谁&quot;</span></span><br></pre></td></tr></table></figure><p>Md5 加密使用 openssl 中的 <code>md5</code> 函数即可，同理<code>sha256</code> 和 <code>sha512</code> 加密算法。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>openssl<span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> md5<span class="punctuation">(</span><span class="string">&#x27;我是谁&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;0bb5fa2e7bd96c77ae436ff352e3664d&quot;</span></span><br><span class="line"><span class="operator">&gt;</span> sha256<span class="punctuation">(</span><span class="string">&#x27;我是谁&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;63621be272d0f8266518e62bc739d97793c03b8b70a077345ce20914410de441&quot;</span></span><br></pre></td></tr></table></figure><p>字符集转化使用的是自带 base 包中的 <code>iconv</code>函数，可以将两种字符集任意转换。</p><p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> iconv<span class="punctuation">(</span><span class="string">&#x27;我是谁&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;UTF-8&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;GBK&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;\xce\xd2\xca\xc7˭&quot;</span></span><br></pre></td></tr></table></figure></p><p>简繁体转化，需要使用 <code>ropencc</code> 这个包</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ropencc<span class="punctuation">)</span></span><br><span class="line">cc <span class="operator">=</span> converter<span class="punctuation">(</span>S2T<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## T2S means Traditional Chinese to Simplified Chinese.</span></span><br><span class="line"><span class="comment">## S2T means Simplified Chinese to Traditional Chinese.</span></span><br><span class="line">run_convert<span class="punctuation">(</span>cc<span class="punctuation">,</span> <span class="string">&#x27;我是谁&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;我是誰&quot;</span></span><br></pre></td></tr></table></figure><p>字体一般可以通过全局变量 par 中的 family来设定，但有些需要特殊设定，比如 igraph 包中的绘图情况：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>igraph<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">x <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span>textConnection<span class="punctuation">(</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">物理,化学</span></span><br><span class="line"><span class="string">化学,生物</span></span><br><span class="line"><span class="string">英语,数学</span></span><br><span class="line"><span class="string">数学,语文</span></span><br><span class="line"><span class="string">语文,化学&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&#x27;,&#x27;</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">x <span class="operator">&lt;-</span> x <span class="operator">%&gt;%</span></span><br><span class="line">  mutate<span class="punctuation">(</span></span><br><span class="line">    V1 <span class="operator">=</span> iconv<span class="punctuation">(</span>V1<span class="punctuation">,</span> <span class="string">&#x27;UTF-8&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;UTF-8&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    V2 <span class="operator">=</span> iconv<span class="punctuation">(</span>V2<span class="punctuation">,</span> <span class="string">&#x27;UTF-8&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;UTF-8&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">g <span class="operator">&lt;-</span> graph_from_data_frame<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">plot<span class="punctuation">(</span>g<span class="punctuation">,</span> vertex.label.family<span class="operator">=</span> <span class="string">&#x27;Noto Sans SC Light&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;各位看官在平时用 R
处理网页的过程中，一定会被各种乱码、转码所困扰，这里做一些小型的总结，会涉及到：&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;encode 和 decode&lt;/li&gt;
&lt;li&gt;md5 加密&lt;/li&gt;
&lt;li&gt;字符集转换&lt;/li&gt;
&lt;li&gt;繁体转化为简体&lt;/li&gt;
&lt;li&gt;字体的指定&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;逐个解释如何处理：&lt;/p&gt;
&lt;p&gt;Encode 和 Decode 处理最为简单，因为在 R 中自带的 utils
就存在方法，具体函数是 &lt;code&gt;URLencode&lt;/code&gt; 和
&lt;code&gt;URLdecode&lt;/code&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="R 技巧" scheme="http://bjt.name/categories/R-%E6%8A%80%E5%B7%A7/"/>
    
    
  </entry>
  
  <entry>
    <title>2019 年建议阅读书目</title>
    <link href="http://bjt.name/2019/10/05/zhihu-reading.html"/>
    <id>http://bjt.name/2019/10/05/zhihu-reading.html</id>
    <published>2019-10-04T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>国庆期间闲逛知乎，恰巧碰到一则问题 <ahref="https://www.zhihu.com/question/306249128">2019年你的书单有什么书？</a>，这个问题有</p><blockquote><p>988 个回答，18326 个关注者，284 万的浏览量</p></blockquote><p>接近 1000个回答，全部翻完且不说时间会爆炸，脑子里能不能记住这些信息更是问题。如果能抓取每个回答列出来的书名，汇总以后便是这988 个回答者的书目投票。方法虽说暴力，但也算是变相了解大家在 2019年的阅读倾向。工具呢？当然是我擅长使用的 R 了，哈哈！</p><p>闲话不多说，直接给出结果（大于 10 位回答者提及的书目）：</p><span id="more"></span><table><thead><tr class="header"><th style="text-align: left;">书名</th><th style="text-align: right;">提到的数量</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">《人类简史》</td><td style="text-align: right;">35</td></tr><tr class="even"><td style="text-align: left;">《乌合之众》</td><td style="text-align: right;">33</td></tr><tr class="odd"><td style="text-align: left;">《三体》</td><td style="text-align: right;">29</td></tr><tr class="even"><td style="text-align: left;">《如何阅读一本书》</td><td style="text-align: right;">25</td></tr><tr class="odd"><td style="text-align: left;">《白夜行》</td><td style="text-align: right;">25</td></tr><tr class="even"><td style="text-align: left;">《红楼梦》</td><td style="text-align: right;">24</td></tr><tr class="odd"><td style="text-align: left;">《平凡的世界》</td><td style="text-align: right;">24</td></tr><tr class="even"><td style="text-align: left;">《霍乱时期的爱情》</td><td style="text-align: right;">24</td></tr><tr class="odd"><td style="text-align: left;">《百年孤独》</td><td style="text-align: right;">23</td></tr><tr class="even"><td style="text-align: left;">《亲密关系》</td><td style="text-align: right;">22</td></tr><tr class="odd"><td style="text-align: left;">《非暴力沟通》</td><td style="text-align: right;">22</td></tr><tr class="even"><td style="text-align: left;">《月亮与六便士》</td><td style="text-align: right;">22</td></tr><tr class="odd"><td style="text-align: left;">《活着》</td><td style="text-align: right;">22</td></tr><tr class="even"><td style="text-align: left;">《围城》</td><td style="text-align: right;">20</td></tr><tr class="odd"><td style="text-align: left;">《人间失格》</td><td style="text-align: right;">19</td></tr><tr class="even"><td style="text-align: left;">《毛泽东选集》</td><td style="text-align: right;">17</td></tr><tr class="odd"><td style="text-align: left;">《浮生六记》</td><td style="text-align: right;">17</td></tr><tr class="even"><td style="text-align: left;">《挪威的森林》</td><td style="text-align: right;">16</td></tr><tr class="odd"><td style="text-align: left;">《小王子》</td><td style="text-align: right;">16</td></tr><tr class="even"><td style="text-align: left;">《未来简史》</td><td style="text-align: right;">16</td></tr><tr class="odd"><td style="text-align: left;">《少有人走的路》</td><td style="text-align: right;">16</td></tr><tr class="even"><td style="text-align: left;">《白鹿原》</td><td style="text-align: right;">16</td></tr><tr class="odd"><td style="text-align: left;">《苏菲的世界》</td><td style="text-align: right;">15</td></tr><tr class="even"><td style="text-align: left;">《原则》</td><td style="text-align: right;">15</td></tr><tr class="odd"><td style="text-align: left;">《万历十五年》</td><td style="text-align: right;">15</td></tr><tr class="even"><td style="text-align: left;">《国富论》</td><td style="text-align: right;">15</td></tr><tr class="odd"><td style="text-align: left;">《金字塔原理》</td><td style="text-align: right;">15</td></tr><tr class="even"><td style="text-align: left;">《我们仨》</td><td style="text-align: right;">15</td></tr><tr class="odd"><td style="text-align: left;">《局外人》</td><td style="text-align: right;">14</td></tr><tr class="even"><td style="text-align: left;">《西方哲学史》</td><td style="text-align: right;">14</td></tr><tr class="odd"><td style="text-align: left;">《乡土中国》</td><td style="text-align: right;">14</td></tr><tr class="even"><td style="text-align: left;">《影响力》</td><td style="text-align: right;">13</td></tr><tr class="odd"><td style="text-align: left;">《穷查理宝典》</td><td style="text-align: right;">13</td></tr><tr class="even"><td style="text-align: left;">《诗经》</td><td style="text-align: right;">13</td></tr><tr class="odd"><td style="text-align: left;">《1984》</td><td style="text-align: right;">13</td></tr><tr class="even"><td style="text-align: left;">《娱乐至死》</td><td style="text-align: right;">12</td></tr><tr class="odd"><td style="text-align: left;">《菊与刀》</td><td style="text-align: right;">12</td></tr><tr class="even"><td style="text-align: left;">《自控力》</td><td style="text-align: right;">12</td></tr><tr class="odd"><td style="text-align: left;">《自卑与超越》</td><td style="text-align: right;">12</td></tr><tr class="even"><td style="text-align: left;">《人性的弱点》</td><td style="text-align: right;">12</td></tr><tr class="odd"><td style="text-align: left;">《房思琪的初恋乐园》</td><td style="text-align: right;">12</td></tr><tr class="even"><td style="text-align: left;">《学会提问》</td><td style="text-align: right;">11</td></tr><tr class="odd"><td style="text-align: left;">《全球通史》</td><td style="text-align: right;">11</td></tr><tr class="even"><td style="text-align: left;">《雪国》</td><td style="text-align: right;">11</td></tr><tr class="odd"><td style="text-align: left;">《今日简史》</td><td style="text-align: right;">11</td></tr><tr class="even"><td style="text-align: left;">《道德经》</td><td style="text-align: right;">11</td></tr><tr class="odd"><td style="text-align: left;">《社会心理学》</td><td style="text-align: right;">11</td></tr><tr class="even"><td style="text-align: left;">《史记》</td><td style="text-align: right;">11</td></tr><tr class="odd"><td style="text-align: left;">《许三观卖血记》</td><td style="text-align: right;">11</td></tr><tr class="even"><td style="text-align: left;">《薛兆丰经济学讲义》</td><td style="text-align: right;">10</td></tr><tr class="odd"><td style="text-align: left;">《瓦尔登湖》</td><td style="text-align: right;">10</td></tr><tr class="even"><td style="text-align: left;">《黄金时代》</td><td style="text-align: right;">10</td></tr><tr class="odd"><td style="text-align: left;">《杀死一只知更鸟》</td><td style="text-align: right;">10</td></tr><tr class="even"><td style="text-align: left;">《月亮和六便士》</td><td style="text-align: right;">10</td></tr></tbody></table><p>这份书单我大概都知道名字，但真正读完的不超过1/4，比如很早就读完的《1984》、《史记》、《人性的弱点》，《人类简史》、《金字塔原理》、《穷查理宝典》。但像《三体》拖拉了很久，买了该有5、6年了，依然还在垫显示器。有些书看过一些影视作品，比如《活着》、《平凡的世界》、《红楼梦》等。</p><p>《如何阅读一本书》读了两遍，确实值得细细的品读。《毛泽东选集》被人推荐了好几年，今年才算开始了正式的阅读，收获真的很大。包括《薛兆丰经济学讲义》、《原则》，这些是近两年内读的，内容非常不错。综上，这个书单的质量还是非常不错的。通过这个书单对比一下脑海里感兴趣的内容，接下来几个月的阅读计划顺次是：</p><ol type="1"><li>《国富论》</li><li>《西方哲学史》</li><li>《菊与刀》</li><li>《自控力》</li><li>《自卑与超越》</li><li>《学会提问》</li></ol><p>大约会在过年前完成这个计划。</p><p>最后再说一下这个知乎 R 爬虫，代码量很少，全部代码 95行，核心代码不超过 40 行。基本的思路如下：</p><ol type="1"><li>找到知乎返回内容的 api，这个稍稍会花一些时间</li><li>通过了解 api 的结果设计爬虫的逻辑</li><li>用<code>《*?》</code> 的正则表达式，解析每篇'回答'中的所有书名</li><li>统计所有书名出现的次数，完工</li></ol><p>当然也可以通过书和书之间的协同关系给出网络图，谁有兴趣可以提供我一下后续内容，我暂时没时间，这里就省略了。</p><h2 id="附代码">附代码：</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>magrittr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>jsonlite<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>stringi<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>futile.logger<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>purrr<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 重定义 retry 函数</span></span><br><span class="line">retry <span class="operator">&lt;-</span></span><br><span class="line">  <span class="keyword">function</span><span class="punctuation">(</span>expr<span class="punctuation">,</span></span><br><span class="line">           isError <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">             <span class="string">&quot;try-error&quot;</span> <span class="operator">%in%</span> <span class="built_in">class</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           maxErrors <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">           sleep <span class="operator">=</span> rnorm<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">8</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    attempts <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    retval <span class="operator">=</span> try<span class="punctuation">(</span>eval<span class="punctuation">(</span>expr<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    <span class="keyword">while</span> <span class="punctuation">(</span>isError<span class="punctuation">(</span>retval<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">      attempts <span class="operator">=</span> attempts <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> <span class="punctuation">(</span>attempts <span class="operator">&gt;=</span> maxErrors<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        msg <span class="operator">=</span> sprintf<span class="punctuation">(</span><span class="string">&quot;retry: too many retries [[%s]]&quot;</span><span class="punctuation">,</span> capture.output<span class="punctuation">(</span>str<span class="punctuation">(</span>retval<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">        flog.fatal<span class="punctuation">(</span>msg<span class="punctuation">)</span></span><br><span class="line">        stop<span class="punctuation">(</span>msg<span class="punctuation">)</span></span><br><span class="line">      <span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">        msg <span class="operator">=</span> sprintf<span class="punctuation">(</span></span><br><span class="line">          <span class="string">&quot;retry: error in attempt %i/%i [[%s]]&quot;</span><span class="punctuation">,</span></span><br><span class="line">          attempts<span class="punctuation">,</span></span><br><span class="line">          maxErrors<span class="punctuation">,</span></span><br><span class="line">          capture.output<span class="punctuation">(</span>str<span class="punctuation">(</span>retval<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">        flog.error<span class="punctuation">(</span>msg<span class="punctuation">)</span></span><br><span class="line">        warning<span class="punctuation">(</span>msg<span class="punctuation">)</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="keyword">if</span> <span class="punctuation">(</span>sleep <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">        Sys.sleep<span class="punctuation">(</span>sleep<span class="punctuation">)</span></span><br><span class="line">      retval <span class="operator">=</span> try<span class="punctuation">(</span>eval<span class="punctuation">(</span>expr<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="built_in">return</span><span class="punctuation">(</span>retval<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 构造从内容到书名的函数</span></span><br><span class="line"><span class="comment">## 简单的想法是获取书名号中的内容</span></span><br><span class="line"><span class="comment">## 如果不在书名号中，则会导致失效</span></span><br><span class="line"><span class="comment">## 重构 read_html 和 html_text 函数，增加稳定性</span></span><br><span class="line">read_html_beta <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  x <span class="operator">&lt;-</span> try<span class="punctuation">(</span>read_html<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">html_text_beta <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  x <span class="operator">&lt;-</span> try<span class="punctuation">(</span>html_text<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">Content2tittle <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>content<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  title <span class="operator">&lt;-</span> content <span class="operator">%&gt;%</span></span><br><span class="line">    purrr<span class="operator">::</span>map_chr<span class="punctuation">(</span><span class="string">&#x27;content&#x27;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    map<span class="punctuation">(</span>read_html_beta<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    map<span class="punctuation">(</span>html_text_beta<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    stri_extract_all_regex<span class="punctuation">(</span><span class="string">&#x27;《.*?》&#x27;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    map<span class="punctuation">(</span>unique<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>title<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">raw_data <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 获取知乎的 API 接口数据</span></span><br><span class="line">url <span class="operator">&lt;-</span> <span class="string">&#x27;https://www.zhihu.com/api/v4/questions/306249128/answers?data[*].author.follower_count,badge[*].topics=&amp;data[*].mark_infos[*].url=&amp;include=data[*].is_normal,admin_closed_comment,reward_info,is_collapsed,annotation_action,annotation_detail,collapse_reason,is_sticky,collapsed_by,suggest_edit,comment_count,can_comment,content,editable_content,voteup_count,reshipment_settings,comment_permission,created_time,updated_time,review_info,relevant_info,question,excerpt,relationship.is_authorized,is_author,voting,is_thanked,is_nothelp,is_labeled,is_recognized,paid_info,paid_info_content&amp;limit=10&amp;offset=0&amp;platform=desktop&amp;sort_by=default&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 循环获取所有数据</span></span><br><span class="line">i <span class="operator">&lt;-</span> 1</span><br><span class="line">is_end <span class="operator">&lt;-</span> <span class="literal">FALSE</span></span><br><span class="line"><span class="keyword">while</span> <span class="punctuation">(</span><span class="operator">!</span>is_end<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  m <span class="operator">&lt;-</span> retry<span class="punctuation">(</span>readLines<span class="punctuation">(</span>url<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    fromJSON<span class="punctuation">(</span>simplifyVector <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">  content <span class="operator">&lt;-</span> m<span class="operator">$</span>data</span><br><span class="line">  next_url <span class="operator">&lt;-</span> m<span class="operator">$</span>paging<span class="operator">$</span><span class="string">&#x27;next&#x27;</span> <span class="comment"># 接下来需要解析的 url</span></span><br><span class="line">  url <span class="operator">&lt;-</span> next_url</span><br><span class="line">  raw_data<span class="punctuation">[[</span>i<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> Content2tittle<span class="punctuation">(</span>content<span class="punctuation">)</span></span><br><span class="line">  is_end <span class="operator">&lt;-</span> m<span class="operator">$</span>paging<span class="operator">$</span>is_end <span class="comment"># 利用 is_end 来判断是否结束</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&#x27;This is &#x27;</span><span class="punctuation">,</span> i<span class="punctuation">,</span> <span class="string">&#x27;round&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;\n&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  i <span class="operator">&lt;-</span> i <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">  Sys.sleep<span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 踢掉一些没有信息的 answer</span></span><br><span class="line">removed_data <span class="operator">&lt;-</span> raw_data<span class="punctuation">[</span>raw_data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span><span class="built_in">length</span><span class="punctuation">)</span> <span class="operator">!=</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">nid <span class="operator">&lt;-</span> raw_data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span><span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span>map<span class="punctuation">(</span>x<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> unlist<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">fnid <span class="operator">&lt;-</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>nid<span class="punctuation">)</span><span class="punctuation">,</span> times <span class="operator">=</span> nid<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 返回所有的书目</span></span><br><span class="line">data <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span> title <span class="operator">=</span> unlist<span class="punctuation">(</span>removed_data<span class="punctuation">)</span><span class="punctuation">,</span> id <span class="operator">=</span> fnid<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  transform<span class="punctuation">(</span>title <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>title<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  na.omit<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  subset<span class="punctuation">(</span>nchar<span class="punctuation">(</span>title<span class="punctuation">)</span> <span class="operator">&lt;=</span> <span class="number">20</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line">data <span class="operator">&lt;-</span> data.table<span class="punctuation">(</span>data<span class="punctuation">)</span></span><br><span class="line">data<span class="punctuation">[</span><span class="punctuation">,</span> .N<span class="punctuation">,</span> title<span class="punctuation">]</span><span class="punctuation">[</span>order<span class="punctuation">(</span><span class="operator">-</span>N<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">[</span>N <span class="operator">&gt;=</span> <span class="number">10</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;国庆期间闲逛知乎，恰巧碰到一则问题 &lt;a
href=&quot;https://www.zhihu.com/question/306249128&quot;&gt;2019年你的书单有什么书？&lt;/a&gt;，这个问题有&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;988 个回答，18326 个关注者，284 万的浏览量&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;接近 1000
个回答，全部翻完且不说时间会爆炸，脑子里能不能记住这些信息更是问题。如果能抓取每个回答列出来的书名，汇总以后便是这
988 个回答者的书目投票。方法虽说暴力，但也算是变相了解大家在 2019
年的阅读倾向。工具呢？当然是我擅长使用的 R 了，哈哈！&lt;/p&gt;
&lt;p&gt;闲话不多说，直接给出结果（大于 10 位回答者提及的书目）：&lt;/p&gt;</summary>
    
    
    
    <category term="有意思的" scheme="http://bjt.name/categories/%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84/"/>
    
    
    <category term="reading" scheme="http://bjt.name/tags/reading/"/>
    
    <category term="crawler" scheme="http://bjt.name/tags/crawler/"/>
    
  </entry>
  
  <entry>
    <title>建国以来人均 GDP 增长情况</title>
    <link href="http://bjt.name/2019/10/02/china-gdp.html"/>
    <id>http://bjt.name/2019/10/02/china-gdp.html</id>
    <published>2019-10-01T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>拜川普总统所赐，今年的国庆节国人过的非常振奋。</p><blockquote><p>此生无悔入华夏，来世愿在种花家</p></blockquote><p>这句话说出了很多人的心声。</p><p>情怀归情怀，我们从建国以来到底 <code>成长的怎样</code>呢？闲话不说，直接上图，数据来源<ahref="https://zh.wikipedia.org/wiki/中华人民共和国国内生产总值">这里</a>。</p><p><imgsrc="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/GDPPC.png" /></p><p>改革开放 40 年我们取得了非常傲人的经济成就，作为 80后亲历者，图形化的结果还是震撼了我。从 04 年附近，人均 GDP的增幅突然爆发出了一个向上的拐点，全球第二大经济体，这么巨大的体量居然还能做到如此，真心不容易！我们大部分普通老百姓即便是什么也没有做，生活水平也在跟着水涨船高，感谢我的政府！</p><span id="more"></span><p>仔细观察趋势变化，还是会发现一些奇怪的现象的：我们在 92年前几乎是完全停滞状态。具体因素不多展开，大家有兴趣的话可自行Google，我还想接着开博客，哈哈。</p><p>简述一下 92 年之后的重要事件：</p><ol type="1"><li>1997 年和 1998 年间，大规模的民营化运动</li><li>2001 年至 2004 年间，国有企业数量减少了 48％</li><li>2001 年 12 月加入世界贸易组织（WTO）</li><li>至 2005 年，内资民营经济在 GDP 中比重占到了49.7%，外商和港澳台的比重占到了 15% 左右</li><li>2008 年四万亿投资计划（不评价）</li><li>2010年，GDP 超越日本，成为仅次于美国的全球第二经济大国</li><li>2018年 GDP 折合 13.6 万亿美元，位居世界第二；购买力平价计算的 GDP则达 25.5 万亿美元，位居世界第一</li></ol><p>还是回到人均 GDP 这个话题，毕竟我们的人口基数还是太大。</p><p>中国 2018 年人均 GDP9608美元，已经达到中等收入国家的中游水平，看似排名不高，但在国际上已经算是比较富裕了。全世界76 亿人口，人均 GDP 比中国高的大概约 18 亿左右，不到全世界总人口的25%。要想象一下，在 1980 年前，我们 60% 的人口每日人均消费不超过 2美元，温饱线上挣扎，一旦有自然灾害就会死人。脑子里怎么浮现了<code>喝水不忘打井人</code>这句话，哈。</p><p>国际上认为人均 GDP 在 6000 美元以上就是中等发达国家。2018年我们排在前面的稍大型国家和地区（或较为有名）顺序还有马来西亚、俄罗斯（11289）、罗马尼亚、波兰、希腊、各种阿拉伯、西班牙（30524）、韩国、意大利、日本（39287）、法国、新西兰、英国（42491）、加拿大、香港（48717）、奥地利、澳大利亚、美国（62641）、新加坡、冰岛、爱尔兰、瑞士、澳门（86365）、卢森堡（114341）。</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/worldbank.png" style="zoom:50%;" /></p><p>按照中国现在这个速度，大概未来 2 年会超过马来西亚和俄罗斯。</p><p>最后再简单说一下台湾。国际通行的 GDP计算标准是本经济体内的常住单位创造的增加值。而台湾却把岛外的台湾企业也计算入GDP 内，比如在大陆、越南的台湾企业创造的增加值，这就导致台湾 GDP虚高（2.5 万美元），而台湾实际人均 GDP 在1.5 万美元左右。但从数字上看，大陆地区追赶台湾地区看起来还是比较容易的。</p><h2 id="附代码">附代码：</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggTimeSeries<span class="punctuation">)</span></span><br><span class="line">p2 <span class="operator">&lt;-</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>x<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Year<span class="punctuation">,</span> y <span class="operator">=</span> DPC<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  stat_waterfall<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&#x27;1952 至 2018 年中国人均 GDP(单位：美元)&#x27;</span><span class="punctuation">,</span> </span><br><span class="line">       caption <span class="operator">=</span> <span class="string">&#x27;数据来源: https://zh.wikipedia.org/wiki/中华人民共和国国内生产总值&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">ylab<span class="punctuation">(</span><span class="string">&#x27;GDP Per Capita&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>family<span class="operator">=</span><span class="string">&#x27;Noto Sans SC Light&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">p2</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;拜川普总统所赐，今年的国庆节国人过的非常振奋。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;此生无悔入华夏，来世愿在种花家&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这句话说出了很多人的心声。&lt;/p&gt;
&lt;p&gt;情怀归情怀，我们从建国以来到底 &lt;code&gt;成长的怎样&lt;/code&gt;
呢？闲话不说，直接上图，数据来源&lt;a
href=&quot;https://zh.wikipedia.org/wiki/中华人民共和国国内生产总值&quot;&gt;这里&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/GDPPC.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;改革开放 40 年我们取得了非常傲人的经济成就，作为 80
后亲历者，图形化的结果还是震撼了我。从 04 年附近，人均 GDP
的增幅突然爆发出了一个向上的拐点，全球第二大经济体，这么巨大的体量居然还能做到如此，真心不容易！我们大部分普通老百姓即便是什么也没有做，生活水平也在跟着水涨船高，感谢我的政府！&lt;/p&gt;</summary>
    
    
    
    <category term="亲历" scheme="http://bjt.name/categories/%E4%BA%B2%E5%8E%86/"/>
    
    
  </entry>
  
  <entry>
    <title>生成不同的网站登录密码</title>
    <link href="http://bjt.name/2019/09/28/secure-hash.html"/>
    <id>http://bjt.name/2019/09/28/secure-hash.html</id>
    <published>2019-09-27T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>随着我们注册的网站和 App 越来越多，有一个问题一直困扰着我：</p><blockquote><p>我的密码真心不够用！</p></blockquote><p>经常几个可能密码重复的尝试，时不时网站就报超过尝试次数。以及还有一个更为可怕的风险：如果所有的网站如果使用同样的密码，任意一个网站只要发生安全泄露（这几年发生次数不少），那基本你在其他网站就属于裸奔了，其他人可以利用你的<code>统一密码</code>作出一系列你不能想象的行为。</p><p><a href="https://1password.com/zh-cn/">1Password</a>给我了一些启发，它可以保证你每个网站的密码都不同。这款软件安全性怎样，收费多少先不提，我们简单思考一下这个软件的原理貌似是容易实现的，基本要素和逻辑猜测有以下要点：</p><ol type="1"><li>不同的网站或者 app 会导致密码的不同</li><li>自己有一个私钥种子，这是唯一要保存的</li><li>将 1 和 2 的信息加密之后返回加密信息</li><li>将加密信息的内容通过一定的规则给出显式密码</li><li>显式密码包含特殊字符，英文的大小写字母</li></ol><p>这样做的最大好处是，我只需要记住 2 的种子，即便暴露了 4的规则，也不担心密码会被反向破译。</p><span id="more"></span><p>既然已知原理，那么闲话少说，实现这个逻辑。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">n <span class="operator">&lt;-</span> 12 <span class="comment"># 生成密码长度，见过最长的为 vivaldi，注册长度为 12</span></span><br><span class="line">initChar <span class="operator">&lt;-</span> <span class="string">&#x27;bjt.name&#x27;</span> <span class="comment"># 私人秘钥</span></span><br><span class="line">specialChar <span class="operator">&lt;-</span> <span class="string">&#x27;@!#&amp;^*_+=-&#x27;</span></span><br><span class="line">require<span class="punctuation">(</span>openssl<span class="punctuation">)</span></span><br><span class="line">require<span class="punctuation">(</span>magrittr<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">password <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>webORapp <span class="operator">=</span> <span class="string">&#x27;twitter.com&#x27;</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  Char <span class="operator">&lt;-</span> paste<span class="punctuation">(</span>initChar<span class="punctuation">,</span> webORapp<span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> </span><br><span class="line">  zchar <span class="operator">&lt;-</span> Char <span class="operator">%&gt;%</span> </span><br><span class="line">    sha256<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    strsplit<span class="punctuation">(</span>split <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    unlist<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  <span class="comment">## 根据组合信息生成随机数</span></span><br><span class="line">  nsep <span class="operator">&lt;-</span> zchar <span class="operator">%&gt;%</span> </span><br><span class="line">    sapply<span class="punctuation">(</span>charToRaw<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    <span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">    <span class="built_in">sum</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  set.seed<span class="punctuation">(</span>nsep<span class="punctuation">)</span></span><br><span class="line">  <span class="comment">## 将一半的字符大写化，如果是字母的话</span></span><br><span class="line">  upp <span class="operator">&lt;-</span> sample<span class="punctuation">(</span><span class="number">64</span><span class="punctuation">,</span> <span class="number">32</span><span class="punctuation">)</span></span><br><span class="line">  zchar<span class="punctuation">[</span>upp<span class="punctuation">]</span> <span class="operator">&lt;-</span> zchar<span class="punctuation">[</span>upp<span class="punctuation">]</span> <span class="operator">%&gt;%</span> </span><br><span class="line">    toupper<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  zspec <span class="operator">&lt;-</span> specialChar <span class="operator">%&gt;%</span> </span><br><span class="line">    strsplit<span class="punctuation">(</span>split <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    unlist<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    sample<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">## 保证必须有一个特殊字符</span></span><br><span class="line">  id <span class="operator">&lt;-</span> sample<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span>n<span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  password <span class="operator">&lt;-</span> sample<span class="punctuation">(</span>zchar<span class="punctuation">,</span> n<span class="punctuation">)</span></span><br><span class="line">  password<span class="punctuation">[</span>id<span class="punctuation">]</span> <span class="operator">&lt;-</span> zspec</span><br><span class="line">  password <span class="operator">%&gt;%</span></span><br><span class="line">    paste<span class="punctuation">(</span>collapse <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    <span class="built_in">return</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>shiny<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">app <span class="operator">&lt;-</span> shinyApp<span class="punctuation">(</span></span><br><span class="line">ui <span class="operator">&lt;-</span> fluidPage<span class="punctuation">(</span></span><br><span class="line">  textInput<span class="punctuation">(</span><span class="string">&quot;caption&quot;</span><span class="punctuation">,</span> <span class="string">&quot;The name of Web or App&quot;</span><span class="punctuation">,</span> <span class="string">&quot;iciba.com&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  verbatimTextOutput<span class="punctuation">(</span><span class="string">&quot;value&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">server <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>input<span class="punctuation">,</span> output<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  output<span class="operator">$</span>value <span class="operator">&lt;-</span> renderText<span class="punctuation">(</span><span class="punctuation">&#123;</span> password<span class="punctuation">(</span>input<span class="operator">$</span>caption<span class="punctuation">)</span> <span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># Run the application </span></span><br><span class="line">runApp<span class="punctuation">(</span>app<span class="punctuation">,</span> launch.browser <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>给出来的结果是 <code>9a8e0A9cB-9c</code>，在 Twitter上给出的密码安全强度是 strong。以上代码可以直接放在 rstudio里直接运行调出一个网页出来，更方便。</p><blockquote><p>如果用户名也会出现注册网站也有冲突的情况，那看官就自行改一个生成用户名的机制就好了。</p></blockquote><h2 id="关于加密算法">关于加密算法</h2><p>比较出名的加密算法有</p><ul><li>md5</li><li>sha1</li><li>sha256</li><li>BLAKE</li></ul><p>md5 和 sha1可以通过碰撞的方式破解，当然前提是算力够强。有一次我和同事打赌，能不能在3 小时内将我随意 md5 加密的手机号码破解，他找了一段 Java 程序，狂算了 3小时，最后还是无解。给我的一点启发是，理论上 md5 和 sha1确实有缺陷，但实际生活中基本也够用了。</p><p>sha1 广泛应用于各种互联网协议，比如 SSL等，我们在点击流签名认证也使用了该技术。这个场景我用了sha2，显然只是不同的一个函数而已。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;随着我们注册的网站和 App 越来越多，有一个问题一直困扰着我：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我的密码真心不够用！&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;经常几个可能密码重复的尝试，时不时网站就报超过尝试次数。以及还有一个更为可怕的风险：如果所有的网站如果使用同样的密码，任意一个网站只要发生安全泄露（这几年发生次数不少），那基本你在其他网站就属于裸奔了，其他人可以利用你的&lt;code&gt;统一密码&lt;/code&gt;作出一系列你不能想象的行为。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://1password.com/zh-cn/&quot;&gt;1Password&lt;/a&gt;
给我了一些启发，它可以保证你每个网站的密码都不同。这款软件安全性怎样，收费多少先不提，我们简单思考一下这个软件的原理貌似是容易实现的，基本要素和逻辑猜测有以下要点：&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;不同的网站或者 app 会导致密码的不同&lt;/li&gt;
&lt;li&gt;自己有一个私钥种子，这是唯一要保存的&lt;/li&gt;
&lt;li&gt;将 1 和 2 的信息加密之后返回加密信息&lt;/li&gt;
&lt;li&gt;将加密信息的内容通过一定的规则给出显式密码&lt;/li&gt;
&lt;li&gt;显式密码包含特殊字符，英文的大小写字母&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这样做的最大好处是，我只需要记住 2 的种子，即便暴露了 4
的规则，也不担心密码会被反向破译。&lt;/p&gt;</summary>
    
    
    
    <category term="工具技巧" scheme="http://bjt.name/categories/%E5%B7%A5%E5%85%B7%E6%8A%80%E5%B7%A7/"/>
    
    
    <category term="secure hash" scheme="http://bjt.name/tags/secure-hash/"/>
    
    <category term="password" scheme="http://bjt.name/tags/password/"/>
    
  </entry>
  
  <entry>
    <title>sharingan 自定义 CSS 特效</title>
    <link href="http://bjt.name/2019/03/24/zoom.html"/>
    <id>http://bjt.name/2019/03/24/zoom.html</id>
    <published>2019-03-23T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>sharingan 是非常优秀的幻灯片演示工具，作为一款网页工具，它本身也支持各种 CSS 的特效，这里罗列几种 CSS特效，供读者参考。（本篇博客基本照抄团队杜亚磊的原创，我只是知识的搬运工，笑）</p><h1 id="放大图片的特效">放大图片的特效</h1><p>我们在使用写轮眼些幻灯片时，会遇到展示庞大网络图或者架构图，比如全力的游戏的人物图谱</p><p><img src="https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/HBO.jpg"/></p><p>可以想象，当使用幻灯片呈现这些关系图时，是很难比较清楚的将细节展示给观众的。如果我们能够使用zoom in 的方式放大图片，那就完美了。这里给到了一种使用<code>jquery-zoom.js</code> 来实现的机制。</p><span id="more"></span><p>直奔主题：</p><p><code>head.js</code> 文件内容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&#x27;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js&#x27;</span>&gt;&lt;/script&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdnjs.cloudflare.com/ajax/libs/jquery-zoom/1.7.21/jquery.zoom.min.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  $(<span class="string">&#x27;.hover_large img&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">wrap</span>(<span class="string">&#x27;&lt;span style=&quot;display:inline-block&quot;&gt;&lt;/span&gt;&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">css</span>(<span class="string">&#x27;display&#x27;</span>, <span class="string">&#x27;block&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">parent</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">zoom</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;)();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><code>header.js</code>需要加载在主文件内做声明，演示主文件rmd文档示例如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &quot;幻灯忍者&quot;</span><br><span class="line">subtitle: &quot;写轮眼&quot;</span><br><span class="line">author: &quot;谢益辉&quot;</span><br><span class="line">date: &quot;2016/12/12&quot;</span><br><span class="line">output:</span><br><span class="line">  xaringan::moon_reader:</span><br><span class="line">    css: [default, zh-CN.css, header.css]</span><br><span class="line">    lib_dir: libs</span><br><span class="line">    nature:</span><br><span class="line">      highlightStyle: github</span><br><span class="line">      highlightLines: true</span><br><span class="line">      countIncrementalSlides: false</span><br><span class="line">    includes:</span><br><span class="line">      after_body: header.js</span><br><span class="line">---</span><br><span class="line"># 要点</span><br><span class="line"></span><br><span class="line">- 关键是`after_body: header.js` 这一行。</span><br><span class="line"></span><br><span class="line">- 给图片添加一个`hover_large`的class属性。就有zoom的效果了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">.hover_large[</span><br><span class="line">  ![Sharingan](https://pic2.zhimg.com/9ab9a0f5bdf4de19bf2b398f106e876c_r.jpg)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h1 id="调用-awesome-font">调用 awesome font</h1><p>Font Awesome 是一套绝佳的图标字体库和 CSS框架，提供了可缩放的矢量图标，可以使用 CSS所提供的所有特性对它们进行更改，包括：大小、颜色、阴影或者其它任何支持的效果。</p><p>在 sharingan 中我们依然可以调用该 CSS 框架。具体调用方法是直接在 css后面做声明：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output:</span><br><span class="line">  xaringan::moon_reader:</span><br><span class="line">    css: [default, zh-CN.css, header.css, &#x27;https://use.fontawesome.com/releases/v5.8.1/css/all.css&#x27;]</span><br><span class="line">    lib_dir: libs</span><br></pre></td></tr></table></figure><p>最后我们直接预览一下编译完成的<ahref="/upload/share/demo.html">幻灯片</a>，这个幻灯片有以上两个功能。</p><ol type="1"><li>我们只需要把鼠标移到想要放大的位置，放大的局部就出现。</li><li>调用 awesome font 的图标。</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;sharingan 是非常优秀的幻灯片演示工具，作为一款
网页工具，它本身也支持各种 CSS 的特效，这里罗列几种 CSS
特效，供读者参考。（本篇博客基本照抄团队杜亚磊的原创，我只是知识的搬运工，笑）&lt;/p&gt;
&lt;h1 id=&quot;放大图片的特效&quot;&gt;放大图片的特效&lt;/h1&gt;
&lt;p&gt;我们在使用写轮眼些幻灯片时，会遇到展示庞大网络图或者架构图，比如全力的游戏的人物图谱&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://pic-1300049111.cos.ap-beijing.myqcloud.com/img/HBO.jpg&quot;/&gt;&lt;/p&gt;
&lt;p&gt;可以想象，当使用幻灯片呈现这些关系图时，是很难比较清楚的将细节展示给观众的。如果我们能够使用
zoom in 的方式放大图片，那就完美了。这里给到了一种使用
&lt;code&gt;jquery-zoom.js&lt;/code&gt; 来实现的机制。&lt;/p&gt;</summary>
    
    
    
    <category term="R 技巧" scheme="http://bjt.name/categories/R-%E6%8A%80%E5%B7%A7/"/>
    
    
    <category term="sharingan" scheme="http://bjt.name/tags/sharingan/"/>
    
  </entry>
  
  <entry>
    <title>数据科学的关键事件</title>
    <link href="http://bjt.name/2018/11/18/timeline.html"/>
    <id>http://bjt.name/2018/11/18/timeline.html</id>
    <published>2018-11-17T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>十月份在公司的技术中心分享了《数据思维、技术到商业价值》，从数据科学的重要基石之一统计学开讲，帮大家串了一下数据科学到底是什么东西。其中有一页幻灯片，讲到我心目中数据科学milestone 的时间轴，这里分享给大家，以及怎么使用 R包绘制。啥也不说，先看图：</p><p><img src="/upload/pic/timeline.png" /></p><span id="more"></span><p><strong>Information entropy, 1948</strong></p><p>由信息论之父 C. E. Shannon 在论文《A Mathematical Theory ofCommunication 》提出。Shannon 借用热力学的原理解决了 Uncertainty的测量性问题。（太早，故未在时间轴上体现）</p><p><strong>The Future of Data Analysis, 1962</strong></p><p>John W. Tukey也是个人最为崇拜的统计学家（除了祖师爷Fisher以外），Tukey讨论了两个有意思的问题：</p><ol type="1"><li>统计学和数据分析的关系</li><li>统计学和计算机学的关系</li></ol><p>大家有兴趣可以搜一下原文，感受一下 56 年前大佬的思考深度。</p><p><strong>Data science, 1974</strong></p><p>Data science 的概念是 Peter Naur 在《Concise Survey of ComputerMethods》首次提出，Peter Naur 是计算机科学家，图灵奖的获得者。在这本书里，Peter Naur 给了偏计算机领域的数据定义：</p><blockquote><p>Data is a representation of facts or ideas in a formalized mannercapable of being communicated or manipulated by some process.</p></blockquote><p>Peter Naur 对 computer science 这个词很有意见，建议应该叫做 datalogy或者 data science，当然和现代 data science 的定义还是差别很大。</p><p><strong>Two-Way Communication, 1975</strong></p><p>由日本邮政和通信省主导，在这次信息社会普查发现：信息（数据）的传递不是单向的，双向（个性化）的是未来的趋势。</p><p><strong>Exploratory Data Analysis, 1977</strong></p><p>这个词学统计的应该非常清楚是什么意思，不多讲。Tukey 在 1977年就提出来这个观点，让我们这些后辈只有佩服的份。</p><p><strong>Business Intelligence, 1989</strong></p><p>Howard Dresner 赋予了商业智能以现代概念：</p><blockquote><p>concepts and methods to improve business decision making by usingfact-based support systems</p></blockquote><p><strong>The First Database Report, 1992</strong></p><p>CrystalReports(水晶报表)，较晚一些从事数据科学的童鞋可能没听过这款产品。想想那是1992 年，能够在 Windows上通过连接数据库形成一个数据报告是多么酷的事情。</p><p><strong>The World Wide Web Explodes, 1995</strong></p><p>互联网技术和应用开始井喷式爆发，我们面临的以及需要优化的问题是人类社会前所未有的，同时提供给了数据科学更多的可能性。</p><p><strong>Data Mining and Knowledge Discovery, 1997</strong></p><p>聚焦在数据挖掘的权威期刊，包括基础理论、数据挖掘方法、数据挖掘算法、知识发现过程、应用等。Datamining这个词是表示了从大型数据库中提取信息之意。</p><p><strong>S(ACM Software System Award), 1998</strong></p><p>S 语言由贝尔实验室的 John Chambers 发明，在 1998 年被授予 ACM软件系统奖。这是唯一的数据科学领域被授予奖项的系统，它永久的改变了人们分析数据的方式，是探索性数据分析的集大成之作。</p><p><strong>Statistical Modeling: The Two Cultures, 2001</strong></p><p>Leo Breiman在该论文中提到：在使用统计模型从数据中提取结论的过程中有两种文化。一个假定数据是由一个特定分布模型生成的。另一个使用算法模型，并把数据结构看作未知的。统计学界普遍致力于仅仅使用针对数据的模型。这种投入产生了无意义的理论、值得怀疑的结论，并让统计学家无法触及大量现实问题。算法模型，在理论与实践中，在统计学之外快速发展。它既可以被应用于庞大复杂的数据集，也可以在小数据集上建立精确信息量大的模型。如果我们这个领域的目标是使用数据解决问题，那么我们需要摆脱对纯粹基于数据模型的依赖，并使用更多样的工具。</p><p><strong>Hadoop, 2006</strong></p><p>离线分布式计算的基石，且免费，对硬件的要求不高。因为它的存在，所有机构都可以用较小的成本来处理海量的数据。记得2011 年之后，国内讲大数据如果不讲 Hadoop 就感觉非常不专业的样子。</p><p><strong>Data scientist, 2008</strong></p><p>Jeff Hammerbacher(Facebook) 和 DJ Patil(LinkedIn)开始使用数据科学家来描述他们的团队以及工作。从此以后，数据科学家这个名词开始广泛地被提起。</p><p><strong>NOSQL, 2009</strong></p><p>非关系型数据库，其口号是：</p><blockquote><p>select fun, profit from real_world where relational=false;</p></blockquote><p><strong>Deep Learning, 2015</strong></p><p>深度学习其实并不是什么新鲜技术，人工神经网络在 20 世纪 50年代就出现了，但是受限于算力和要求的数据量，神经网络发展一直相对缓慢。2015年随着 Google在语音识别领域精度的极大提高（几项比赛的革命性效果），深度学习再一次火了起来。</p><p>附代码:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>lubridate<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">x <span class="operator">&lt;-</span> tribble<span class="punctuation">(</span></span><br><span class="line">  <span class="operator">~</span>event<span class="punctuation">,</span> <span class="operator">~</span>date<span class="punctuation">,</span> <span class="operator">~</span>type<span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;The Future of Data Analysis&#x27;</span><span class="punctuation">,</span> <span class="number">1962</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Relational Database&#x27;</span><span class="punctuation">,</span> <span class="number">1970</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Data science(Peter Naur)&#x27;</span><span class="punctuation">,</span> <span class="number">1974</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Two-Way Communication&#x27;</span><span class="punctuation">,</span> <span class="number">1975</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Exploratory Data Analysis&#x27;</span><span class="punctuation">,</span> <span class="number">1977</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Business Intelligence&#x27;</span><span class="punctuation">,</span> <span class="number">1989</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;The First Database Report&#x27;</span><span class="punctuation">,</span> <span class="number">1992</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;The World Wide Web Explodes&#x27;</span><span class="punctuation">,</span> <span class="number">1995</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Data Mining and Knowledge Discovery&#x27;</span><span class="punctuation">,</span> <span class="number">1997</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;S(ACM Software System Award)&#x27;</span><span class="punctuation">,</span> <span class="number">1998</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Statistical Modeling: The Two Cultures&#x27;</span><span class="punctuation">,</span> <span class="number">2001</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Hadoop&#x27;</span><span class="punctuation">,</span> <span class="number">2006</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Data scientist&#x27;</span><span class="punctuation">,</span> <span class="number">2008</span><span class="punctuation">,</span> <span class="string">&#x27;concept&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;NOSQL&#x27;</span><span class="punctuation">,</span> <span class="number">2009</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&#x27;Deep Learning&#x27;</span><span class="punctuation">,</span> <span class="number">2015</span><span class="punctuation">,</span> <span class="string">&#x27;system&#x27;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">positions <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="number">1.0</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">1.0</span><span class="punctuation">,</span> <span class="number">1.5</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">1.5</span><span class="punctuation">)</span></span><br><span class="line">n <span class="operator">&lt;-</span> nrow<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">event <span class="operator">&lt;-</span> x <span class="operator">|&gt;</span></span><br><span class="line">  mutate<span class="punctuation">(</span></span><br><span class="line">    date <span class="operator">=</span> as.Date<span class="punctuation">(</span>paste<span class="punctuation">(</span>x<span class="operator">$</span>date<span class="punctuation">,</span> <span class="string">&#x27;/01/01&#x27;</span><span class="punctuation">,</span> sep <span class="operator">=</span><span class="string">&#x27;&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    position <span class="operator">=</span> rep_len<span class="punctuation">(</span>positions<span class="punctuation">,</span> length.out <span class="operator">=</span> n<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">year_dat <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">  date <span class="operator">=</span> seq<span class="punctuation">(</span>from <span class="operator">=</span> as.Date<span class="punctuation">(</span><span class="string">&#x27;1960-01-01&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> to <span class="operator">=</span> as.Date<span class="punctuation">(</span><span class="string">&#x27;2016-12-31&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> by <span class="operator">=</span> <span class="string">&quot;1 year&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  mutate<span class="punctuation">(</span></span><br><span class="line">    year <span class="operator">=</span> format<span class="punctuation">(</span>date<span class="punctuation">,</span> <span class="string">&quot;%Y&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">year_dat<span class="operator">$</span>year<span class="punctuation">[</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>year_dat<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%%</span> <span class="number">2</span> <span class="operator">==</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> event<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span> y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> xend <span class="operator">=</span> date<span class="punctuation">,</span> yend <span class="operator">=</span> position<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_hline<span class="punctuation">(</span>yintercept <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span> linewidth <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_label<span class="punctuation">(</span></span><br><span class="line">    aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span> y <span class="operator">=</span> position<span class="punctuation">,</span> label <span class="operator">=</span> event<span class="punctuation">,</span> color <span class="operator">=</span> type<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    show.legend <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span> y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> color <span class="operator">=</span> type<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> show.legend <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_text<span class="punctuation">(</span></span><br><span class="line">    data <span class="operator">=</span> year_dat<span class="punctuation">,</span></span><br><span class="line">    aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span> y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> label <span class="operator">=</span> year<span class="punctuation">)</span><span class="punctuation">,</span> angle <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">3.5</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_void<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;十月份在公司的技术中心分享了《数据思维、技术到商业价值》，从数据科学的重要基石之一统计学开讲，帮大家串了一下数据科学到底是什么东西。其中有一页幻灯片，讲到我心目中数据科学
milestone 的时间轴，这里分享给大家，以及怎么使用 R
包绘制。啥也不说，先看图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/upload/pic/timeline.png&quot; /&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="数据思维" scheme="http://bjt.name/categories/%E6%95%B0%E6%8D%AE%E6%80%9D%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>贝叶斯个性化排序</title>
    <link href="http://bjt.name/2018/07/03/bpr.html"/>
    <id>http://bjt.name/2018/07/03/bpr.html</id>
    <published>2018-07-02T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.293Z</updated>
    
    <content type="html"><![CDATA[<p>Bayesian Personalized Ranking是基于隐式反馈数据的非常通用的个性化模型，一般实现使用的是 matrixfactorization 机制，利用随机梯度下降来求解。</p><p>假设用来表达训练集的三元组为 <spanclass="math inline">\((u,i,j)\)</span>，只需要找到“最优化”的用户的 f维向量表征 <span class="math inline">\(w_{uf}\)</span>，positive item i的 f 维向量表征 <span class="math inline">\(h_{if}\)</span>，negativeitem j 的 f 维向量表征 <spanclass="math inline">\(h_{jf}\)</span>，则建模完毕。</p><p>它有以下几点优势：</p><ul><li>不关注于拟合的具体数值损失最小，而是关注于 item 的排序关系</li><li>由于特殊的负采样策略，导致它的结果相对偏 High-Precision &amp;Low-Recall</li><li>因为是潜变量模型，预测只是向量的相乘，工程化性能优异</li></ul><span id="more"></span><h1 id="模型推导">1. 模型推导</h1><p>考虑我们优化的目标(<span class="math inline">\(\theta\)</span>是我们求解的任意参数，比如矩阵分解的潜向量，<spanclass="math inline">\(&gt;_u\)</span> 代表了 user 对其他所有 item的排序关系），它可以用贝叶斯公式表示为</p><p><span class="math display">\[P(\theta|&gt;_u) = \frac{P(&gt;_u|\theta)P(\theta)}{P(&gt;_u)}\]</span></p><p>假设所有的用户行为都是独立的，因此有</p><p><span class="math display">\[P(\theta|&gt;_u) \propto P(&gt;_u|\theta)P(\theta)\]</span></p><p>因此优化目标拆解成了两部分，先看第一部分，可以表示为</p><p><span class="math display">\[\prod_{u \in U}P(&gt;_u|\theta) = \prod_{(u,i,j) \in D}P(i &gt;_uj|\theta)\]</span></p><p>定义user <span class="math inline">\(u\)</span> 和 item <spanclass="math inline">\(i\)</span> 的内积为 user 对 item 的偏好 <spanclass="math inline">\(x_{ui}\)</span>。 对于 <spanclass="math inline">\(P(i &gt;_u j|\theta)\)</span>这个概率，直观解释就是 <span class="math inline">\(x_{ui}\)</span>是否大于 <spanclass="math inline">\(x_{uj}\)</span>，大于零则表示：对于用户 <spanclass="math inline">\(u\)</span> 来说，<spanclass="math inline">\(i\)</span> 和 <spanclass="math inline">\(j\)</span> 更偏好 <spanclass="math inline">\(i\)</span> ：</p><p><span class="math display">\[x_{uij} = x_{ui} - x_{uj}\]</span></p><p>但这里有个问题，这个如果直接减的话，是 non-continuous,non-differential， 所以我们需要变换一下，把 <spanclass="math inline">\(x_{ui} - x_{uj}\)</span> 的结果用 sigmod函数变换一下（概率化），可以写成这样</p><p><span class="math display">\[P(i &gt;_u j|\theta) = \sigma(x_{uij}(\theta))\]</span></p><p>因此第一部分的优化目标就可以变成这个样子了：</p><p><span class="math display">\[\prod_{u \in U}P(&gt;_u|\theta) = \prod_{(u,i,j) \in D} \sigma(x_{ui} -x_{uj})\]</span></p><p>对于第二部分的 <spanclass="math inline">\(P(\theta)\)</span>，我们将它简化为均值为0，协方差矩阵为<span class="math inline">\(\lambda_{\theta}I\)</span>，即</p><p><span class="math display">\[P(\theta) \sim N(0, \lambda_{\theta}I)\]</span></p><p>因此对数后验估计函数可以表示为：</p><p><span class="math display">\[\ln P(\theta|&gt;_u) \propto \ln P(&gt;_u|\theta)P(\theta) = \ln\prod\limits_{(u,i,j) \in D} \sigma(x_{uij}) + ln P(\theta) =\sum\limits_{(u,i,j) \in D}\ln\sigma(x_{uij}) + \lambda||\theta||^2\;\]</span></p><p>上式的对于 <span class="math inline">\(\theta\)</span>的一阶导为：</p><p><span class="math display">\[\begin{align*}&amp;= \prod\limits_{(u,i,j)} \frac{\partial \ln\sigma(x_{uij})}{\partial \theta} - \lambda_{\theta} \frac{\partial||\theta||^2}{\partial \theta} \\&amp;\propto \prod\limits_{(u,i,j)} \frac{e^{-x_{uij}}}{1 + e^{x_{uij}}}\frac{\partial x_{uij}}{\partial \theta} - \lambda_{\theta}\theta\end{align*}\]</span></p><p>在这里有</p><p><span class="math display">\[x_{uij} = x_{ui} - x_{uj} = \sum\limits_{f=1}^kw_{uf}h_{if} -\sum\limits_{f=1}^kw_{uf}h_{jf}\]</span></p><p>因此很容易得到：</p><p><span class="math display">\[\frac{\partial (x_{ui} - x_{uj})}{\partial \theta} = \begin{cases}(h_{if}-h_{jf})&amp; {if\; \theta = w_{uf}}\\ w_{uf}&amp; {if\;\theta =h_{if}} \\ -w_{uf}&amp; {if\;\theta = h_{jf}}\end{cases}\]</span></p><p>也就是说，对于矩阵分解算法的参数 <spanclass="math inline">\(\theta\)</span> 来说，user 的 f 维隐向量 <spanclass="math inline">\(w_{uf}\)</span>，以及 item 的 f 维隐向量 <spanclass="math inline">\(h_{if}, h_{jf}\)</span>非常容易通过梯度上升法来求解。</p><h1 id="实现细节">2. 实现细节</h1><p>摘抄一部分 C++ 代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">prob = <span class="built_in">sum</span>(<span class="built_in">U</span>(user_id, _) * (<span class="built_in">I</span>(liked_id, _) - <span class="built_in">I</span>(disliked_id, _)));</span><br><span class="line">prob = <span class="number">1</span> / (<span class="number">1</span> + <span class="built_in">exp</span>(prob));</span><br><span class="line">temp = <span class="built_in">U</span>(user_id, i);</span><br><span class="line"><span class="built_in">U</span>(user_id, i) +=  alpha * (prob * (<span class="built_in">I</span>(liked_id, i) - <span class="built_in">I</span>(disliked_id, i)) - lamb*temp);</span><br><span class="line"><span class="built_in">I</span>(liked_id, i) += alpha * (prob * temp - rlamb * <span class="built_in">I</span>(liked_id, i));</span><br><span class="line"><span class="built_in">I</span>(disliked_id, i) += alpha * (-prob * temp - lamb * <span class="built_in">I</span>(disliked_id, i));</span><br></pre></td></tr></table></figure><p>可以很清晰的看到所有的运算基于 <spanclass="math inline">\(\sigma(x_{uij})\)</span> 以及 <spanclass="math inline">\(w_{uf}, h_{if}, h_{jf}\)</span> 以及常数项 alpha,lambda。</p><p>negative item j 是通过抽样方式来确定的，实际在计算的过程中只考虑positive item i，因为 negative item 很多，所以会在所有的 item里随机抽一个，即便是抽到了 positive item从概率上来讲也不会对计算速度和精度有太大影响，但速度会加快很多。（想象一下电商推荐场景，不点击的长尾商品很多）</p><p>在 51Talk老师推荐的实际应用场景又有不同，我们只针对有评分（positive）的老师进行训练，来更新用户和老师的向量，实际效果更佳优异。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Bayesian Personalized Ranking
是基于隐式反馈数据的非常通用的个性化模型，一般实现使用的是 matrix
factorization 机制，利用随机梯度下降来求解。&lt;/p&gt;
&lt;p&gt;假设用来表达训练集的三元组为 &lt;span
class=&quot;math inline&quot;&gt;&#92;((u,i,j)&#92;)&lt;/span&gt;，只需要找到“最优化”的用户的 f
维向量表征 &lt;span class=&quot;math inline&quot;&gt;&#92;(w_{uf}&#92;)&lt;/span&gt;，positive item i
的 f 维向量表征 &lt;span class=&quot;math inline&quot;&gt;&#92;(h_{if}&#92;)&lt;/span&gt;，negative
item j 的 f 维向量表征 &lt;span
class=&quot;math inline&quot;&gt;&#92;(h_{jf}&#92;)&lt;/span&gt;，则建模完毕。&lt;/p&gt;
&lt;p&gt;它有以下几点优势：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不关注于拟合的具体数值损失最小，而是关注于 item 的排序关系&lt;/li&gt;
&lt;li&gt;由于特殊的负采样策略，导致它的结果相对偏 High-Precision &amp;amp;
Low-Recall&lt;/li&gt;
&lt;li&gt;因为是潜变量模型，预测只是向量的相乘，工程化性能优异&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="算法" scheme="http://bjt.name/categories/%E7%AE%97%E6%B3%95/"/>
    
    
  </entry>
  
  <entry>
    <title>写轮眼（sharingan)奇淫技巧</title>
    <link href="http://bjt.name/2018/06/24/sharingan.html"/>
    <id>http://bjt.name/2018/06/24/sharingan.html</id>
    <published>2018-06-23T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.292Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>本片文章直接拷贝于部门wiki，作者还有renwanfeng、duyalei</p></blockquote><p>写轮眼是谢益辉开发的，利用 markdown 语法完成的 slides 的<ahref="https://github.com/yihui/xaringan">工具</a>，排版非常考究，书写速度极快。非常适合工程师序列的工作人员。</p><p>不过因为 GFW 的存在，sharingan 调用的 js 和 font 不能加载，会导致slides 不能被顺利渲染。这里提供一些常用参数设置，通过本地编译，sharingan 能够提供self-contained 文件，不依赖于网络环境。</p><span id="more"></span><h1 id="全局配置">1. 全局配置</h1><h2 id="slides的title-部分">1.1. slides的title 部分</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">title: &quot;少儿英语启蒙路线产品&quot;</span><br><span class="line">subtitle: &quot;&quot;</span><br><span class="line">author: &quot;刘思喆&quot;</span><br><span class="line">date: &#x27;<span class="code">`r Sys.Date()`</span>&#x27;</span><br><span class="line">output:</span><br><span class="line">  xaringan::moon<span class="emphasis">_reader:</span></span><br><span class="line"><span class="emphasis">    css: [default, rutgers, zh-CN.css, extra.css]</span></span><br><span class="line"><span class="emphasis">    lib_</span>dir: libs</span><br><span class="line"><span class="code">    chakra: remark.min.js</span></span><br><span class="line"><span class="code">    self_contained: true    </span></span><br><span class="line"><span class="code">    nature:</span></span><br><span class="line"><span class="code">      highlightStyle: github</span></span><br><span class="line"><span class="code">      highlightLines: true</span></span><br><span class="line"><span class="code">      countIncrementalSlides: false</span></span><br></pre></td></tr></table></figure><ul><li>css 中增加一个自定义 extra.css，这里可以同时声明字体路径</li><li>lib_dir: 本地 libs 的目录</li><li>chakra 使用本地 js</li><li>self_contained 变更为 true</li></ul><p>所有本地依赖文件的<a href="/upload/sharingan.zip">打包地址</a></p><h2 id="字体设置">1.2. 字体设置</h2><p>css 部分指向了本地的 woff 字体地址：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Yanone Kaffeesatz&#x27;</span>;</span><br><span class="line">  <span class="attribute">font-style</span>: normal;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">400</span>;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">local</span>(<span class="string">&#x27;Yanone Kaffeesatz Regular&#x27;</span>), <span class="built_in">local</span>(<span class="string">&#x27;YanoneKaffeesatz-Regular&#x27;</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">&#x27;woff/yanone-kaffeesatz.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Droid Serif&#x27;</span>;</span><br><span class="line">  <span class="attribute">font-style</span>: normal;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">400</span>;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">local</span>(<span class="string">&#x27;Droid Serif&#x27;</span>), <span class="built_in">local</span>(<span class="string">&#x27;DroidSerif&#x27;</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">&#x27;woff/droid-serif.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Source Code Pro&#x27;</span>;</span><br><span class="line">  <span class="attribute">font-style</span>: normal;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">400</span>;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">local</span>(<span class="string">&#x27;Source Code Pro&#x27;</span>), <span class="built_in">local</span>(<span class="string">&#x27;SourceCodePro-Regular&#x27;</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">&#x27;woff/source-code-pro.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然也可以使用本地字体，我现在比较喜欢的字体搭配是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">body &#123; font-family: &#x27;Baskerville&#x27;, &#x27;Noto Sans SC Light&#x27;, &#x27;Palatino Linotype&#x27;, &#x27;Book Antiqua&#x27;, Palatino, &#x27;Songti SC&#x27;, serif; &#125;</span><br><span class="line">h1, h2, h3 &#123;</span><br><span class="line">  font-family: &#x27;Rockwell&#x27;, &#x27;Noto Sans SC&#x27;, &#x27;Palatino Linotype&#x27;, &#x27;Book Antiqua&#x27;, Palatino, &#x27;STHeiti&#x27;, &#x27;SimHei&#x27;, &#x27;Microsoft YaHei&#x27;;</span><br><span class="line">  font-weight: normal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然也可以随意看心情搭配。</p><h1 id="其他实用技巧">2. 其他实用技巧</h1><h2 id="演示相关">2.1. 演示相关</h2><h3 id="实时预览">2.1.1. 实时预览</h3><ul><li><p>利用 xaringan 的 infinite moon reader插件实现实时预览（在Viewer中所见即所得），在 R console 中输入即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xaringan:::inf_mr(&quot;your_file.Rmd&quot;)</span><br></pre></td></tr></table></figure></li></ul><h3 id="演讲者模式">2.1.2. 演讲者模式</h3><p>演讲时候经常需要使用演讲者模式，这样可以自己看到上下页面演讲内容，同时也可以看到备注和相应的时间提示：</p><ul><li>首先在编译出来的 html 文件中按 C键复制到新窗口，新窗口可以给观众看</li><li>其次在本地的这个 html 演示文稿中点击 p 进入到演示模式即可</li></ul><p>这样就实现了本地滑动演示的时候，新窗口同步滚动</p><h3 id="自动播放幻灯片">2.1.3. 自动播放幻灯片</h3><p>有时候你可能对时间把控不是很准确的时候，可以锻炼自己每页 ppt 1分钟演讲时间，这时候，可以设置一个幻灯片倒计时60s：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output:</span><br><span class="line">      xaringan::moon_reader:</span><br><span class="line">        nature:</span><br><span class="line">          countdown: 60000</span><br></pre></td></tr></table></figure><p>或者如果你的演讲精彩到忘记用鼠标，那么可以用自动播放的功能，比如30s换一页？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output:</span><br><span class="line">  xaringan::moon_reader:</span><br><span class="line">    nature:</span><br><span class="line">      autoplay: 30000</span><br></pre></td></tr></table></figure><h2 id="slides内容编辑">2.2. slides内容编辑</h2><h3 id="页面风格控制">2.2.1. 页面风格控制</h3><p>写轮眼利用remark.js采取class的方式来定义整页幻灯片的风格，需要注意的是这个是父级的，直接控制整个页面，而如果页面需要单独对每个版块进行单独控制的，最好不要直接在用全页面的class属性，比如我们经常在演讲的时候用到的衔接页面，跟其他的页面背景色可以采取不一样的，这样让观众知道我们要讲下一个part了，这时可以采取如下的页面设置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class:inverse,middle,center</span><br><span class="line"></span><br><span class="line"># 这是一个过渡页面</span><br></pre></td></tr></table></figure><p>以上展现效果是黑色背景页，白字居页面正中。</p><p>也可以使用 title-slide-section-grey过渡效果，我个人比较喜欢这种。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class: title-slide-section-grey, middle, center</span><br></pre></td></tr></table></figure><h3 id="设计节选的主标题">2.2.2. 设计节选的主标题</h3><p>演讲的时候一个slides可能分为几部分，而其中的一部分有一个主标题，比如谈"追求理解的教学设计"，那么针对这个大标题有三个小标题，这种情况在开始这一part的时候可以设定一个<code>layout:true</code>，只要没有遇到<code>layout:false</code>之前的所有页面节标标题都是跟这个设置页面一样，比如以下的某一页面设置了节标题：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">layout:true</span><br><span class="line"></span><br><span class="line"># 这是一个节标题</span><br></pre></td></tr></table></figure><h3 id="图片编辑">2.2.3. 图片编辑</h3><p>图片不建议使用 base64 内嵌，会导致加载速度很慢。参见<ahref="https://yihui.name/en/2017/08/why-xaringan-remark-js/">这里</a>，但如果量小也是可以的，使用方法如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">background-image: url(`r knitr::image_uri(&#x27;incomeHeatmap.png&#x27;)`)</span><br></pre></td></tr></table></figure><p>图片分为背景图、左右悬浮图或者页面标记（比如51talk公司logo）,不同的场景可以用不同实践方法</p><ul><li><p>对于背景图全覆盖可以采用<code>background-size: contain</code>，不设定位置；对于 logo标志可以采用如下 code；这种设定适合长宽一样的情况下设定</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">background-image: url(&#x27;figure/51talklogo.png&#x27;)</span><br><span class="line">background-size: 100px</span><br><span class="line">background-position: 90% 5%</span><br></pre></td></tr></table></figure></li><li><p>对于左右悬浮图可以采用自定义的 CSS,定义图片宽和高占页面大小的百分比以及悬浮方式在左边还是右边</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 在zh-CN.css中添加如下自定义css</span><br><span class="line">.img-right&#123;</span><br><span class="line">  width: 50%;</span><br><span class="line">  height: 50%;</span><br><span class="line">  float: right;</span><br><span class="line">&#125;</span><br><span class="line">#在Rmd中使用</span><br><span class="line">.img-right[![](figure/example.jpg)]</span><br></pre></td></tr></table></figure></li><li><p>对于一些特殊的比例控制也可以采用自定义的 css，我一般放在extra.css 中做特殊设定，比如宽度 90%，高度 50% 的图片：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># css start</span><br><span class="line">.image-9050 img &#123;</span><br><span class="line">height: 50%;</span><br><span class="line">width: 90%;</span><br><span class="line">&#125;</span><br><span class="line">## css end</span><br><span class="line">.image-9050[![](figure-html/jiandan.gif)]   # 自定义大小,在css中定义`.image-9050`</span><br></pre></td></tr></table></figure></li></ul><h3 id="公式编辑">2.2.4. 公式编辑</h3><ul><li><p>公式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$$x=1$$</span><br></pre></td></tr></table></figure></li></ul><h2 id="页面辅助功能">2.3. 页面辅助功能</h2><ul><li><p>添加脚注：比如有的参考文献或者相关补充提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Rmd中添加上在相应的位置加上&lt;sup&gt;*&lt;/sup&gt;</span><br><span class="line"></span><br><span class="line">.footnote[[*] 这是一个脚注]</span><br></pre></td></tr></table></figure></li><li><p>添加备注：每一页像 ppt 一样增加演讲的备注，???以下的代表备注，图片也可以加</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">???</span><br><span class="line">this is a test note</span><br></pre></td></tr></table></figure></li><li><p>自增式 slides 演示：通过鼠标点击出现下一个内容,类似 ppt的滑动效果，采用<code>--</code>来控制效果，注意标识符后空一行否则滑动未生效；区分三横杠<code>---</code>、二横杠<code>--</code>和<code>-</code>，分别代表幻灯片分割，自增和列表的语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line"></span><br><span class="line">上面是一个空行</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;本片文章直接拷贝于部门wiki，作者还有renwanfeng、duyalei&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;写轮眼是谢益辉开发的，利用 markdown 语法完成的 slides 的&lt;a
href=&quot;https://github.com/yihui/xaringan&quot;&gt;工具&lt;/a&gt;，
排版非常考究，书写速度极快。非常适合工程师序列的工作人员。&lt;/p&gt;
&lt;p&gt;不过因为 GFW 的存在，sharingan 调用的 js 和 font 不能加载，会导致
slides 不能被顺利渲染。
这里提供一些常用参数设置，通过本地编译，sharingan 能够提供
self-contained 文件，不依赖于网络环境。&lt;/p&gt;</summary>
    
    
    
    
    <category term="sharingan" scheme="http://bjt.name/tags/sharingan/"/>
    
    <category term="slides" scheme="http://bjt.name/tags/slides/"/>
    
  </entry>
  
  <entry>
    <title>厦门大学统计系的访谈</title>
    <link href="http://bjt.name/2017/07/02/interview-xiamen.html"/>
    <id>http://bjt.name/2017/07/02/interview-xiamen.html</id>
    <published>2017-07-01T16:00:00.000Z</published>
    <updated>2024-01-08T16:20:11.292Z</updated>
    
    <content type="html"><![CDATA[<p>六月的最后一周，在厦门大学统计系做了一份小学期课程的分享。午餐期间，胡帆同学整理并提问了一些问题。感谢WiseRClub 的文字整理。</p><h1 id="以下为谈话内容">以下为谈话内容</h1><p>胡帆：</p><p>您是正儿八经的统计学专业出身，但是现在统计学出身的人大部分都在做机器学习，请问您认为统计学和机器学习的联系和区别是什么？</p><p>刘思喆：</p><p>　　其实没有什么大的区别，简单的说：计算机系和统计系各自重新把数据科学发明了一遍。计算机的人做很多东西，跟统计系做的很多东西其实都是一样的，只是在概念上不一样。经常地，统计系的学生和计算机系的学生在聊天的时候发现，我们说的是一个东西吗？后来发现，就是一个东西！　　举个例子：统计系的学生在讲到回归的一些变种的时候会讲到Lasso，而计算机系的学生是从来不会讲Lasso这个概念的，他们叫L1正则；而计算机系学生所说的L2正则，就是统计学中的Ridgeregression（岭回归）。其实他们的本质都是在解决数据科学中的一些问题，计算机的人走自己的一条路，而统计的人走的是另一个方向，但实际上我们所解决的问题都是一样的，这个现象最近几年愈演愈烈。大量统计压箱底的好物件，被计算机背景的人不停的翻出。事实上每个系或者每个专业背景的人其实都有自己的优势，我觉得最终会殊途同归。　　所以，我们经常说一句话：“一个好的程序员必须是半个好的分析师，一个好的分析师必须半个好的程序员”。这句话虽然粗糙，但我觉得比较好的描述这样一个观点：统计系的学生或者有统计专业背景的人，应该擅长自己统计那块，但是编程这块也要至少能及格；而计算机那边的人呢，如果只做软件工程，那是不够的，他要能够掌握基本的统计思想。</p><span id="more"></span><p>胡帆：</p><p>　　您翻译过很多R的著作，也写了《153分钟学会R》这种脍炙人口的书，您本身也是一名R极客。但是现在Python也在数据科学领域大放异彩，像Google、Instagram都用的是Python，很多人现在都在押宝，R和Python，究竟哪个将来会在数据科学领域拔得头筹，对此，您有什么看法？</p><p>刘思喆：</p><p>　　说个小插曲：几年前我在外面给大家讲课的时候，主办方特别希望让我和一位教SPSS的老师一个讲上午一个人讲下午，两人同台PK一下；而这次就变成：问我能不能上午讲R，然后肖凯老师下午讲Python，两人同台PK一下（注：采访过程中，肖凯老师也在现场，对肖凯老师也感兴趣的同学们可以关注我们后续将推出的另一篇关于肖凯老师的采访哦！）。　　R的演化大概是在十年前吧，当时R的主要对标是软件SAS，它是更接近统计分析，或离线分析这样的一种软件。在统计之都论坛上大家经常拿R和SPSS和SAS进行PK。后来，大概在07、08年的时候，我们突然发现SAS和SPSS已经无法跟R抗衡了，已经不是一个量级的了。当然传统的一些行业，如制药、金融、风控等还是有在用SAS的，但是（此处省略342字）</p><p>胡帆：</p><p>　　感觉它们现在已经有点跟不上时代了</p><p>刘思喆：</p><p>　　对。我们再返回Python和R的问题，Python和R其实有点像，他们都不是纯底层语言，都能跟其他语言做交互，比如我们常把Python称之为胶水语言。在数据科学工具的使用度上，大家可以去看一些相关的排行榜：2005年前后是SPSS和SAS占主要地位。然后是R，R大概雄霸了5、6年的样子，今年的话，明确的看到Python已经上来了，而且Python比R还略占优势。　　但并不是说，R和Python这两个工具是纯竞争或替代关系，它们之间其实还有互补的地方。比如说：R在做EDA（探索性数据分析）比较有优势，EDA有一个理念：每个分析的中间的结果，是可以作为下一个分析的前置条件的。R是典型的copy-on-modify机制，赋值一个新的变量R会拷贝一份内存，而Python则在内存中做指向。R慢主要是因为这个，但在数据分析这块，这种机制能保证它不会出错。从这种意义来讲，R保证了数据分析的严谨性，但是它牺牲了性能。所以这两个工具其实是应用场景不太一样。</p><p>胡帆：</p><p>　　那么，在企业中做大数量级运算的时候，R是不是就处于劣势了？</p><p>刘思喆：</p><p>这个话题有点大，从几个方面讲吧：R(S)从发明之初就不是为了纯编程，它近乎完美地平衡了数据分析和编程开发之间的关系。只要有数据分析和编程开发同时出现的情况（ProgrammingwithData）就有R应用的必要。另外，我们常常被一个误区所迷惑，认为所有企业的数据量都非常大，其实不是的。99.9%企业里以上的数据问题，单机版的R就能搞定，盲目跟风上集群投入产出比太低。最后拿我的团队来说，我不会特意去要求组员非要用R或非要用Python，这是没有意义的，因为工具就是工具，具体用什么其实无所谓。为什么现在Python在工业界里面用的更多，主要原因是，很多计算机的人，在用Python或在类似工具在做一些线上的工程，这块的话Python比较方便，非常顺利地成为大家首选的工具。而R本身就是在统计的圈子，包括数据科学，统计系的学生用的偏多一点，所以看起来在工程这块，就没有那么多R的使用了。</p><p>胡帆：</p><p>　　请问您觉得要成为一个数据科学家，需要掌握哪些必备的技能？包括各种软技能、硬技能。</p><p>刘思喆：</p><p>　　先说硬技能吧：所有的算法都要自己实现，不需要用最底层的语言实现，你可以用Python、用R去写，但是你要把它给实现出来，你必须要知道一些细节，这是纯的硬技能。以及你分析技能的方法论，其实它是有套路的，就是你怎么去做这个东西，比如：你是自上往下做分解，还是从一个切面去分析相关和因果，这个是有一些套路的。软技能的话，因为我们做数据科学不是一个简单地单兵作战的一项工作，而是你要和很多人协作的一个过程，这就会涉及到你怎么跟其他人合作以及怎么去影响你真正去落地的关键人物，你怎么样去兜售自己的idea，这都是比较重要的。</p><p>胡帆：</p><p>　　因此，这些软技能也就是指团队合作能力，沟通能力，和表达能力，是吗？</p><p>刘思喆：</p><p>　　对。</p><p>胡帆：</p><p>　　我们可以把数据挖掘、机器学习的理论方法，看做“道”，把R、Python、Spark、Hadoop等工具看成“术”，现在这些工具特别多，有很多人会陷入痴迷工具的误区，过度追求工具的使用。您在求学时，是如何在忙碌的学习生活之余，把“道”和“术”融会贯通的？</p><p>刘思喆：</p><p>　　大概七八年前，我也同样特别痴迷所有的算法，直到见到了一位敬仰的人大师兄。我在饭桌上感慨道：“每天都会去看大量的算法，感觉很神奇很有趣，特开心！”然后他反问了我一句话：“思喆，你即便是把这些东西都穷尽了，你又能做什么？”当时我被问得无话可说，愣了半分钟。生命是有限的，如果只是学但并没有产出，是没有意义的。所以当时学长醍醐灌顶，一语惊醒梦中人。看那些算法确实会觉得很爽，会感叹算法的神奇，你会觉得自己在用上帝视角看整个世界，这样是很快乐，但你会发现如果没有目的性，不用这些算法具体做些什么，其实是然并卵的。所以玩归玩，做事情还是要认真思考落地性的。(帆帆总结：需要有业务知识来驱动)</p><p>胡帆：</p><p>　　但是业务知识在我们平时的学习生活中是碰不到的，我们该怎么获取相关的知识呢？</p><p>刘思喆：</p><p>　　多认识人，多去看、多去想。多认识人就不必多说重要性了。举个多思考的例子：我是哔哩哔哩的重度用户，在逛B站的过程中就会去想，这个系统的设计，模块的关系，以及对应算法怎么去做的；还有网易云音乐，它每个环节的设计，比如用户的评论环节，它能收集到什么样的数据，它的算法能怎么做，数据收集的机制有没有可能做一些改变？</p><p>胡帆：</p><p>　　但这些有时候不是一下能想通的</p><p>刘思喆：</p><p>　　我认为这是心智的一种锻炼，一开始可能会比较吃力，但你要持续去锻炼这个能力，你要不停去抽象。碰到的问题能不能把它抽象成一个数据问题、数学模型和建模问题。这个能力需要经常去锻炼。早年我觉得哪些数据可能有点用，就会写爬虫去网上爬，爬下来之后就开始折腾自己的一些想法，这个爱好对我后面的工作帮助很大。总结下：你要知道怎样去收集数据，收集数据之后，怎么用这个数据做出一些结论性的内容。学生期间不用特意去追求做所谓的有价值的东西，有兴趣好玩，追随自己内心就可以了。</p><p>胡帆：</p><p>　　那您当初肯定是用R爬虫吧</p><p>刘思喆：</p><p>　　对，我用R写的。当时还没有这些爬虫的包，我是用base写的</p><p>胡帆：</p><p>　　能自己写这些代码，您对知识肯定理解得特别透彻！</p><p>刘思喆：</p><p>　　如果明白原理的话，其实没有那么复杂。比如一些 ensemble的一些方法，甚至像boosting的一些方法还有像爬虫等等，没几行代码就可以搞定。举个例子：在谢益辉没有写knitr之前，R的自动化报告都是用Sweave来做的，巨难用。有一次刚好业务上绕不过去，于是我就把Sweave改了一遍，以适应当时的业务场景。所以理解你面临的问题，以及问题的本质是什么很重要。如果刚好自己有很喜欢就更好了，可以做到极致。</p><p>胡帆：</p><p>　　这要花很长时间去看源代码吧？</p><p>刘思喆：</p><p>　　这是一个很好的途径，但其实，我觉得有一个思维上的考虑：你要想明白你的问题是什么。你要能把你的问题抽象清楚，其实不需要看这些源代码。因为人类社会其实还是有章可循的，它为什么那样做，其实你大概也能猜测到。它并不是凭空创造的东西。学习还是很容易的东西，学习比处理人际关系要简单太多了（笑）</p><p>胡帆：</p><p>　　您曾经在京东任职，请问您能给我们当中想进入京东做数据挖掘的同学，提供一些职业技能方面的建议吗？</p><p>刘思喆：</p><p>　　所有的算法都要会，能落地的工具语言也都要会，比如R、Python、Spark等都要用得很熟。京东是规模化用R比较早期的企业，所以你看，现在京东在职位招聘上还是会有这方面的要求，但还是那个问题，工具只是工具，你用Python，用R，只要能做出事情来就行，工具其实是次要的。</p><h1 id="关于r和python的安全机制">关于R和Python的安全机制</h1><p>对于Python：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = x</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x</span><br><span class="line">[<span class="number">100</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">[<span class="number">100</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>但在R中：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> x <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> y <span class="operator">=</span> x</span><br><span class="line"><span class="operator">&gt;</span> x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="number">100</span></span><br><span class="line"><span class="operator">&gt;</span> x</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">100</span>   <span class="number">2</span>   <span class="number">3</span>   <span class="number">4</span></span><br><span class="line"><span class="operator">&gt;</span> y</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br></pre></td></tr></table></figure><blockquote><p>从效率上看Python显然更有优势，但从数据分析角度，这个特点会带来灾难</p></blockquote><p>因此怎么发挥各自的优劣势，各位看官就仁者见仁智者见智了，这里不再做展开。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;六月的最后一周，在厦门大学统计系做了一份小学期课程的分享。午餐期间，胡帆同学整理并提问了一些问题。感谢
WiseRClub 的文字整理。&lt;/p&gt;
&lt;h1 id=&quot;以下为谈话内容&quot;&gt;以下为谈话内容&lt;/h1&gt;
&lt;p&gt;胡帆：&lt;/p&gt;
&lt;p&gt;您是正儿八经的统计学专业出身，但是现在统计学出身的人大部分都在做机器学习，请问您认为统计学和机器学习的联系和区别是什么？&lt;/p&gt;
&lt;p&gt;刘思喆：&lt;/p&gt;
&lt;p&gt;　　其实没有什么大的区别，简单的说：计算机系和统计系各自重新把数据科学发明了一遍。计算机的人做很多东西，跟统计系做的很多东西其实都是一样的，只是在概念上不一样。经常地，统计系的学生和计算机系的学生在聊天的时候发现，我们说的是一个东西吗？后来发现，就是一个东西！
　　举个例子：统计系的学生在讲到回归的一些变种的时候会讲到Lasso，而计算机系的学生是从来不会讲Lasso这个概念的，他们叫L1正则；而计算机系学生所说的L2正则，就是统计学中的Ridge
regression（岭回归）。其实他们的本质都是在解决数据科学中的一些问题，计算机的人走自己的一条路，而统计的人走的是另一个方向，但实际上我们所解决的问题都是一样的，这个现象最近几年愈演愈烈。大量统计压箱底的好物件，被计算机背景的人不停的翻出。事实上每个系或者每个专业背景的人其实都有自己的优势，我觉得最终会殊途同归。
　　所以，我们经常说一句话：“一个好的程序员必须是半个好的分析师，一个好的分析师必须半个好的程序员”。这句话虽然粗糙，但我觉得比较好的描述这样一个观点：统计系的学生或者有统计专业背景的人，应该擅长自己统计那块，但是编程这块也要至少能及格；而计算机那边的人呢，如果只做软件工程，那是不够的，他要能够掌握基本的统计思想。&lt;/p&gt;</summary>
    
    
    
    <category term="数据思维" scheme="http://bjt.name/categories/%E6%95%B0%E6%8D%AE%E6%80%9D%E7%BB%B4/"/>
    
    
  </entry>
  
</feed>
